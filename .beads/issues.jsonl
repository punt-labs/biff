{"id":"biff-0wx","title":"/mesg command — send async message","description":"Slash command: /mesg @user \"text\"\nMaps to MCP tool: mcp__biff__send_message\nArguments: to (user), message (text)\nBehavior: Send a one-way async message. Recipient reads when they choose (POP semantics).\nAlso surfaces check_messages on the receiving end.\nUnix ancestor: mesg (BSD)\nPR/FAQ: Phase 1 Must Have","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:04:08.909904-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T15:07:37.892098-08:00","closed_at":"2026-02-15T15:07:37.892098-08:00","close_reason":"Implemented in plugins/biff-commands/","dependencies":[{"issue_id":"biff-0wx","depends_on_id":"biff-eap","type":"blocks","created_at":"2026-02-15T09:04:14.323771-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-0wx","depends_on_id":"biff-9g7","type":"blocks","created_at":"2026-02-15T09:04:19.233369-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-10u","title":"Fix: fire notifications/tools/list_changed on description mutation","description":"The check_messages tool description is mutated when unread messages arrive, but notifications/tools/list_changed is never sent to Claude Code. This means Claude never re-reads the tool list and never sees the updated description.\n\nTwo paths need fixing:\n1. Belt (after tool calls): refresh_check_messages runs inside a tool handler where Context is available. Queue the notification via context._queue_tool_list_changed().\n2. Suspenders (background poll): poll_inbox runs in a background asyncio.Task outside any request context. Needs direct session access to call session.send_tool_list_changed().\n\nThe PR/FAQ (line 480) says this was validated by spike, but the current implementation silently mutates without notifying.\n\nFiles: src/biff/server/tools/_descriptions.py, possibly src/biff/server/app.py","status":"closed","priority":1,"issue_type":"bug","owner":"jmf@pobox.com","created_at":"2026-02-15T09:09:24.762251-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T09:22:41.891134-08:00","closed_at":"2026-02-15T09:22:41.891134-08:00","close_reason":"Fixed in PR #21 — notifications/tools/list_changed now fires on description mutation"}
{"id":"biff-37y","title":"Messaging tools: send_message, check_messages","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:23:07.148638-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T11:24:05.210324-08:00","closed_at":"2026-02-14T11:24:05.210324-08:00","close_reason":"Closed","dependencies":[{"issue_id":"biff-37y","depends_on_id":"biff-hks","type":"blocks","created_at":"2026-02-13T18:24:55.910212-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-37y","depends_on_id":"biff-x73","type":"blocks","created_at":"2026-02-13T18:24:58.543761-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-3pn","title":"Provisioning service: per-repo NATS credentials via GitHub identity","description":"Replace bundled shared demo credentials with per-repo NATS JWTs provisioned via GitHub identity.\n\n## Approach\n\nPiggyback on existing `gh` CLI authentication rather than building a full OAuth flow:\n\n1. `biff init` (or `biff auth`) calls `gh api user` to get GitHub token\n2. Resolves the current repo via `git remote` (e.g. `punt-labs/biff`)\n3. POST to a biff provisioning service with the token + repo identifier\n4. Service verifies token, checks the user has access to that repo\n5. Provisions a NATS user JWT scoped to that repo's subject namespace\n6. Returns credentials, stored in git config or local file\n\n## Scoping model\n\n- One NATS JWT per GitHub repo (not per user)\n- Subject permissions: `biff.{org}.{repo}.\u003e` — repos can't cross-talk\n- All team members on a repo share the same credential\n- Credential stored in `.biff` or `git config` (repo-local)\n\n## Provisioning Service\n\nLightweight — Cloudflare Worker or Lambda. Responsibilities:\n- Verify GitHub token authenticity\n- Confirm caller has access to the claimed repo (GitHub API)\n- Mint NATS user JWTs with subject permissions scoped to that repo\n- Per-repo connection and data limits\n- Revocation support\n\n## Why\n\nBundled demo creds (biff-mcp 0.1.0) are fine for onboarding but shared across ALL repos — no isolation, abuse burns everyone's connection budget. Per-repo provisioning gives each team their own namespace and limits.\n\n## Depends on\n\nDemo relay confidence (bundled creds working reliably first).","status":"open","priority":4,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-15T17:23:11.88208-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T17:23:43.714309-08:00"}
{"id":"biff-4rg","title":"Phase 1: Core MCP server","description":"Implement the foundational biff commands as an MCP server.\n\nCommands: /mesg, /who, /plan, /finger, /biff on|off\nLocal relay for same-machine communication.\nSingle-user value from /plan and session awareness.\n.biff file configuration (relay URL, whitelisted IDs).\n\nExit criteria: an engineer can install biff, set their plan, see active sessions, and send a message to a teammate on the same machine.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T15:25:20.011554-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T16:28:12.962472-08:00","closed_at":"2026-02-14T16:28:12.962472-08:00","close_reason":"All exit criteria met: presence tools, messaging, .biff config, local relay, subprocess tests. Shipped in PRs #10-15.","labels":["epic","phase"],"dependencies":[{"issue_id":"biff-4rg","depends_on_id":"biff-6k7","type":"blocks","created_at":"2026-02-13T16:39:51.110286-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-541","title":"/biff command — toggle message reception","description":"Slash command: /biff on | /biff off\nMaps to MCP tool: mcp__biff__biff\nArguments: enabled (bool)\nBehavior: Control whether you receive messages. When off, incoming messages are queued.\nUnix ancestor: biff (BSD)\nPR/FAQ: Phase 1 Must Have","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:04:09.031484-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T15:07:37.854449-08:00","closed_at":"2026-02-15T15:07:37.854449-08:00","close_reason":"Implemented in plugins/biff-commands/","dependencies":[{"issue_id":"biff-541","depends_on_id":"biff-eap","type":"blocks","created_at":"2026-02-15T09:04:14.434561-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-541","depends_on_id":"biff-9g7","type":"blocks","created_at":"2026-02-15T09:04:19.347141-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-59s","title":"Relay selection + config plumbing","description":"Add relay_url field to .biff config. Update biff serve startup to select LocalRelay vs NatsRelay based on config. When relay_url is present, connect to NATS; otherwise use filesystem relay.\n\nMay fold into NatsRelay implementation if scope is small enough.\n\nPart of Phase 2 milestone 1: local NATS on single machine.","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T16:37:31.696777-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T18:22:09.996955-08:00","closed_at":"2026-02-14T18:22:09.996955-08:00","close_reason":"Closed","dependencies":[{"issue_id":"biff-59s","depends_on_id":"biff-k0j","type":"blocks","created_at":"2026-02-14T16:38:23.692244-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-5zq","title":"/plan auto-expands beads IDs to include issue title","description":"When a user passes a beads ID to /plan (e.g. /plan biff-x73), detect the ID pattern and auto-expand it to include the issue title: 'biff-x73: MCP server scaffold with HTTP/stdio transport'. Requires the plan tool to shell out to bd show or read .beads/issues.jsonl to resolve the title. Falls back gracefully to the raw string if the ID doesn't match a known issue.","status":"open","priority":3,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-14T08:03:27.188798-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T08:03:34.029865-08:00"}
{"id":"biff-623","title":"Set up GitHub Actions CI","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T13:57:17.714558-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T13:59:43.539965-08:00","closed_at":"2026-02-15T13:59:43.539965-08:00","close_reason":"CI already configured and running: lint.yml, test.yml, hosted-nats.yml all active and green"}
{"id":"biff-6k7","title":"Spike: MCP notification rendering and subprocess handoff","description":"Validate two critical feasibility questions before committing to the full Phase 1 implementation.\n\n**Question 1: MCP notifications for receiving messages**\nCan an MCP server push a notification to Claude Code that renders visibly in the terminal? Test:\n- Create a minimal MCP server that fires a notification after a delay\n- Verify it appears in the Claude Code session without a tool call\n- Assess rendering quality (plain text? formatted? inline with conversation?)\n\n**Question 2: Subprocess handoff for /talk**\nCan an MCP server spawn an interactive subprocess that takes over terminal I/O, then return control to Claude Code cleanly? Test:\n- MCP tool call spawns a simple interactive process (e.g., a chat loop)\n- User types directly to the subprocess (no LLM intermediation)\n- Process exits, Claude Code resumes normally\n- Assess the UX transition (seamless or jarring?)\n\n**Exit criteria:**\n- Clear yes/no on both questions with evidence\n- If notifications work: document the API and rendering constraints\n- If subprocess handoff works: document the mechanism and UX quality\n- If either fails: document alternatives and revised approach for /mesg and /talk\n\n**Timeframe:** 1-2 days","notes":"Spike results (2026-02-13):\n\nQ1 (MCP notifications render?): NO - notifications/message silently dropped by Claude Code (issue #3174, closed not planned).\nQ2 (Subprocess handoff?): NO - stdio transport reserves stdout for JSON-RPC, no PTY allocation.\n\nALTERNATIVE DISCOVERED: HTTP transport + tools/list_changed\n- FastMCP HTTP transport works (Streamable HTTP + SSE)\n- Dynamic tool descriptions update via remove_tool/re-register\n- notifications/tools/list_changed automatically sent on SSE channel\n- Server-side validated via curl (all 5 checks pass)\n- Same pattern used by Slack MCP server in production\n- Claude Code end-to-end test pending (needs new session)\n\nRECOMMENDATION: Proceed with HTTP transport architecture for Phase 1.\nArchitecture documented in docs/prd/biff-phase1-communication.md and docs/sparc/phase1-implementation.md","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T16:39:47.189963-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-13T18:44:55.620389-08:00","closed_at":"2026-02-13T18:44:55.620389-08:00","close_reason":"Server-side validation complete. All 5 checks pass. HTTP transport + tools/list_changed is viable. Architecture recommendation: proceed with HTTP transport. Claude Code e2e test deferred to new session.","labels":["phase-1","spike"]}
{"id":"biff-6re","title":"GitHub identity + auth","description":"GitHub OAuth token auth to relay. Relay verifies team membership by reading .biff from repo. Public key directory managed by relay. Commit access is the trust boundary — GitHub username is identity.\n\nFuture scope — depends on encryption layer being in place.","status":"open","priority":3,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-14T16:37:41.595963-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T16:37:41.595963-08:00","dependencies":[{"issue_id":"biff-6re","depends_on_id":"biff-lff","type":"blocks","created_at":"2026-02-14T16:38:31.98322-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-7lc","title":"/check command — check inbox for messages","description":"Slash command: /check\nMaps to MCP tool: mcp__biff__check_messages\nArguments: none\nBehavior: Check and consume pending messages (POP semantics).\nNaming: /check is shorter and more natural than /check_messages as a slash command.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:03:37.263469-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T09:04:00.382548-08:00","closed_at":"2026-02-15T09:04:00.382548-08:00","close_reason":"check_messages is not a PR/FAQ command — message consumption is part of /mesg flow"}
{"id":"biff-860","title":"Remote NATS connection","description":"TLS connection support for remote NATS servers. Authentication via token, nkey, or creds file. Reconnect/retry handling for network interruptions. Configuration in .biff for remote NATS endpoint (Synadia Cloud or self-hosted).\n\nPart of Phase 2 milestone 2: hosted nats.io across machines.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T16:37:35.846801-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T07:05:32.529042-08:00","closed_at":"2026-02-15T07:05:32.529042-08:00","close_reason":"PR #19 merged — remote NATS connection with auth and reconnect","dependencies":[{"issue_id":"biff-860","depends_on_id":"biff-pdl","type":"blocks","created_at":"2026-02-14T16:38:27.707961-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-8t3","title":"Phase 3: Real-time conversation, pairing, and security","description":"Add synchronous communication and the session-sharing feature.\n\nCommands: /talk, /pair\n/talk: real-time bidirectional text conversation between two terminals (model-mediated message exchange, not subprocess handoff).\n/pair: invite a teammate to send input to your Claude Code session with explicit consent model.\nSecurity audit of the encryption model (introduced in Phase 2) and the /pair permission model.\n\nExit criteria: two engineers can hold a real-time conversation and pair on a Claude session with proper consent. Security audit confirms encryption and permission models are sound.","status":"open","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T15:25:32.868851-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T13:24:24.308784-08:00","labels":["epic","phase"],"dependencies":[{"issue_id":"biff-8t3","depends_on_id":"biff-iok","type":"blocks","created_at":"2026-02-13T16:23:56.138756-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-8xu","title":".biff config file parser","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:22:57.816895-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T14:43:31.832376-08:00","closed_at":"2026-02-14T14:43:31.832376-08:00","close_reason":"PR #15: .biff TOML config with team roster, relay URL, git identity, data dir","dependencies":[{"issue_id":"biff-8xu","depends_on_id":"biff-jge","type":"blocks","created_at":"2026-02-13T18:24:45.991178-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-9g7","title":"Epic: Claude Code plugin for biff slash commands","description":"Create a Claude Code plugin that exposes all biff MCP tools as slash commands matching the UNIX communication vocabulary. Users should be able to type /who, /plan, /finger, /mesg, /wall etc. instead of asking Claude to call tools.\n\nThe plugin wraps the existing biff MCP server tools — no new backend logic needed. Each slash command maps 1:1 to an MCP tool call.\n\nAcceptance criteria:\n- Plugin scaffold (plugin.json, directory structure)\n- All implemented tools exposed as slash commands\n- Commands work in any Claude Code instance with biff MCP server configured\n- Commands match the UNIX vocabulary from CLAUDE.md","status":"closed","priority":1,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-15T09:02:58.209327-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T15:07:33.109753-08:00","closed_at":"2026-02-15T15:07:33.109753-08:00","close_reason":"All Phase 1 commands implemented in plugins/biff-commands/"}
{"id":"biff-9n9","title":"Dual-mode MCP/CLI: expose all biff commands as CLI subcommands","description":"## Summary\n\nEvery biff operation should be usable from the terminal as `biff \u003ccommand\u003e`, not just via MCP tools inside Claude Code. This matches the quarry (../ocr) pattern where the same binary is both CLI and MCP server.\n\n## Current State\n\n- `biff serve` — starts MCP server (exists)\n- `biff init` — initializes .biff config (exists)\n- `biff version` / `biff statusline` — utility commands (exist)\n- Communication commands (`write`, `read`, `who`, `finger`, `plan`, `mesg`) — **MCP-only**, no CLI equivalents\n\n## Target State\n\nAdd CLI subcommands mirroring every MCP tool:\n\n| CLI Command | MCP Tool | Core Function |\n|-------------|----------|---------------|\n| `biff write @user \"msg\"` | `mcp__biff__write` | `relay.deliver()` |\n| `biff read` | `mcp__biff__read_messages` | `relay.fetch()` + `relay.mark_read()` |\n| `biff who` | `mcp__biff__who` | `relay.get_sessions()` |\n| `biff finger @user` | `mcp__biff__finger` | `relay.get_sessions()` filtered |\n| `biff plan \"msg\"` | `mcp__biff__plan` | `relay.update_session()` |\n| `biff mesg on/off` | `mcp__biff__mesg` | `relay.update_session()` |\n\n## Architecture\n\nFollow quarry's pattern:\n\n1. **Shared core stays in relay/models/config** — no duplication\n2. **MCP tools** (`server/tools/*.py`) remain thin wrappers calling relay\n3. **CLI commands** (`__main__.py` or `cli/` submodule) are equally thin wrappers calling the same relay methods\n4. **Boundary differences**:\n   - CLI: `print()` output, `sys.exit(1)` on error, `asyncio.run()` for async\n   - MCP: return strings, errors as strings (session continues)\n5. **Formatting shared** — `_format_table()` etc. used by both modes\n\n## Key Decisions\n\n- CLI commands need a relay connection. The `biff serve` command starts a persistent server; CLI commands need ephemeral connections. This means each CLI command will: load config → connect relay → execute → disconnect.\n- Output formatting is already server-side (columnar tables with padding). CLI can reuse directly.\n- The `update_current_session()` call in MCP tools touches session heartbeat — CLI commands may want a lighter touch (connect, act, disconnect without claiming a session slot).\n\n## Acceptance Criteria\n\n- [ ] `biff write @user \"message\"` sends a message\n- [ ] `biff read` shows unread messages (same columnar format)\n- [ ] `biff who` lists active sessions\n- [ ] `biff finger @user` shows user status\n- [ ] `biff plan \"working on X\"` sets plan\n- [ ] `biff mesg on` / `biff mesg off` toggles availability\n- [ ] All commands work without a running MCP server\n- [ ] Error handling: connection failures print to stderr, exit 1\n- [ ] Tests: unit tests for CLI commands (tier 1-2)","status":"open","priority":2,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-15T23:43:17.17362-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T23:43:17.17362-08:00"}
{"id":"biff-9xj","title":"Message watcher + dynamic tool descriptions","status":"closed","priority":0,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:23:10.132345-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T12:29:53.576834-08:00","closed_at":"2026-02-14T12:29:53.576834-08:00","close_reason":"PR #13 merged. Dynamic check_messages descriptions implemented with refresh on every tool call.","dependencies":[{"issue_id":"biff-9xj","depends_on_id":"biff-x73","type":"blocks","created_at":"2026-02-13T18:25:01.266105-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-9xj","depends_on_id":"biff-37y","type":"blocks","created_at":"2026-02-13T18:25:03.821906-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-a68","title":"Reduce visual noise in /help command listing","description":"The /help output for biff-commands is visually noisy. Every line repeats 'biff-commands' twice — once in the command path (/biff-commands:who) and once as the plugin prefix ((biff-commands)). Changes needed:\n\n1. Rename plugin from 'biff-commands' to 'biff' — commands become /biff:who, /biff:finger, etc.\n2. Replace /biff:biff on|off with two commands: /biff:on and /biff:off. The /biff:biff form is awkward after the rename.\n\nAffected files:\n- plugins/biff-commands/.claude-plugin/plugin.json (rename)\n- plugins/biff-commands/commands/biff.md → split into on.md and off.md\n- Plugin directory name itself (biff-commands → biff)\n- Symlink and marketplace registration may need updating","status":"closed","priority":3,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T15:32:52.176502-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T17:24:06.822781-08:00","closed_at":"2026-02-15T17:24:06.822781-08:00","close_reason":"PR #30 merged. Plugin renamed biff-commands→biff, standalone short-form commands, conflict detection in installer, bundled demo NATS credentials."}
{"id":"biff-a7p","title":"finger should show plan even when user has no active session","description":"finger should show plan even when user has no recent tool calls. In UNIX, finger read the .plan file from disk regardless of login state.\n\n## Root Cause\n\nUserSession bundles ephemeral presence (last_active) with persistent data (plan) in a single storage object with aggressive TTLs:\n- NATS KV: 300s TTL — session disappears after 5 minutes\n- /who: 120s application TTL — user drops from presence list after 2 minutes\n\nNeither /who nor /finger refresh last_active (read-only), and there is no background heartbeat.\n\n## Revised Design: Long-Lived Sessions + IDLE Display\n\nDesign principle: **Sessions persist for 30 days. \"Active\" is replaced by IDLE time.**\n\n### 1. NATS KV TTL — nats_relay.py:52\n\n_KV_TTL = 300 → _KV_TTL = 2_592_000 (30 days). Sessions survive for 30 days, naturally expiring via NATS KV TTL. No separate plan store needed.\n\n### 2. Rename get_active_sessions → get_sessions — relay.py, nats_relay.py\n\nRemove the ttl parameter. Return all sessions the relay has. NATS KV handles 30-day expiry; LocalRelay adds a 30-day cutoff on read.\n\n### 3. /who shows IDLE column — who.py\n\nInstead of filtering by 120s TTL, show ALL sessions with computed idle time:\n  @kai          2m   +  fixing auth\n  @eric        3h   +  reviewing PR #42\n  @priya       2d   -  on vacation\n\nSort by user. Idle computed from last_active.\n\n### 4. /finger handles idle state — finger.py\n\nSession always available (within 30 days). Show idle/offline indicator instead of \"Never logged in\" for known users with stale sessions.\n\n### 5. Shell hook — suppress-output.sh\n\nUpdate table format to include IDLE column.\n\n### Files Touched\n\n| File | Change |\n|------|--------|\n| src/biff/nats_relay.py | _KV_TTL 300 → 2_592_000, rename method |\n| src/biff/relay.py | Rename get_active_sessions → get_sessions, 30-day cutoff in LocalRelay |\n| src/biff/server/tools/who.py | Remove TTL filter, add idle computation, new format |\n| src/biff/server/tools/finger.py | Handle idle state display |\n| plugins/biff/hooks/suppress-output.sh | IDLE column in table |\n| tests/ | Update all who/finger tests |\n\n~40-60 lines changed across 6 files.","status":"closed","priority":2,"issue_type":"bug","owner":"jmf@pobox.com","created_at":"2026-02-15T15:34:52.132597-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T20:15:20.299184-08:00","closed_at":"2026-02-15T20:15:20.299184-08:00","close_reason":"Long-lived sessions (30d TTL) with idle time display. Implemented in fe4ed1c on fix/who-output branch."}
{"id":"biff-adp","title":"Hosted NATS E2E tests","description":"Tests against a real Synadia Cloud / nats.io hosted account. Verifies cross-machine messaging, presence, and session management work identically to local NATS tests.\n\nThis is the milestone 2 gate: hosted account, across machines.\n\nPart of Phase 2 milestone 2: hosted nats.io across machines.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T16:37:37.444-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T08:42:47.586303-08:00","closed_at":"2026-02-15T08:42:47.586303-08:00","close_reason":"Hosted NATS E2E tests merged in PR #20","dependencies":[{"issue_id":"biff-adp","depends_on_id":"biff-860","type":"blocks","created_at":"2026-02-14T16:38:29.015085-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-al5","title":"Multi-process transport tests: two biff serve subprocesses over stdio","description":"Spawn two real biff serve processes (--user kai, --user eric, same --data-dir) connected over stdio. Exercise MCP wire protocol through actual pipes, not FastMCPTransport. Catches serialization bugs, process lifecycle issues, stdio framing. Use subprocess + MCP client library to connect. Generates transcripts like E2E tests but with real transport.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T08:17:35.89207-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T09:00:53.43409-08:00","closed_at":"2026-02-14T09:00:53.43409-08:00","close_reason":"Subprocess tests shipped in PR #9: 15 tests over StdioTransport, cross-process state verified"}
{"id":"biff-b01","title":"Integration tests + quality gates","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:23:18.145377-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T16:28:57.177779-08:00","closed_at":"2026-02-14T16:28:57.177779-08:00","close_reason":"199 tests pass across 4 tiers (unit, integration, subprocess, SDK). Quality gates (ruff, mypy, pyright) all green. All dependent feature beads shipped with tests.","dependencies":[{"issue_id":"biff-b01","depends_on_id":"biff-ofy","type":"blocks","created_at":"2026-02-13T18:25:11.749375-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-b01","depends_on_id":"biff-37y","type":"blocks","created_at":"2026-02-13T18:25:14.358111-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-b01","depends_on_id":"biff-9xj","type":"blocks","created_at":"2026-02-13T18:25:17.058179-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-bgh","title":"/finger command — check user status","description":"Slash command: /finger @user\nMaps to MCP tool: mcp__biff__finger\nArguments: user (required) — username to query\nBehavior: Shows detailed status for a specific user.\nUnix ancestor: finger","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:03:37.031204-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T15:07:37.929336-08:00","closed_at":"2026-02-15T15:07:37.929336-08:00","close_reason":"Implemented in plugins/biff-commands/","dependencies":[{"issue_id":"biff-bgh","depends_on_id":"biff-eap","type":"blocks","created_at":"2026-02-15T09:04:14.211769-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-bgh","depends_on_id":"biff-9g7","type":"blocks","created_at":"2026-02-15T09:04:19.121194-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-bv5","title":"Phase 4: Hosted relay service (biff teams)","description":"Launch the managed biff teams offering on top of the Supabase relay (Phase 2).\n\nSince the relay IS a Supabase project, the \"hosted\" story is largely solved by Phase 2. Phase 4 adds the operational and commercial layer:\n\n- Default hosted Supabase project managed by biff (the free/public relay)\n- Team isolation via Supabase RLS policies and per-team channels\n- Audit logs via Postgres queries on the messages table\n- Admin controls: team membership, permissions, onboarding/offboarding\n- End-to-end encryption (client-side, keys managed outside Supabase)\n- Compliance exports (message history, audit trails)\n- Billing integration if needed (usage-based on message volume)\n- 99.9% uptime — inherited from Supabase Pro plan\n\nSelf-hosted teams skip this entirely — they manage their own Supabase project.\n\nExit criteria: a team can sign up for biff teams, get a managed relay with admin controls, audit logging, and encryption.","status":"open","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T15:25:39.154258-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T12:23:13.194254-08:00","labels":["epic","phase"],"dependencies":[{"issue_id":"biff-bv5","depends_on_id":"biff-8t3","type":"blocks","created_at":"2026-02-13T16:23:56.228225-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-czx","title":"Spike: validate tools/list_changed in Claude Code","notes":"Server-side validation complete (5/5 checks pass). Remaining: Claude Code e2e test — does Claude Code act on notifications/tools/list_changed and show updated tool descriptions? Requires session restart with biff-spike registered in .mcp.json.","status":"closed","priority":0,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:23:13.074042-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-13T18:57:29.643458-08:00","closed_at":"2026-02-13T18:57:29.643458-08:00","close_reason":"E2E validated: Claude Code acts on tools/list_changed. Dynamic tool descriptions update in real-time. Full chain confirmed: simulate_message → remove/re-register tool → list_changed notification on SSE → Claude Code refreshes → updated description visible to Claude."}
{"id":"biff-eap","title":"Scaffold biff Claude Code plugin","description":"Create the plugin directory structure and plugin.json manifest.\n\nStructure:\n  plugins/biff-commands/\n    plugin.json         — manifest with name, version, description, commands list\n    commands/           — slash command definitions\n    skills/             — skill definitions (if needed)\n\nThe plugin must reference the biff MCP server tools. Each command will be a skill file that instructs Claude to call the corresponding biff MCP tool.\n\nAcceptance criteria:\n- plugin.json validates correctly\n- Plugin can be loaded by Claude Code (local install or symlink)\n- Directory structure follows Claude Code plugin conventions","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:03:05.968828-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T15:07:37.667897-08:00","closed_at":"2026-02-15T15:07:37.667897-08:00","close_reason":"Scaffold complete — plugin.json + 6 command files","dependencies":[{"issue_id":"biff-eap","depends_on_id":"biff-9g7","type":"blocks","created_at":"2026-02-15T09:04:18.783178-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-ep3","title":"/wall command — team broadcast","description":"Slash command: /wall \"text\"\nMaps to MCP tool: TBD (not yet implemented as MCP tool)\nBehavior: Broadcast a message to your team or hive.\nUnix ancestor: wall (BSD)\nPR/FAQ: Phase 2 Should Have\nNote: MCP tool backend needs to be built first — this task is plugin-side only, blocked until backend exists.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:04:09.149656-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T15:07:57.019954-08:00","closed_at":"2026-02-15T15:07:57.019954-08:00","close_reason":"Superseded by biff-o1j which covers both the MCP tool and plugin command","dependencies":[{"issue_id":"biff-ep3","depends_on_id":"biff-eap","type":"blocks","created_at":"2026-02-15T09:04:14.545303-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-ep3","depends_on_id":"biff-9g7","type":"blocks","created_at":"2026-02-15T09:04:19.464517-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-faz","title":"Align command vocabulary with Unix semantics","description":"Current biff commands mismap Unix ancestors. Fix the vocabulary:\n\n## Problem\n- `/mesg @user msg` sends messages — but Unix `mesg(1)` only controls reception\n- `biff on/off` tool controls reception — but Unix `biff(1)` is mail notification\n- `send_message` MCP tool name doesn't match any Unix command\n\n## Correct Mapping\n| Slash Command | MCP Tool | Unix Ancestor | Purpose |\n|---|---|---|---|\n| `/write @user msg` | `write` | `write(1)` | Send a message |\n| `/mesg y` / `/mesg n` | `mesg` | `mesg(1)` | Control message reception |\n| (product name) | — | `biff(1)` | New mail notification (status line) |\n| `/finger` | `finger` | `finger(1)` | Already correct |\n| `/who` | `who` | `who(1)` | Already correct |\n| `/plan` | `plan` | `.plan` | Already correct |\n| `/check` | `check_messages` | `from(1)`/`mail(1)` | Already correct |\n\n## Changes Required\n1. Rename MCP tool `send_message` → `write`\n2. Rename MCP tool `biff` (on/off) → `mesg`\n3. Update slash command `/mesg` → `/write` for sending\n4. Update slash command for reception control to `/mesg on` or `/mesg y`\n5. Update CLAUDE.md command vocabulary table\n6. Update plugin hooks, install.sh, tests\n7. Update PR/FAQ if it references command names","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T20:44:21.908617-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T21:00:50.238054-08:00","closed_at":"2026-02-15T21:00:50.238054-08:00","close_reason":"Tool names aligned: biff→mesg, send_message→write, check_messages→read_messages. All 293 tests pass."}
{"id":"biff-gyj","title":"Install biff MCP server globally in ~/.claude/mcp.json","description":"The biff MCP server is currently configured per-project in .mcp.json. Since statusLine is global (~/.claude/settings.json), the MCP server must also be global so biff runs in every session and can update unread counts regardless of which project is open. The install-statusline command should also add the biff server entry to ~/.claude/mcp.json (and uninstall should remove it). Depends on biff-yl1 (per-project unread counts) to avoid cross-project collisions once the server runs globally.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T10:54:22.69127-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T14:38:08.724138-08:00","closed_at":"2026-02-15T14:38:08.724138-08:00","close_reason":"Completed in PRs #24-#26 (register MCP server on install/uninstall) and #27 (graceful degradation)","dependencies":[{"issue_id":"biff-gyj","depends_on_id":"biff-yl1","type":"blocks","created_at":"2026-02-15T10:54:26.355171-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-hks","title":"Storage layer: inbox.py and sessions.py","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:22:55.326517-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T05:34:52.008196-08:00","closed_at":"2026-02-14T05:34:52.008196-08:00","close_reason":"MessageStore + SessionStore with 35 tests. JSONL/JSON backed, atomic writes, malformed data recovery.","dependencies":[{"issue_id":"biff-hks","depends_on_id":"biff-jge","type":"blocks","created_at":"2026-02-13T18:24:42.996974-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-iok","title":"Phase 2: Network relay and team commands","description":"Enable cross-machine messaging and team-level commands via a hosted NATS relay.\n\nSee prfaq.tex for authoritative product vision, phasing, and scope.\n\n## Architecture\n\npunt-labs runs the default hosted relay (NATS + JetStream). Teams connect by having a .biff file in their repo with the relay URL and member usernames. No accounts to create — pip install biff-mcp + clone = connected.\n\nTeams that want data sovereignty can self-host the same single-binary NATS server.\n\n## Data Source \u0026 Durability\n\n| Command | Durability | Source | Encryption |\n|---------|-----------|--------|------------|\n| /plan | Persistent | Relay | Team key (SecretBox) |\n| /who | Ephemeral | Relay | None (presence metadata) |\n| /finger | Both | Relay | Plan: team key. Online status: none |\n| /biff on/off | Ephemeral | Relay | None (session toggle) |\n| /mesg | Store-and-forward (POP) | Relay | Recipient's public key (Box) — true E2E |\n| /wall | Ephemeral | Relay | Team key (SecretBox) |\n| /hive | Ephemeral | Relay | Ephemeral hive key (SecretBox) |\n| /send | TBD | TBD | Design pending |\n| /cr | TBD | TBD | Design pending |\n| /talk | Ephemeral | Relay | Recipient's public key (Box) |\n| /pair | Ephemeral | Relay | Recipient's public key (Box) |\n\n## POP Mail Model\n\nThe relay follows POP semantics for /mesg: messages are stored on the relay only until the recipient reads them, then discarded. Biff is not a system of record. /wall is ephemeral broadcast — miss it if you're offline.\n\nNATS JetStream consumers with ack-and-delete implement this directly.\n\n## Encryption Design\n\n### Inspiration: ProtonMail\n\nEncryption is invisible to the user. The relay manages the public key directory. Clients encrypt/decrypt locally. The relay routes ciphertext. Like ProtonMail, the server is trusted for key distribution but untrusted for message content.\n\n### Primitives (PyNaCl / libsodium)\n\n- crypto_box (Box): 1:1 messages — Curve25519 + XSalsa20-Poly1305. True E2E.\n- crypto_secretbox (SecretBox): Group messages — XSalsa20-Poly1305 with symmetric key.\n- PyNaCl v1.6.2, Python 3.13+, actively maintained. Same crypto as Signal, WireGuard, age.\n\n### Identity \u0026 Root of Trust\n\nCommit access is the trust boundary:\n1. Your GitHub username is your identity\n2. You add your username to .biff in the repo (proves commit access)\n3. Relay reads .biff from GitHub to verify team membership\n4. Auth to relay via GitHub OAuth token\n\n### Keys\n\n- User keypair (Curve25519): per-user, per-repo. Private key in ~/.biff/keys/\u003crepo-hash\u003e.key. Public key in relay's key directory. Generated silently on first connection.\n- Team key (symmetric, 32 bytes): per-repo. Generated by relay, distributed to members encrypted with their public keys.\n- Hive key (symmetric, 32 bytes): per-hive, ephemeral. Same distribution model. Destroyed when hive dissolves.\n\n### User Experience (transparent)\n\npip install biff-mcp → clone repo with .biff → first biff serve generates keypair silently → public key registered with relay → team key received encrypted with your public key → user never sees any of this.\n\n### Encryption Per Command\n\n/mesg @kai \"text\" (true E2E, relay is blind):\n  Sender: Box(my_privkey, kai_pubkey).encrypt(message) → relay stores ciphertext\n  Kai: Box(kai_privkey, sender_pubkey).decrypt(ciphertext)\n\n/wall \"text\" (team key, ephemeral broadcast):\n  Sender: SecretBox(team_key).encrypt(message) → relay broadcasts ciphertext\n  Members: decrypt with cached team key\n\n/plan \"text\" (team key, persistent on relay):\n  Client: SecretBox(team_key).encrypt(plan) → relay stores ciphertext\n  /finger: relay returns encrypted plan → requester decrypts with team key\n\n/hive (ephemeral group key):\n  Relay generates hive key → distributes via each member's public key\n  All hive messages: SecretBox(hive_key).encrypt(message)\n\n### Key Lifecycle\n\nNew member: adds username to .biff, commits. First connection → keypair generated, public key registered. Relay encrypts team key with new member's public key → sends it.\n\nMember leaves: removed from .biff. Relay removes public key, rotates team key, re-distributes to remaining members.\n\nLost key: reconnect → new keypair, re-registered. Unread POP messages lost (acceptable). Team key re-sent with new public key.\n\n### Trust Boundaries\n\nTrue E2E (relay is blind): /mesg, /talk, /pair — encrypted with recipient's public key. Relay holds ciphertext it cannot decrypt.\n\nRelay-trusted (Proton model): /wall, /plan, /hive — relay generates the symmetric key, so it could theoretically read these. Same trust model as ProtonMail.\n\nFuture enhancement: client-side team key generation for zero-knowledge relay. More complex (requires someone online to welcome new members).\n\nPlaintext metadata: from, to, repo, timestamps — relay needs this for routing.\n\n## NATS Implementation\n\n### Why NATS + JetStream\n\n- Purpose-built for messaging. JetStream provides persistence and delivery guarantees.\n- KV store for presence (/who, /finger) with TTL, watch API. ~50 LOC.\n- JetStream consumers with ack-and-delete implement POP model directly.\n- nats-py v2.13.1 (Feb 2026), 145K weekly PyPI downloads, full asyncio.\n- Self-hosting: single Go binary (\u003c20MB). nats-server -js.\n- Managed hosting: Synadia Cloud (free personal, $49/mo starter).\n- Handles 100K msg/s on single node.\n\n### Hosting Model\n\npunt-labs runs the default NATS instance. Free tier with volume limits. Teams needing higher volume or data sovereignty self-host the same binary.\n\n## Open Design Questions\n\n1. Freemium model — volume limits, what's free vs. paid\n2. GitHub integration — how relay reads .biff (webhook vs. poll vs. on-connect fetch)\n3. /send and /cr — data source, persistence, and encryption model TBD\n4. Team key rotation schedule — on membership change only, or periodic?\n5. Key pinning / transparency — how to detect relay serving wrong public keys (TOFU vs. key transparency log)\n\n## Client Architecture\n\nNew module: biff.relay with:\n- RelayClient — wraps nats-py, handles connect/disconnect/send/subscribe\n- RelayMessageStore — POP model: pull unread, ack-and-delete\n- RelaySessionStore — presence via NATS KV store\n- RelayCrypto — wraps PyNaCl, manages keypairs and team key cache\n\nDual-mode: local (filesystem) or relay, selected by relay_url in .biff file.\n\n## Exit Criteria\n\nA distributed team can communicate end-to-end through biff across machines using the default hosted relay or their own self-hosted instance, with E2E encryption for 1:1 messages and Proton-model encryption for team messages.","status":"open","priority":2,"issue_type":"epic","owner":"jmf@pobox.com","created_at":"2026-02-13T15:25:26.267422-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T16:37:24.524171-08:00","labels":["epic","phase"],"dependencies":[{"issue_id":"biff-iok","depends_on_id":"biff-4rg","type":"blocks","created_at":"2026-02-13T16:23:56.052507-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-iok","depends_on_id":"biff-pdl","type":"blocks","created_at":"2026-02-14T16:38:54.364678-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-iok","depends_on_id":"biff-adp","type":"blocks","created_at":"2026-02-14T16:38:54.475323-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-iok","depends_on_id":"biff-lff","type":"blocks","created_at":"2026-02-14T16:38:54.58745-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-iok","depends_on_id":"biff-6re","type":"blocks","created_at":"2026-02-14T16:38:54.69716-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-jfu","title":"NATS namespace scoping: isolate relay resources per repo","description":"## Problem\n\nNATS KV bucket (biff-sessions) and JetStream stream (BIFF_INBOX) use hardcoded names. If two repos share the same NATS server (e.g., the demo relay at tls://connect.ngs.global), their sessions, messages, and future wall broadcasts collide silently.\n\nLocal relay is already repo-scoped by directory path (/tmp/biff/{repo_name}/). NATS is not.\n\n## Root cause\n\nNatsRelay receives (url, auth, client_name) but zero knowledge of which repo it serves. The repo identity is available in load_config() but never flows to the relay.\n\n```\nload_config()\n  -\u003e repo_root = find_git_root()              # knows the repo\n  -\u003e compute_data_dir(repo_root, prefix)       # /tmp/biff/{repo_name}/ \u003c- scoped\n\ncreate_state(config, data_dir)\n  -\u003e LocalRelay(data_dir=data_dir)             # inherits repo scope from path\n  -\u003e NatsRelay(url=..., name=f\"biff-{user}\")   # NO repo info passed\n```\n\n## What collides today\n\n- Sessions: User sets /plan in repo-A, shows up in repo-B's /who\n- Messages: /write in repo-A delivered when recipient runs /read in repo-B\n- Future wall/tty features would also collide\n\nThe demo relay is the worst case: all demo users share one NATS account.\n\n## Design\n\n### 1. Flow repo identity to the relay\n\nAdd repo_name: str = \"_default\" to BiffConfig. Populate from sanitize_repo_name(repo_root.name) in load_config(). \"_default\" is the fallback when not in a git repo (matches local relay convention).\n\n### 2. Sanitize repo names for NATS\n\nNATS constraints: bucket names allow alphanumeric/dash/underscore only. Subject dots are level separators. Wildcards (* \u003e) are reserved.\n\n```python\ndef sanitize_repo_name(name: str) -\u003e str:\n    clean = name.replace(\".\", \"-\").replace(\" \", \"-\")\n    return \"\".join(c for c in clean if c.isalnum() or c in \"-_\") or \"_default\"\n```\n\n### 3. Namespace all NATS resources\n\nNatsRelay.__init__ accepts repo_name, uses it everywhere:\n\n- KV bucket: biff-{repo}-sessions (was: biff-sessions)\n- Stream: BIFF_{repo}_INBOX (was: BIFF_INBOX)\n- Subject prefix: biff.{repo}.inbox (was: biff.inbox)\n- Client name: biff-{repo}-{user} (was: biff-{user})\n\nThe subject hierarchy biff.{repo}.inbox.{user} also opens the door for future subjects:\n\n- biff.{repo}.wall (wall broadcasts)\n- biff.{repo}.talk.{session} (talk streams)\n\n### 4. Migration\n\nOld resources (biff-sessions bucket, BIFF_INBOX stream) are orphaned. Acceptable:\n\n- Sessions: Rebuild on next heartbeat. No data loss.\n- Messages: Unread messages in old stream are lost. Acceptable pre-1.0.\n- No automatic migration: cost of building it exceeds cost of losing a few messages for early adopters. Log a warning on first connect if old resources exist.\n\n### 5. Test isolation\n\nTests that hit a real NATS server (tiers 3b, 3c) must use a repo name that cannot collide with other test runs or real usage. Each test session generates a unique repo name:\n\n- Format: _test-{uuid4_short} (e.g., _test-a1b2c3d4)\n- Leading underscore ensures it cannot collide with real repo names\n- UUID suffix ensures parallel test runs don't collide with each other\n- Test fixtures create NatsRelay with this generated repo_name\n- Test teardown deletes the KV bucket and stream (already done, but now with the scoped names)\n\nFor local relay tests: already isolated via tmp_path, no change needed.\n\n### 6. Edge cases\n\n| Case | Behavior |\n|------|----------|\n| Not in a git repo | repo_name = \"_default\" |\n| Two repos same name, different paths | Same collision local relay has (/tmp/biff/biff/ for both). Not a regression. |\n| Repo renamed | New NATS resources, old orphaned. Sessions rebuild. Same as fresh start. |\n\n## Files changed\n\n| File | Change |\n|------|--------|\n| src/biff/models.py | Add repo_name: str = \"_default\" to BiffConfig |\n| src/biff/config.py | Populate repo_name from repo_root.name, add sanitize_repo_name() |\n| src/biff/nats_relay.py | Accept repo_name in __init__, use in bucket/stream/subject names |\n| src/biff/server/state.py | Pass config.repo_name to NatsRelay() |\n| tests/conftest.py or test fixtures | Generate unique _test-{uuid} repo name per test session |\n| tests/test_nats_e2e/ | Pass repo_name through fixtures |\n| tests/test_hosted_nats/ | Same |\n| tests/test_config.py | Test sanitize_repo_name(), test repo_name in BiffConfig |\n\n## Verification\n\n1. Quality gates: ruff, pyright, pytest (tiers 1-2)\n2. NATS E2E (tier 3b): two test users in same repo see each other, different repos isolated\n3. Hosted NATS (tier 3c): same isolation test against real Synadia Cloud\n4. Manual: two repos on demo relay, /who in one does not show sessions from the other","status":"open","priority":1,"issue_type":"bug","owner":"jmf@pobox.com","created_at":"2026-02-16T00:16:10.253436-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-16T00:19:13.394414-08:00"}
{"id":"biff-jge","title":"Data models: Message, UserSession, BiffConfig","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:22:52.961011-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-13T23:43:12.476975-08:00","closed_at":"2026-02-13T23:43:12.476975-08:00","close_reason":"Frozen pydantic models: Message, UserSession, BiffConfig, UnreadSummary. 25 tests, all quality gates green."}
{"id":"biff-k0j","title":"NatsRelay implementation","description":"Implement NatsRelay class satisfying the existing Relay Protocol. NATS KV for sessions/presence, JetStream consumer with ack-and-delete for POP message semantics. Add nats-py dependency. Unit tests against local NATS server.\n\nPart of Phase 2 milestone 1: local NATS on single machine.","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T16:37:29.804198-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T17:45:29.481466-08:00","closed_at":"2026-02-14T17:45:29.481466-08:00","close_reason":"NatsRelay implemented with 28 tests, PR #16 open"}
{"id":"biff-k6u","title":"Status bar notification: write unread state for Claude Code status line","description":"Dynamic tool descriptions are model-visible only — the human user has no visual notification in Claude Code UI. The spike confirmed this UX gap.\n\nClaude Code's status bar is a configurable shell command (runs locally, can read files). Pattern: biff writes unread state to a well-known file (~/.biff/data/unread.json), and a status bar script reads it to display a live unread count.\n\nDeliverables:\n1. Biff writes unread summary to a local file whenever unread count changes\n2. Provide a sample status bar script users can configure in Claude Code settings\n3. Document setup in README\n\nDepends on the message watcher (biff-9xj) which detects unread count changes.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T05:31:05.816427-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T13:53:22.756922-08:00","closed_at":"2026-02-14T13:53:22.756922-08:00","close_reason":"PR #14 merged — unread.json status file, background poller, status bar script","dependencies":[{"issue_id":"biff-k6u","depends_on_id":"biff-9xj","type":"blocks","created_at":"2026-02-14T05:31:18.073418-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-kds","title":"TTY sessions: make MCP server instances first-class","description":"## Problem\n\nBiff collapses identity to the GitHub login — one user = one session. But a single user can have multiple Claude Code windows, multiple agents, or multiple worktrees running simultaneously. Today these stomp each other's session state (plan, mesg, presence).\n\nUnix solved this with ttys: `who` showed each terminal separately, `write user pts/1` targeted a specific one, `mesg n` was per-tty.\n\n## Design\n\nMake sessions first-class with a (user, tty) identity instead of just user.\n\n### TTY identity\n\nEach MCP server instance auto-generates a unique tty ID at startup (short random ID or PID). The user or agent can then name it with `/tty \u003cname\u003e`:\n\n```\n\u003e /tty migration\nTTY: migration\n```\n\nLike Claude Code's `/rename` — no flags, no config, just name it when you want. Unnamed sessions keep the auto-generated ID.\n\n### Wire format\n\n`UserSession` gains a `tty: str` field. Session keys in the relay become `(user, tty)` instead of just `user`. Default tty is auto-generated for backwards compatibility (single-session users see no change).\n\n### Command changes\n\n- `/tty \u003cname\u003e` — name the current session (like `/rename` in Claude Code)\n- `/who` shows each session separately\n- `/write @jim:migration \"schema approved\"` targets a specific session\n- `/write @jim \"heads up\"` delivers to all of jim's sessions (or default)\n- `/finger @jim:migration` shows that specific session\n- `/plan` and `/mesg` are per-session (already are, just keyed by tty now)\n- `/wall` hits all sessions for all users\n\n### Status bar\n\nEach session's status bar reflects its own unread count, independent of other sessions for the same user.\n\n## Motivation\n\n- Human + multiple agents: each agent is a named session, human can target or broadcast\n- Multiple Claude Code windows: no longer stomp each other\n- Matches Unix semantics exactly — `who`, `write`, `mesg` all worked per-tty","status":"open","priority":2,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-16T00:04:41.481708-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-16T00:08:24.709114-08:00","dependencies":[{"issue_id":"biff-kds","depends_on_id":"biff-jfu","type":"blocks","created_at":"2026-02-16T00:16:40.785455-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-klz","title":"/wall: team broadcast with duration-based expiry on status line","description":"## Problem\n\nTeams need a broadcast channel for time-sensitive announcements: release freezes, deploy windows, coordination directives. Regular messages go to inboxes and require recipients to `/read`. There's no way to push an announcement that's immediately visible to everyone without action on their part.\n\n## Design\n\n`/wall \u003cmessage\u003e [duration]` — broadcast a persistent banner to all team members, displayed on the status line.\n\n### Command syntax\n\n```\n/wall \"release freeze — do not push to main\"          → default 24h\n/wall \"deploy window open\" 2h                          → expires in 2 hours\n/wall \"sprint ends friday\" 5d                          → long-lived\n/wall clear                                            → manual early removal\n```\n\nDuration format: `30m`, `2h`, `1d`, `5d`. Default duration TBD (probably 24h).\n\n### Display\n\nWall messages appear on the status line after the unread count:\n\n```\nyour-status | biff(3) WALL @kai: release freeze — do not push to main\n```\n\nWhen no wall is active: `biff(3)` as today.\n\n### Behavior\n\n- One active wall per team. New wall replaces the old.\n- Wall expires automatically at `created_at + duration`.\n- Sender can clear early with `/wall clear`.\n- Wall does NOT go into inboxes — it's a banner, not a message.\n- Status line script checks for active (non-expired) wall and displays it.\n\n### Wire format\n\nRelay stores wall as a single entry per team:\n\n```\nmessage: str\nsender: str\ncreated_at: datetime\nexpires_at: datetime\n```\n\nFor NATS relay: dedicated KV key (e.g., `wall.{team}`).\nFor local relay: field in the shared state file.\n\n### Agent coordination use case\n\nHuman broadcasts directives that all agents see immediately:\n\n```\n\u003e /wall \"release freeze — do NOT push to main\"\n```\n\nEvery agent's status line shows it without needing to `/read`:\n\n```\nbiff(0) WALL @jim: release freeze — do NOT push to main\n```\n\nNo inbox check, no prompting agents to poll. It's just there — like Unix `wall` writing directly to every terminal.\n\n### Unix lineage\n\nBSD `wall(1)` — \"write all\" — wrote a message to every logged-in terminal. Fire-and-forget, immediate, interruptive. Biff's `/wall` adds duration-based persistence because status lines persist (unlike terminal scroll), and adds explicit clearing because the sender knows when the situation resolves.","status":"open","priority":2,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-16T00:12:40.52862-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-16T00:12:40.52862-08:00","dependencies":[{"issue_id":"biff-klz","depends_on_id":"biff-jfu","type":"blocks","created_at":"2026-02-16T00:16:40.625277-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-lff","title":"E2E encryption","description":"PyNaCl keypairs (Curve25519), team key distribution. Box encryption for /mesg (true E2E — relay is blind). SecretBox for /plan and /wall (Proton model — relay-trusted). Key generation on first connect, storage in ~/.biff/keys/\u003crepo-hash\u003e.key. Public key registered with relay.\n\nFuture scope — relay works without encryption first.","status":"open","priority":3,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-14T16:37:39.61443-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T16:37:39.61443-08:00","dependencies":[{"issue_id":"biff-lff","depends_on_id":"biff-adp","type":"blocks","created_at":"2026-02-14T16:38:30.492067-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-m2f","title":"/plan command — set working status","description":"Slash command: /plan \u003cmessage\u003e\nMaps to MCP tool: mcp__biff__plan\nArguments: message (required) — what you're working on\nBehavior: Sets your .plan status visible to /who and /finger.\nUnix ancestor: .plan file","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:03:36.912011-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T15:07:37.971392-08:00","closed_at":"2026-02-15T15:07:37.971392-08:00","close_reason":"Implemented in plugins/biff-commands/","dependencies":[{"issue_id":"biff-m2f","depends_on_id":"biff-eap","type":"blocks","created_at":"2026-02-15T09:04:14.097757-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-m2f","depends_on_id":"biff-9g7","type":"blocks","created_at":"2026-02-15T09:04:19.010401-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-mxn","title":"Integration test fixtures (conftest)","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T07:10:34.007203-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T07:11:52.35059-08:00","closed_at":"2026-02-14T07:11:52.35059-08:00","close_reason":"Closed","dependencies":[{"issue_id":"biff-mxn","depends_on_id":"biff-udi","type":"blocks","created_at":"2026-02-14T07:10:40.270436-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-nmt","title":"CLI entry point with transport flag","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:23:15.479711-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T08:13:00.848753-08:00","closed_at":"2026-02-14T08:13:00.848753-08:00","close_reason":"CLI entry point shipped in PR #5 (biff-x73): typer app with serve command, --transport stdio|http, --user, --data-dir, --host, --port","dependencies":[{"issue_id":"biff-nmt","depends_on_id":"biff-x73","type":"blocks","created_at":"2026-02-13T18:25:09.263904-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-npp","title":"biff install and biff doctor commands","description":"## Problem\n\nThere is no end-user install process for biff. Users have to manually hack plugin symlinks and marketplace entries. The README says `pip install biff-mcp` + `biff install-statusline` but that only installs the MCP server — not the plugin (slash commands like /who, /write, /mesg).\n\n## Reference\n\nSee quarry-mcp (../ocr) for the pattern:\n- `quarry install` — creates data dirs, downloads model, configures MCP via `claude mcp add`\n- `quarry doctor` — read-only environment diagnostics\n- `install.sh` — curl one-liner bootstrap script\n- Implementation: `src/quarry/doctor.py` (CheckResult dataclass, run_install, check_environment)\n\n## Scope\n\n### biff install\n- Register MCP server in Claude Code (`claude mcp add` or direct JSON config)\n- Install the biff plugin into Claude Code's plugin directory\n- Set up status line (absorb current `biff install-statusline` functionality)\n- Idempotent — safe to run multiple times\n\n### biff doctor\n- Check gh auth is working (identity resolution)\n- Check MCP server is configured\n- Check plugin is installed and commands are registered\n- Check status line is configured\n- Check .biff file exists in current repo (optional/warning)\n- Report version info\n\n### biff uninstall\n- Reverse of install: remove MCP server, plugin, restore status line\n- Absorb current `biff uninstall-statusline`\n\n### Cleanup\n- Deprecate/remove `biff install-statusline` and `biff uninstall-statusline` (absorbed into install/uninstall)\n- Update README Quick Start to use `biff install`\n- Update CHANGELOG","status":"open","priority":1,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-15T23:37:10.826865-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T23:37:10.826865-08:00"}
{"id":"biff-o1j","title":"/wall — broadcast command and MCP tool","description":"Implement the /wall command — team broadcast. This requires TWO pieces of work:\n\n1. **MCP tool**: Add a `wall` tool to the biff MCP server that broadcasts a message to all active team members. The tool should call `send_message` to each active user (discovered via `who`), or use a dedicated NATS subject for broadcast.\n\n2. **Plugin command**: Add `plugins/biff-commands/commands/wall.md` that maps `/wall \u003cmessage\u003e` to the new MCP tool.\n\nThe existing biff-ep3 bead covers only the command side; this bead covers both the server-side tool and the client-side command.\n\nAcceptance criteria:\n- `mcp__biff__wall(message)` broadcasts to all active sessions\n- `/wall shipping v0.2` sends the message to every online teammate\n- Shows confirmation with recipient count\n\nDepends on: the biff MCP server having a broadcast mechanism (NATS subject or fan-out via who+send_message).\n\nReferences: PR/FAQ Phase 2 — team commands.","status":"closed","priority":2,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-15T15:07:42.149281-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-16T00:17:11.330231-08:00","closed_at":"2026-02-16T00:17:11.330231-08:00","close_reason":"Superseded by biff-klz which includes duration-based expiry and status line design","dependencies":[{"issue_id":"biff-o1j","depends_on_id":"biff-jfu","type":"blocks","created_at":"2026-02-16T00:16:41.060127-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-ofy","title":"Presence tools: set_plan, who, finger, biff_toggle","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:23:04.126941-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T07:26:25.777671-08:00","closed_at":"2026-02-14T07:26:25.777671-08:00","close_reason":"All presence tools (finger, who, plan, biff toggle) implemented and tested via PR #5 and #6","dependencies":[{"issue_id":"biff-ofy","depends_on_id":"biff-hks","type":"blocks","created_at":"2026-02-13T18:24:50.809895-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-ofy","depends_on_id":"biff-x73","type":"blocks","created_at":"2026-02-13T18:24:53.336978-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-pdl","title":"Local NATS E2E tests","description":"Two MCP servers on same machine communicating through local NATS, proving identical behavior to LocalRelay subprocess tests. Cross-user presence, messaging, plan visibility, biff toggle — all through NATS KV and JetStream instead of filesystem.\n\nThis is the milestone 1 gate: single machine, two MCP servers, NATS relay.\n\nPart of Phase 2 milestone 1: local NATS on single machine.","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T16:37:34.193824-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T19:57:47.425306-08:00","closed_at":"2026-02-14T19:57:47.425306-08:00","close_reason":"PR #18 merged — 9 NATS E2E tests with two MCP servers","dependencies":[{"issue_id":"biff-pdl","depends_on_id":"biff-k0j","type":"blocks","created_at":"2026-02-14T16:38:25.833382-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-pdl","depends_on_id":"biff-59s","type":"blocks","created_at":"2026-02-14T16:38:25.944155-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-q26","title":"Workflow tests with transcript capture","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T07:10:34.241333-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T07:12:44.388839-08:00","closed_at":"2026-02-14T07:12:44.388839-08:00","close_reason":"Closed","dependencies":[{"issue_id":"biff-q26","depends_on_id":"biff-mxn","type":"blocks","created_at":"2026-02-14T07:10:40.490159-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-q26","depends_on_id":"biff-rlv","type":"blocks","created_at":"2026-02-14T07:10:40.597154-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-qo9","title":"/mesg command — send message and toggle availability","description":"Slash command: /mesg @user \u003cmessage\u003e  OR  /mesg on|off\nMaps to MCP tools: mcp__biff__send_message (messaging) and mcp__biff__biff (toggle)\nArguments: \n  - Messaging mode: to (required), message (required)\n  - Toggle mode: enabled (bool)\nBehavior: Send a purposeful async message, or toggle message reception.\nUnix ancestor: mesg / write\n\nDesign decision: Should this be one command with subcommands, or two separate commands (/mesg for sending, /biff for toggle)? The UNIX vocabulary uses mesg for both availability and as the conceptual ancestor of messaging.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:03:37.147679-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T09:04:00.272121-08:00","closed_at":"2026-02-15T09:04:00.272121-08:00","close_reason":"Splitting into /mesg and /biff per PR/FAQ vocabulary"}
{"id":"biff-qow","title":"/who command — list active sessions","description":"Slash command: /who\nMaps to MCP tool: mcp__biff__who\nArguments: none\nBehavior: Shows all active biff sessions with usernames and plan messages.\nUnix ancestor: who / w","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:03:36.79299-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T15:07:38.003437-08:00","closed_at":"2026-02-15T15:07:38.003437-08:00","close_reason":"Implemented in plugins/biff-commands/","dependencies":[{"issue_id":"biff-qow","depends_on_id":"biff-eap","type":"blocks","created_at":"2026-02-15T09:04:13.983987-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-qow","depends_on_id":"biff-9g7","type":"blocks","created_at":"2026-02-15T09:04:18.894043-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-rlv","title":"MCP protocol integration tests","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T07:10:34.124524-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T07:12:19.881406-08:00","closed_at":"2026-02-14T07:12:19.881406-08:00","close_reason":"Closed","dependencies":[{"issue_id":"biff-rlv","depends_on_id":"biff-mxn","type":"blocks","created_at":"2026-02-14T07:10:40.380993-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-sm7","title":"Claude Code SDK acceptance tests: verify UI-level experience","description":"Use @anthropic-ai/claude-code-sdk to programmatically drive two Claude Code sessions with biff configured as MCP server. Verify: (1) cross-user visibility works through Claude's tool calls (plan, who, finger), (2) presence lifecycle end-to-end (biff on/off visible across sessions). Spike on SDK capabilities first.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T08:17:38.410102-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T10:15:47.439272-08:00","closed_at":"2026-02-14T10:15:47.439272-08:00","close_reason":"Closed","dependencies":[{"issue_id":"biff-sm7","depends_on_id":"biff-al5","type":"blocks","created_at":"2026-02-14T08:17:44.868349-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-udi","title":"Transcript data model and renderer","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T07:10:33.892921-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T07:11:32.169306-08:00","closed_at":"2026-02-14T07:11:32.169306-08:00","close_reason":"Closed"}
{"id":"biff-w5y","title":"Transcript file output and pytest marker","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T07:10:34.355482-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T07:15:12.557435-08:00","closed_at":"2026-02-14T07:15:12.557435-08:00","close_reason":"Closed","dependencies":[{"issue_id":"biff-w5y","depends_on_id":"biff-q26","type":"blocks","created_at":"2026-02-14T07:10:40.703628-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-x73","title":"MCP server scaffold with HTTP/stdio transport","status":"closed","priority":0,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:23:01.66618-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T06:36:30.52152-08:00","closed_at":"2026-02-14T06:36:30.52152-08:00","close_reason":"PR #5 merged — server scaffold complete","dependencies":[{"issue_id":"biff-x73","depends_on_id":"biff-jge","type":"blocks","created_at":"2026-02-13T18:24:48.320616-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-yl1","title":"Per-project unread counts in statusline","description":"Currently ~/.biff/unread.json is a single global file. When running biff across multiple projects, whichever server wrote last wins. Unread counts should be per-project (matching the per-repo data dir architecture). The statusline should aggregate all projects, showing counts per project when multiple have unreads: e.g. 'biff(2) myapp(1)'. Requires: (1) server writes to ~/.biff/unread/{repo-name}.json instead of global file, (2) statusline scans all files in ~/.biff/unread/ and renders per-project segments.","status":"closed","priority":2,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-15T10:31:33.121616-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T11:30:39.45077-08:00","closed_at":"2026-02-15T11:30:39.45077-08:00","close_reason":"Closed"}
