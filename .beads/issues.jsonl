{"id":"biff-0wx","title":"/mesg command — send async message","description":"Slash command: /mesg @user \"text\"\nMaps to MCP tool: mcp__biff__send_message\nArguments: to (user), message (text)\nBehavior: Send a one-way async message. Recipient reads when they choose (POP semantics).\nAlso surfaces check_messages on the receiving end.\nUnix ancestor: mesg (BSD)\nPR/FAQ: Phase 1 Must Have","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:04:08.909904-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T15:07:37.892098-08:00","closed_at":"2026-02-15T15:07:37.892098-08:00","close_reason":"Implemented in plugins/biff-commands/","dependencies":[{"issue_id":"biff-0wx","depends_on_id":"biff-eap","type":"blocks","created_at":"2026-02-15T09:04:14.323771-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-0wx","depends_on_id":"biff-9g7","type":"blocks","created_at":"2026-02-15T09:04:19.233369-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-10u","title":"Fix: fire notifications/tools/list_changed on description mutation","description":"The check_messages tool description is mutated when unread messages arrive, but notifications/tools/list_changed is never sent to Claude Code. This means Claude never re-reads the tool list and never sees the updated description.\n\nTwo paths need fixing:\n1. Belt (after tool calls): refresh_check_messages runs inside a tool handler where Context is available. Queue the notification via context._queue_tool_list_changed().\n2. Suspenders (background poll): poll_inbox runs in a background asyncio.Task outside any request context. Needs direct session access to call session.send_tool_list_changed().\n\nThe PR/FAQ (line 480) says this was validated by spike, but the current implementation silently mutates without notifying.\n\nFiles: src/biff/server/tools/_descriptions.py, possibly src/biff/server/app.py","status":"closed","priority":1,"issue_type":"bug","owner":"jmf@pobox.com","created_at":"2026-02-15T09:09:24.762251-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T09:22:41.891134-08:00","closed_at":"2026-02-15T09:22:41.891134-08:00","close_reason":"Fixed in PR #21 — notifications/tools/list_changed now fires on description mutation"}
{"id":"biff-2i8","title":"Document restart requirement after namespace-changing upgrades","description":"## Problem\n\nAfter PR #39 (slug-based NATS namespace), servers started before the change remain on the old namespace (`biff-biff-inbox`) while new servers use the new namespace (`biff-punt-labs__biff-inbox`). Messages don't cross namespaces. Users see split-brain behavior until all sessions are restarted.\n\nThis is inherent to long-running MCP servers that load config at startup. Any config change that affects the NATS namespace (repo_name) requires a full restart of all biff servers.\n\n## Fix\n\n1. Add a note to CHANGELOG/README about restart requirements after upgrade\n2. Consider: `biff doctor` could detect namespace mismatches (compare running server's repo_name to what load_config would produce now)\n3. Consider: version check — server could compare its loaded version against the installed package version and warn if stale\n\n## Acceptance\n\n- `biff doctor` warns if running servers might be on an old namespace\n- Or: documented in upgrade instructions","status":"open","priority":3,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-17T09:39:02.852659-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-17T09:39:02.852659-08:00"}
{"id":"biff-2lc","title":"Spike: multi-agent worktree coordination proof-of-concept","description":"## Goal\n\nTime-boxed proof-of-concept that validates the multi-agent coordination design end-to-end. Two agents in the same directory on the same machine detect the conflict, coordinate via /write, and create worktrees — all using biff's communication primitives.\n\n## What We're Proving\n\n1. **TTY identity works** (biff-kds subset): Two MCP server instances in the same repo register as distinct sessions with unique TTY IDs. /who shows them separately.\n\n2. **Host+dir presence works** (biff-roa subset): Each session publishes hostname and pwd. /who displays these columns and flags same-host+dir overlap.\n\n3. **Targeted /write works** (biff-kds subset): An agent can /write to a specific TTY, not just a username. The recipient gets a push notification (tool name change mechanism).\n\n4. **The coordination flow works** (biff-bf8 preview): Agent claims bead → checks /who → sees collision → creates worktree → /write other agent → other agent acts on notification.\n\n## Key Design Insight: TTY from Connection Port\n\nEach `biff serve` process connects to NATS with a unique ephemeral source port assigned by the OS. This port serves as the natural TTY identifier:\n\n- **No generation needed** — the OS assigns it, like Unix PTY allocation (`/dev/pts/3`)\n- **Unique per process** — no collision risk\n- **Stable for connection lifetime** — consistent identity for the session\n- **Available via NATS client API** — `nc.client_id` or underlying socket port\n\nSession key changes from `{user}` to `{user}:{port}` in NATS KV. The optional `/tty \u003cname\u003e` (from biff-kds) becomes a human-friendly label on top of the natural ID.\n\nCurrent architecture gap: `UserSession` (models.py:66) is keyed by `user` only — two sessions for the same user stomp each other's presence. The spike fixes this by adding the TTY dimension.\n\n## What We're NOT Building\n\n- Full AGENTS.md injection (/biff y|n) — spike uses manual agent instructions\n- Wall duration/status line enhancements — spike uses basic /wall\n- Plan auto-expand — spike uses manual plan text\n- Full TTY lifecycle (naming, listing, cleanup) — spike uses raw port IDs\n- Server-side collision detection — spike relies on client reading /who output\n\n## Spike Scope\n\n### Minimum changes:\n\n**Models:**\n- Add `tty: str` field to `UserSession` (default: auto-assigned from connection)\n- Add `hostname: str` and `pwd: str` fields to `UserSession`\n\n**Relay (NATS):**\n- Session KV key becomes `{user}:{tty}` instead of `{user}`\n- /who returns all sessions (multiple per user), including host+dir columns\n- /write accepts `user:tty` syntax for targeted delivery\n- /write to bare `user` fans out to all sessions for that user\n\n**Server startup:**\n- Read NATS client connection port (or client ID) as TTY identifier\n- Read `socket.gethostname()` and `os.getcwd()` for presence\n- Publish enriched session on connect\n\n**Tests:**\n- Integration test: two clients in same tmp_path, different TTYs\n- Both register presence with same hostname+pwd\n- Client A calls /who, sees both sessions with host+dir\n- Client A /writes to Client B's specific TTY\n- Client B receives the message (not Client A)\n- /write to bare username delivers to both\n\n## Success Criteria\n\n- [ ] Two sessions for same user appear as distinct entries in /who\n- [ ] /who output includes hostname and directory per session\n- [ ] /write @user:tty delivers to specific session only\n- [ ] /write @user delivers to all sessions for that user\n- [ ] Push notification reaches the targeted session\n- [ ] Old single-session behavior still works (backwards compatible)\n\n## Related Beads\n\nThis spike de-risks and informs:\n- biff-kds (TTY sessions) — validates the connection-port-as-TTY model\n- biff-roa (enriched presence) — validates host+dir in presence\n- biff-bf8 (AGENTS.md + hooks) — validates the coordination flow\n- biff-klz (wall) — unrelated to spike but benefits from TTY foundation\n- biff-5zq (plan auto-expand) — unrelated to spike but benefits from presence enrichment","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-16T12:17:08.153961-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-16T13:30:03.848457-08:00","closed_at":"2026-02-16T13:30:03.848457-08:00","close_reason":"Spike complete: TTY sessions proven with 386 tests passing"}
{"id":"biff-2n1","title":"Expose library API via __init__.py (Projection Model)","description":"Adopt punt-kit Projection Model: every project is a library first, projected outward as CLI/MCP/plugin.\n\n## Current state\n- `__init__.py` exports nothing — no public API\n- Core logic lives in proper modules: `relay.py` (Relay Protocol), `nats_relay.py` (NatsRelay), `models.py` (UserSession, Message, etc.), `config.py` (configuration), `statusline.py`\n- CLI (`cli.py`) and MCP server (`server/`) are already thin frontends to core modules\n- `biff.testing` exports `RecordingClient` for tests\n- Dependency arrows already point inward (CLI → core, MCP → core) — architecture is sound\n\n## Gap\nThe only missing piece is `__init__.py` as the public API surface. A downstream Python app cannot `from biff import ...` and do useful work.\n\n## Target\n```python\n# biff/__init__.py — the public library API\nfrom biff.config import load_config, Config\nfrom biff.models import UserSession, Message, SessionEvent\nfrom biff.nats_relay import NatsRelay\nfrom biff.relay import Relay\n\n__all__ = [\n    \"Config\",\n    \"Message\",\n    \"NatsRelay\",\n    \"Relay\",\n    \"SessionEvent\",\n    \"UserSession\",\n    \"load_config\",\n]\n```\n\nA downstream Python app can `from biff import NatsRelay, load_config` and interact with the relay directly — same as `from quarry import search, get_db`.\n\n## What this is NOT\n- No `BiffClient` wrapper class. The Relay Protocol IS the library API. Adding a wrapper violates \"minimum complexity for current task.\"\n- No new modules. The core modules already exist and are well-structured.\n- No refactoring of CLI or MCP. They already follow the thin-frontend pattern.\n\n## Implementation\n1. Identify the minimal public surface: types, relay protocol, config loader\n2. Add explicit `__all__` to `__init__.py` with re-exports\n3. Verify no circular imports (core modules must not import from CLI/MCP)\n4. Add `test_public_api.py` confirming `from biff import X` works for all exports\n\n## Reference\n- [Projection Model](../punt-kit/standards/distribution.md) — library first, projected as CLI/MCP/plugin\n- [Package Architecture](../punt-kit/standards/python.md) — `__init__.py` is the public API, quarry gold standard\n","status":"open","priority":3,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-20T08:48:06.808661-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-22T14:07:59.344391-08:00"}
{"id":"biff-37y","title":"Messaging tools: send_message, check_messages","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:23:07.148638-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T11:24:05.210324-08:00","closed_at":"2026-02-14T11:24:05.210324-08:00","close_reason":"Closed","dependencies":[{"issue_id":"biff-37y","depends_on_id":"biff-hks","type":"blocks","created_at":"2026-02-13T18:24:55.910212-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-37y","depends_on_id":"biff-x73","type":"blocks","created_at":"2026-02-13T18:24:58.543761-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-3b6","title":"Include TTY name in status line output","description":"## Problem\n\nThe status line currently shows `biff(N)` or `project(N)` — repo-scoped only. With multiple sessions open for the same repo, there's no way to tell WHICH session you're looking at from the status bar.\n\n## Fix\n\nInclude the TTY name (from `/tty`) in the status line segment. E.g. `biff(1) tty1` or `biff:tty1(1)`.\n\n## Feasibility question\n\nThe status line script (`biff statusline`) runs as a standalone shell command — it reads `~/.biff/unread/*.json` files but has no connection to the MCP server. It doesn't know which session it belongs to.\n\nOptions:\n1. **MCP server writes TTY name to the unread file** — extend `unread.json` to include `{\"count\": N, \"preview\": \"...\", \"tty_name\": \"tty1\"}`. But multiple servers write to the same file (repo-scoped), stomping each other's TTY name.\n2. **Per-TTY unread files** — `~/.biff/unread/{repo}-{tty}.json`. Status line sums counts across files for the same repo. Each server writes only its own file. Requires the status line to group by repo.\n3. **Env var from Claude Code** — Claude Code passes session identity to the status line command via stdin JSON. The status line could use this to look up the TTY name from `sessions.json`. Depends on what Claude Code exposes.\n\nOption 2 aligns with biff-bej (TTY-scoped status bar) and solves both problems.\n\n## Depends on\n\n- biff-bej (TTY-scoped status bar) — likely implemented together\n\n## Acceptance\n\n- Each Claude Code session's status bar shows its own TTY name\n- Two sessions for the same repo show different TTY names","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-17T09:44:24.172053-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-17T11:35:45.594523-08:00","closed_at":"2026-02-17T11:35:45.594523-08:00","close_reason":"Resolved by PPID statusline PR #40: mesg is per-session (user:tty key), TTY name shown in status line","dependencies":[{"issue_id":"biff-3b6","depends_on_id":"biff-bej","type":"blocks","created_at":"2026-02-17T09:44:28.266557-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-3pn","title":"Provisioning service: per-repo NATS credentials via GitHub identity","description":"Replace bundled shared demo credentials with per-repo NATS JWTs provisioned via GitHub identity.\n\n## Approach\n\nPiggyback on existing `gh` CLI authentication rather than building a full OAuth flow:\n\n1. `biff init` (or `biff auth`) calls `gh api user` to get GitHub token\n2. Resolves the current repo via `git remote` (e.g. `punt-labs/biff`)\n3. POST to a biff provisioning service with the token + repo identifier\n4. Service verifies token, checks the user has access to that repo\n5. Provisions a NATS user JWT scoped to that repo's subject namespace\n6. Returns credentials, stored in git config or local file\n\n## Scoping model\n\n- One NATS JWT per GitHub repo (not per user)\n- Subject permissions: `biff.{org}.{repo}.\u003e` — repos can't cross-talk\n- All team members on a repo share the same credential\n- Credential stored in `.biff` or `git config` (repo-local)\n\n## Provisioning Service\n\nLightweight — Cloudflare Worker or Lambda. Responsibilities:\n- Verify GitHub token authenticity\n- Confirm caller has access to the claimed repo (GitHub API)\n- Mint NATS user JWTs with subject permissions scoped to that repo\n- Per-repo connection and data limits\n- Revocation support\n\n## Why\n\nBundled demo creds (biff-mcp 0.1.0) are fine for onboarding but shared across ALL repos — no isolation, abuse burns everyone's connection budget. Per-repo provisioning gives each team their own namespace and limits.\n\n## Depends on\n\nDemo relay confidence (bundled creds working reliably first).","status":"open","priority":4,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-15T17:23:11.88208-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T17:23:43.714309-08:00","dependencies":[{"issue_id":"biff-3pn","depends_on_id":"biff-6re","type":"blocks","created_at":"2026-02-17T11:39:26.910405-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-4rg","title":"Phase 1: Core MCP server","description":"Implement the foundational biff commands as an MCP server.\n\nCommands: /mesg, /who, /plan, /finger, /biff on|off\nLocal relay for same-machine communication.\nSingle-user value from /plan and session awareness.\n.biff file configuration (relay URL, whitelisted IDs).\n\nExit criteria: an engineer can install biff, set their plan, see active sessions, and send a message to a teammate on the same machine.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T15:25:20.011554-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T16:28:12.962472-08:00","closed_at":"2026-02-14T16:28:12.962472-08:00","close_reason":"All exit criteria met: presence tools, messaging, .biff config, local relay, subprocess tests. Shipped in PRs #10-15.","labels":["epic","phase"],"dependencies":[{"issue_id":"biff-4rg","depends_on_id":"biff-6k7","type":"blocks","created_at":"2026-02-13T16:39:51.110286-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-541","title":"/biff command — toggle message reception","description":"Slash command: /biff on | /biff off\nMaps to MCP tool: mcp__biff__biff\nArguments: enabled (bool)\nBehavior: Control whether you receive messages. When off, incoming messages are queued.\nUnix ancestor: biff (BSD)\nPR/FAQ: Phase 1 Must Have","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:04:09.031484-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T15:07:37.854449-08:00","closed_at":"2026-02-15T15:07:37.854449-08:00","close_reason":"Implemented in plugins/biff-commands/","dependencies":[{"issue_id":"biff-541","depends_on_id":"biff-eap","type":"blocks","created_at":"2026-02-15T09:04:14.434561-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-541","depends_on_id":"biff-9g7","type":"blocks","created_at":"2026-02-15T09:04:19.347141-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-59s","title":"Relay selection + config plumbing","description":"Add relay_url field to .biff config. Update biff serve startup to select LocalRelay vs NatsRelay based on config. When relay_url is present, connect to NATS; otherwise use filesystem relay.\n\nMay fold into NatsRelay implementation if scope is small enough.\n\nPart of Phase 2 milestone 1: local NATS on single machine.","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T16:37:31.696777-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T18:22:09.996955-08:00","closed_at":"2026-02-14T18:22:09.996955-08:00","close_reason":"Closed","dependencies":[{"issue_id":"biff-59s","depends_on_id":"biff-k0j","type":"blocks","created_at":"2026-02-14T16:38:23.692244-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-5uu","title":"Publish biff-mcp to PyPI","description":"DESIGN-GUIDANCE.md requires all Python projects be published to PyPI. Quarry and LangLearn TTS are published; Biff is not. The README and PROJECTS.md both reference biff-mcp as a PyPI package but pip index versions biff-mcp returns no results. Publish the package to PyPI so users can install via pip install biff-mcp or uv tool install biff-mcp.","status":"open","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-17T09:19:34.473497-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-17T09:19:34.473497-08:00","dependencies":[{"issue_id":"biff-5uu","depends_on_id":"biff-9ki","type":"blocks","created_at":"2026-02-17T11:39:26.790042-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-5zq","title":"/plan auto-expands beads IDs to include issue title","description":"When a user passes a beads ID to /plan (e.g. /plan biff-x73), detect the ID pattern and auto-expand it to include the issue title: 'biff-x73: MCP server scaffold with HTTP/stdio transport'. Requires the plan tool to shell out to bd show or read .beads/issues.jsonl to resolve the title. Falls back gracefully to the raw string if the ID doesn't match a known issue.","status":"open","priority":2,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-14T08:03:27.188798-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-16T12:28:13.007821-08:00"}
{"id":"biff-623","title":"Set up GitHub Actions CI","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T13:57:17.714558-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T13:59:43.539965-08:00","closed_at":"2026-02-15T13:59:43.539965-08:00","close_reason":"CI already configured and running: lint.yml, test.yml, hosted-nats.yml all active and green"}
{"id":"biff-6k7","title":"Spike: MCP notification rendering and subprocess handoff","description":"Validate two critical feasibility questions before committing to the full Phase 1 implementation.\n\n**Question 1: MCP notifications for receiving messages**\nCan an MCP server push a notification to Claude Code that renders visibly in the terminal? Test:\n- Create a minimal MCP server that fires a notification after a delay\n- Verify it appears in the Claude Code session without a tool call\n- Assess rendering quality (plain text? formatted? inline with conversation?)\n\n**Question 2: Subprocess handoff for /talk**\nCan an MCP server spawn an interactive subprocess that takes over terminal I/O, then return control to Claude Code cleanly? Test:\n- MCP tool call spawns a simple interactive process (e.g., a chat loop)\n- User types directly to the subprocess (no LLM intermediation)\n- Process exits, Claude Code resumes normally\n- Assess the UX transition (seamless or jarring?)\n\n**Exit criteria:**\n- Clear yes/no on both questions with evidence\n- If notifications work: document the API and rendering constraints\n- If subprocess handoff works: document the mechanism and UX quality\n- If either fails: document alternatives and revised approach for /mesg and /talk\n\n**Timeframe:** 1-2 days","notes":"Spike results (2026-02-13):\n\nQ1 (MCP notifications render?): NO - notifications/message silently dropped by Claude Code (issue #3174, closed not planned).\nQ2 (Subprocess handoff?): NO - stdio transport reserves stdout for JSON-RPC, no PTY allocation.\n\nALTERNATIVE DISCOVERED: HTTP transport + tools/list_changed\n- FastMCP HTTP transport works (Streamable HTTP + SSE)\n- Dynamic tool descriptions update via remove_tool/re-register\n- notifications/tools/list_changed automatically sent on SSE channel\n- Server-side validated via curl (all 5 checks pass)\n- Same pattern used by Slack MCP server in production\n- Claude Code end-to-end test pending (needs new session)\n\nRECOMMENDATION: Proceed with HTTP transport architecture for Phase 1.\nArchitecture documented in docs/prd/biff-phase1-communication.md and docs/sparc/phase1-implementation.md","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T16:39:47.189963-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-13T18:44:55.620389-08:00","closed_at":"2026-02-13T18:44:55.620389-08:00","close_reason":"Server-side validation complete. All 5 checks pass. HTTP transport + tools/list_changed is viable. Architecture recommendation: proceed with HTTP transport. Claude Code e2e test deferred to new session.","labels":["phase-1","spike"]}
{"id":"biff-6re","title":"GitHub identity + auth","description":"GitHub OAuth token auth to relay. Relay verifies team membership by reading .biff from repo. Public key directory managed by relay. Commit access is the trust boundary — GitHub username is identity.\n\nFuture scope — depends on encryption layer being in place.","status":"open","priority":3,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-14T16:37:41.595963-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T16:37:41.595963-08:00","dependencies":[{"issue_id":"biff-6re","depends_on_id":"biff-lff","type":"blocks","created_at":"2026-02-14T16:38:31.98322-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-7lc","title":"/check command — check inbox for messages","description":"Slash command: /check\nMaps to MCP tool: mcp__biff__check_messages\nArguments: none\nBehavior: Check and consume pending messages (POP semantics).\nNaming: /check is shorter and more natural than /check_messages as a slash command.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:03:37.263469-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T09:04:00.382548-08:00","closed_at":"2026-02-15T09:04:00.382548-08:00","close_reason":"check_messages is not a PR/FAQ command — message consumption is part of /mesg flow"}
{"id":"biff-80z","title":"Add init subcommand for per-repo activation","description":"Add init subcommand for per-repo namespace activation.\n\nAdopts org standard punt-kit-v9e. See punt-kit for the standard definition.","status":"open","priority":3,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-17T09:37:47.079083-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-20T09:04:19.422664-08:00","dependencies":[{"issue_id":"biff-80z","depends_on_id":"biff-ap0","type":"blocks","created_at":"2026-02-17T11:42:21.040636-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-860","title":"Remote NATS connection","description":"TLS connection support for remote NATS servers. Authentication via token, nkey, or creds file. Reconnect/retry handling for network interruptions. Configuration in .biff for remote NATS endpoint (Synadia Cloud or self-hosted).\n\nPart of Phase 2 milestone 2: hosted nats.io across machines.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T16:37:35.846801-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T07:05:32.529042-08:00","closed_at":"2026-02-15T07:05:32.529042-08:00","close_reason":"PR #19 merged — remote NATS connection with auth and reconnect","dependencies":[{"issue_id":"biff-860","depends_on_id":"biff-pdl","type":"blocks","created_at":"2026-02-14T16:38:27.707961-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-8ik","title":"Status bar display: bare repo name and neutral zero-count label","description":"## Problem\n\nTwo display issues in the status bar:\n\n1. **Slug names are too long**: `punt-labs__biff` truncates to `punt-labs__…` at the 12-char limit. The slug (owner__repo) is great for NATS scoping but bad for human display.\n\n2. **Default zero-count label is confusing**: When no projects have unread messages, `_biff_segment_multi` returns `biff(0)`. This looks like a project named 'biff' with 0 unread. Users see alternation between `punt-labs__…(1)` and `biff(0)` and think it's a bug.\n\n## Fix\n\n1. **Display name**: Use the bare repo name (last component of slug) for the status bar. `punt-labs__biff` → `biff`. Only use the full slug if two projects share the same bare name (collision, unlikely in practice).\n\n2. **Zero-count label**: Change from `biff(0)` to just `biff` (no count, no parens) or an empty string. The absence of a count IS the signal. Bold yellow only when count \u003e 0.\n\n## Files\n\n- `src/biff/statusline.py`: `_biff_segment_multi` and `ProjectUnread`\n- Tests: `tests/test_statusline.py`\n\n## Acceptance\n\n- `punt-labs__biff` displays as `biff(1)` not `punt-labs__…(1)`\n- Zero unread shows `biff` (plain) not `biff(0)`","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-17T09:38:50.522465-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-17T09:57:14.882106-08:00","closed_at":"2026-02-17T09:57:14.882106-08:00","close_reason":"Closed"}
{"id":"biff-8t3","title":"Phase 3: Real-time conversation, pairing, and security","description":"Add synchronous communication and the session-sharing feature.\n\nCommands: /talk, /pair\n/talk: real-time bidirectional text conversation between two terminals (model-mediated message exchange, not subprocess handoff).\n/pair: invite a teammate to send input to your Claude Code session with explicit consent model.\nSecurity audit of the encryption model (introduced in Phase 2) and the /pair permission model.\n\nExit criteria: two engineers can hold a real-time conversation and pair on a Claude session with proper consent. Security audit confirms encryption and permission models are sound.","status":"open","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T15:25:32.868851-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T13:24:24.308784-08:00","labels":["epic","phase"],"dependencies":[{"issue_id":"biff-8t3","depends_on_id":"biff-iok","type":"blocks","created_at":"2026-02-13T16:23:56.138756-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-8xu","title":".biff config file parser","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:22:57.816895-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T14:43:31.832376-08:00","closed_at":"2026-02-14T14:43:31.832376-08:00","close_reason":"PR #15: .biff TOML config with team roster, relay URL, git identity, data dir","dependencies":[{"issue_id":"biff-8xu","depends_on_id":"biff-jge","type":"blocks","created_at":"2026-02-13T18:24:45.991178-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-9g7","title":"Epic: Claude Code plugin for biff slash commands","description":"Create a Claude Code plugin that exposes all biff MCP tools as slash commands matching the UNIX communication vocabulary. Users should be able to type /who, /plan, /finger, /mesg, /wall etc. instead of asking Claude to call tools.\n\nThe plugin wraps the existing biff MCP server tools — no new backend logic needed. Each slash command maps 1:1 to an MCP tool call.\n\nAcceptance criteria:\n- Plugin scaffold (plugin.json, directory structure)\n- All implemented tools exposed as slash commands\n- Commands work in any Claude Code instance with biff MCP server configured\n- Commands match the UNIX vocabulary from CLAUDE.md","status":"closed","priority":1,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-15T09:02:58.209327-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T15:07:33.109753-08:00","closed_at":"2026-02-15T15:07:33.109753-08:00","close_reason":"All Phase 1 commands implemented in plugins/biff-commands/"}
{"id":"biff-9ki","title":"Rename PyPI package from biff-mcp to biff","description":"DESIGN-GUIDANCE.md now requires that dual CLI+MCP projects use the plain name on PyPI, not a -mcp suffix. The -mcp suffix implies MCP-only but Biff is a CLI, MCP server, and plugin. Rename the PyPI package from biff-mcp to biff. Update pyproject.toml [project] name, install instructions in README, and PROJECTS.md references.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-17T09:37:39.440886-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-19T17:22:44.204155-08:00","closed_at":"2026-02-19T17:22:44.204155-08:00","close_reason":"PyPI package renamed to punt-biff (PR #42 merged). Bead originally said 'biff' but punt- prefix convention was adopted org-wide via punt-kit-fbq."}
{"id":"biff-9n9","title":"Dual-mode MCP/CLI: expose all biff commands as CLI subcommands","description":"## Summary\n\nEvery biff operation should be usable from the terminal as `biff \u003ccommand\u003e`, not just via MCP tools inside Claude Code. This matches the quarry (../ocr) pattern where the same binary is both CLI and MCP server.\n\n## Current State\n\n- `biff serve` — starts MCP server (exists)\n- `biff init` — initializes .biff config (exists)\n- `biff version` / `biff statusline` — utility commands (exist)\n- Communication commands (`write`, `read`, `who`, `finger`, `plan`, `mesg`) — **MCP-only**, no CLI equivalents\n\n## Target State\n\nAdd CLI subcommands mirroring every MCP tool:\n\n| CLI Command | MCP Tool | Core Function |\n|-------------|----------|---------------|\n| `biff write @user \"msg\"` | `mcp__biff__write` | `relay.deliver()` |\n| `biff read` | `mcp__biff__read_messages` | `relay.fetch()` + `relay.mark_read()` |\n| `biff who` | `mcp__biff__who` | `relay.get_sessions()` |\n| `biff finger @user` | `mcp__biff__finger` | `relay.get_sessions()` filtered |\n| `biff plan \"msg\"` | `mcp__biff__plan` | `relay.update_session()` |\n| `biff mesg on/off` | `mcp__biff__mesg` | `relay.update_session()` |\n\n## Architecture\n\nFollow quarry's pattern:\n\n1. **Shared core stays in relay/models/config** — no duplication\n2. **MCP tools** (`server/tools/*.py`) remain thin wrappers calling relay\n3. **CLI commands** (`__main__.py` or `cli/` submodule) are equally thin wrappers calling the same relay methods\n4. **Boundary differences**:\n   - CLI: `print()` output, `sys.exit(1)` on error, `asyncio.run()` for async\n   - MCP: return strings, errors as strings (session continues)\n5. **Formatting shared** — `_format_table()` etc. used by both modes\n\n## Key Decisions\n\n- CLI commands need a relay connection. The `biff serve` command starts a persistent server; CLI commands need ephemeral connections. This means each CLI command will: load config → connect relay → execute → disconnect.\n- Output formatting is already server-side (columnar tables with padding). CLI can reuse directly.\n- The `update_current_session()` call in MCP tools touches session heartbeat — CLI commands may want a lighter touch (connect, act, disconnect without claiming a session slot).\n\n## Acceptance Criteria\n\n- [ ] `biff write @user \"message\"` sends a message\n- [ ] `biff read` shows unread messages (same columnar format)\n- [ ] `biff who` lists active sessions\n- [ ] `biff finger @user` shows user status\n- [ ] `biff plan \"working on X\"` sets plan\n- [ ] `biff mesg on` / `biff mesg off` toggles availability\n- [ ] All commands work without a running MCP server\n- [ ] Error handling: connection failures print to stderr, exit 1\n- [ ] Tests: unit tests for CLI commands (tier 1-2)","status":"open","priority":2,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-15T23:43:17.17362-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T23:43:17.17362-08:00","dependencies":[{"issue_id":"biff-9n9","depends_on_id":"biff-n68","type":"blocks","created_at":"2026-02-17T11:39:27.515633-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-9pl","title":"Epic: Agentic coordination — multi-agent awareness and worktree safety","description":"## Vision\n\nEnable humans and agents to work simultaneously in the same codebase without stepping on each other. Biff's communication primitives (/who, /write, /wall, /plan) become the coordination layer that prevents filesystem conflicts and gives everyone visibility into what's happening.\n\n## The Two Coordination Planes\n\n**Logical plane (cross-machine):** What work is everyone doing?\n- /plan shows the bead each agent is working on (auto-expanded with title)\n- /who shows all plans across all machines\n- Prevents: duplicate work on the same bead\n\n**Physical plane (same-machine):** Are we sharing a filesystem?\n- /who shows host + directory per session\n- Flags same-host+dir overlap (worktree collision risk)\n- /write for direct coordination between colliding agents\n- Agents create git worktrees when conflict detected\n\n## Architecture: Hybrid Detection + Agent Instructions\n\n- **Programmatic hooks** (PostToolUse) detect events reliably (bead claim, PR create/merge, branch switch) and inject reminders via additionalContext\n- **AGENTS.md instructions** cover fuzzier behaviors where agent judgment matters\n- **/biff y|n** toggles project-level opt-in — hooks only fire in enabled projects\n\n## Component Beads\n\n| Bead | What | Status |\n|------|------|--------|\n| biff-2lc | Spike: prove TTY + host+dir + targeted write | ✓ Closed |\n| biff-kds | TTY sessions: per-connection identity | ✓ Closed (PR #35) |\n| biff-yog | Fix messaging: per-user mailbox + TTY mailbox | Open, P1 |\n| biff-bm0 | /tty command: name sessions | Open, P2 |\n| biff-5zq | Plan auto-expand: bead ID → title | Open, P2 |\n| biff-roa | Enriched presence: host+dir in /who | Open, P2 |\n| biff-klz | Wall: terminal banners with TTL | Open, P2 |\n| biff-bf8 | AGENTS.md + hooks: workflow automation | Open, P2 |\n| biff-bej | Status bar scope for dual mailbox | Open, P2 |\n\n## Dependency Chain\n\n```\nbiff-yog (fix messaging — foundation)\n  ├→ biff-bm0 (/tty naming — ergonomic addressing)\n  │    └→ biff-klz (/wall — terminal banners, needs named TTYs)\n  ├→ biff-bej (status bar dual mailbox count)\n  └→ biff-qra (/last — deferred, depends on messaging design)\n\nbiff-roa (enriched presence — host+dir per session)\n  └→ biff-bf8 (AGENTS.md + hooks — the glue)\n\nbiff-5zq (plan auto-expand — independent, enhances presence story)\n```\n\n## Command Split (decided 2026-02-16)\n\n- `/write @user` = user mailbox (POP, durable, first reader consumes)\n- `/write @user:tty` = TTY mailbox (POP, durable, targeted session)\n- `/wall \"msg\" [duration]` = terminal banner (TTL, immediate, status bar)\n- `/wall @tty \"msg\"` = targeted terminal banner (requires named TTY)\n\n`@` is the universal addressing sigil. The verb determines semantics.\n\n## Success Criteria\n\nTwo agents claim different beads in the same repo on the same machine. They detect the conflict via /who, coordinate via /write, create worktrees, and work in isolation. A third agent on a different machine sees everyone's plans via /who and knows what work is claimed. The entire coordination flow is guided by AGENTS.md instructions injected by /biff y.","status":"open","priority":1,"issue_type":"epic","owner":"jmf@pobox.com","created_at":"2026-02-16T12:27:57.689922-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-16T22:04:32.690649-08:00"}
{"id":"biff-9xj","title":"Message watcher + dynamic tool descriptions","status":"closed","priority":0,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:23:10.132345-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T12:29:53.576834-08:00","closed_at":"2026-02-14T12:29:53.576834-08:00","close_reason":"PR #13 merged. Dynamic check_messages descriptions implemented with refresh on every tool call.","dependencies":[{"issue_id":"biff-9xj","depends_on_id":"biff-x73","type":"blocks","created_at":"2026-02-13T18:25:01.266105-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-9xj","depends_on_id":"biff-37y","type":"blocks","created_at":"2026-02-13T18:25:03.821906-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-a68","title":"Reduce visual noise in /help command listing","description":"The /help output for biff-commands is visually noisy. Every line repeats 'biff-commands' twice — once in the command path (/biff-commands:who) and once as the plugin prefix ((biff-commands)). Changes needed:\n\n1. Rename plugin from 'biff-commands' to 'biff' — commands become /biff:who, /biff:finger, etc.\n2. Replace /biff:biff on|off with two commands: /biff:on and /biff:off. The /biff:biff form is awkward after the rename.\n\nAffected files:\n- plugins/biff-commands/.claude-plugin/plugin.json (rename)\n- plugins/biff-commands/commands/biff.md → split into on.md and off.md\n- Plugin directory name itself (biff-commands → biff)\n- Symlink and marketplace registration may need updating","status":"closed","priority":3,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T15:32:52.176502-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T17:24:06.822781-08:00","closed_at":"2026-02-15T17:24:06.822781-08:00","close_reason":"PR #30 merged. Plugin renamed biff-commands→biff, standalone short-form commands, conflict detection in installer, bundled demo NATS credentials."}
{"id":"biff-a7p","title":"finger should show plan even when user has no active session","description":"finger should show plan even when user has no recent tool calls. In UNIX, finger read the .plan file from disk regardless of login state.\n\n## Root Cause\n\nUserSession bundles ephemeral presence (last_active) with persistent data (plan) in a single storage object with aggressive TTLs:\n- NATS KV: 300s TTL — session disappears after 5 minutes\n- /who: 120s application TTL — user drops from presence list after 2 minutes\n\nNeither /who nor /finger refresh last_active (read-only), and there is no background heartbeat.\n\n## Revised Design: Long-Lived Sessions + IDLE Display\n\nDesign principle: **Sessions persist for 30 days. \"Active\" is replaced by IDLE time.**\n\n### 1. NATS KV TTL — nats_relay.py:52\n\n_KV_TTL = 300 → _KV_TTL = 2_592_000 (30 days). Sessions survive for 30 days, naturally expiring via NATS KV TTL. No separate plan store needed.\n\n### 2. Rename get_active_sessions → get_sessions — relay.py, nats_relay.py\n\nRemove the ttl parameter. Return all sessions the relay has. NATS KV handles 30-day expiry; LocalRelay adds a 30-day cutoff on read.\n\n### 3. /who shows IDLE column — who.py\n\nInstead of filtering by 120s TTL, show ALL sessions with computed idle time:\n  @kai          2m   +  fixing auth\n  @eric        3h   +  reviewing PR #42\n  @priya       2d   -  on vacation\n\nSort by user. Idle computed from last_active.\n\n### 4. /finger handles idle state — finger.py\n\nSession always available (within 30 days). Show idle/offline indicator instead of \"Never logged in\" for known users with stale sessions.\n\n### 5. Shell hook — suppress-output.sh\n\nUpdate table format to include IDLE column.\n\n### Files Touched\n\n| File | Change |\n|------|--------|\n| src/biff/nats_relay.py | _KV_TTL 300 → 2_592_000, rename method |\n| src/biff/relay.py | Rename get_active_sessions → get_sessions, 30-day cutoff in LocalRelay |\n| src/biff/server/tools/who.py | Remove TTL filter, add idle computation, new format |\n| src/biff/server/tools/finger.py | Handle idle state display |\n| plugins/biff/hooks/suppress-output.sh | IDLE column in table |\n| tests/ | Update all who/finger tests |\n\n~40-60 lines changed across 6 files.","status":"closed","priority":2,"issue_type":"bug","owner":"jmf@pobox.com","created_at":"2026-02-15T15:34:52.132597-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T20:15:20.299184-08:00","closed_at":"2026-02-15T20:15:20.299184-08:00","close_reason":"Long-lived sessions (30d TTL) with idle time display. Implemented in fe4ed1c on fix/who-output branch."}
{"id":"biff-a94","title":"/finger repeats full user info per TTY","description":"/finger @user calls _format_session() per TTY and joins with double newline. Each block repeats Login, Name, Messages — the full header. With multiple TTYs this is redundant. Should show user info once (Login, Name, Messages) then per-TTY details (tty, idle, host, dir, plan). finger.py:100-105 is the multi-session path.","status":"closed","priority":2,"issue_type":"bug","owner":"jmf@pobox.com","created_at":"2026-02-16T15:02:16.787603-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-16T15:08:45.340574-08:00","closed_at":"2026-02-16T15:08:45.340574-08:00","close_reason":"Closed"}
{"id":"biff-adp","title":"Hosted NATS E2E tests","description":"Tests against a real Synadia Cloud / nats.io hosted account. Verifies cross-machine messaging, presence, and session management work identically to local NATS tests.\n\nThis is the milestone 2 gate: hosted account, across machines.\n\nPart of Phase 2 milestone 2: hosted nats.io across machines.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T16:37:37.444-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T08:42:47.586303-08:00","closed_at":"2026-02-15T08:42:47.586303-08:00","close_reason":"Hosted NATS E2E tests merged in PR #20","dependencies":[{"issue_id":"biff-adp","depends_on_id":"biff-860","type":"blocks","created_at":"2026-02-14T16:38:29.015085-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-al5","title":"Multi-process transport tests: two biff serve subprocesses over stdio","description":"Spawn two real biff serve processes (--user kai, --user eric, same --data-dir) connected over stdio. Exercise MCP wire protocol through actual pipes, not FastMCPTransport. Catches serialization bugs, process lifecycle issues, stdio framing. Use subprocess + MCP client library to connect. Generates transcripts like E2E tests but with real transport.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T08:17:35.89207-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T09:00:53.43409-08:00","closed_at":"2026-02-14T09:00:53.43409-08:00","close_reason":"Subprocess tests shipped in PR #9: 15 tests over StdioTransport, cross-process state verified"}
{"id":"biff-ap0","title":"Change MCP registration from global to per-project scope","description":"biff install registers the MCP server with --scope user (global). DESIGN-GUIDANCE.md requires per-project scope by default. Change installer.py to use 'claude mcp add biff' without --scope user. Global scope should be opt-in, not the default, because Biff uses per-repo .biff config files.","status":"closed","priority":2,"issue_type":"bug","owner":"jmf@pobox.com","created_at":"2026-02-17T09:37:44.142448-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-22T14:04:36.427398-08:00","closed_at":"2026-02-22T14:04:36.427398-08:00","close_reason":"Standards changed: global MCP registration is now acceptable for plugins"}
{"id":"biff-aus","title":"Status line: add repo:branch, context%, and cost segments","status":"closed","priority":2,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-22T14:03:50.135934-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-22T14:03:55.150775-08:00","closed_at":"2026-02-22T14:03:55.150775-08:00","close_reason":"Shipped in PR #50 (v0.5.0). Status line now shows repo:branch, color-coded context%, session cost, and biff messaging segment."}
{"id":"biff-ax7","title":"Targeted write syntax: @user:tty addressing","description":"Support @user:tty syntax in /write to target a specific session. /write @jim:migration sends to that session only; /write @jim (no tty) delivers to all of jim's sessions. Applies to /finger as well: /finger @jim:migration shows that specific session.","status":"closed","priority":2,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-16T20:48:26.562868-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-16T22:03:36.40282-08:00","closed_at":"2026-02-16T22:03:36.40282-08:00","close_reason":"Redundant with biff-yog which now contains the complete /write addressing design (user mailbox + TTY mailbox). The @user:tty syntax already works in the relay."}
{"id":"biff-b01","title":"Integration tests + quality gates","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:23:18.145377-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T16:28:57.177779-08:00","closed_at":"2026-02-14T16:28:57.177779-08:00","close_reason":"199 tests pass across 4 tiers (unit, integration, subprocess, SDK). Quality gates (ruff, mypy, pyright) all green. All dependent feature beads shipped with tests.","dependencies":[{"issue_id":"biff-b01","depends_on_id":"biff-ofy","type":"blocks","created_at":"2026-02-13T18:25:11.749375-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-b01","depends_on_id":"biff-37y","type":"blocks","created_at":"2026-02-13T18:25:14.358111-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-b01","depends_on_id":"biff-9xj","type":"blocks","created_at":"2026-02-13T18:25:17.058179-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-bej","title":"Status bar scope when messages are TTY-targeted","description":"## Problem (original)\n\nThe status bar reads a single unread file per repo. When write/read become TTY-scoped, the status bar needs a strategy for which TTY's messages to show.\n\n## Resolution (2026-02-16)\n\nWith the /write design in biff-yog, unread count = user mailbox unread + current TTY mailbox unread. The status bar script needs to:\n\n1. Know the current session's TTY ID (passed via env var or written to a known path by the MCP server)\n2. Read from both the user-level unread file and the TTY-level unread file\n3. Sum the counts\n\nThe MCP server already writes `unread.json` — extend it to include both counts, or write a second file for the TTY inbox.\n\n### Implementation\n\n- `unread.json` becomes: `{\"user_count\": N, \"tty_count\": M, \"preview\": \"...\"}`\n- Status bar displays the sum\n- Or: keep two separate files and let the status bar script sum them\n\n## /mesg n suppresses status line unread count\n\nWhen `/mesg n` is active on a session, the background poller should stop writing unread counts to the PPID-keyed unread file (or write count=0). The status bar stays at `user:tty(0)` even when messages arrive in the mailbox. Messages are NOT dropped — the mailbox still accumulates. Counts reappear when the user runs `/mesg y` or `/read`.\n\nThis gives `/mesg n` real meaning beyond a cosmetic flag in `/who` and `/finger`. \"Do not disturb\" should mean no visual notifications, not just a label.\n\n### Acceptance Criteria\n\n- [ ] `/mesg n` causes poller to write count=0 (or skip writing) to unread file\n- [ ] Status bar shows `user:tty(0)` (plain) while mesg is off\n- [ ] Mailbox still accumulates messages — nothing is dropped\n- [ ] `/mesg y` resumes normal unread count in status bar\n- [ ] `/read` still shows all accumulated messages regardless of mesg state\n\n### Depends on\n\n- biff-yog (per-user mailbox + TTY mailbox /read merge)\n- biff-fci (mesg should be per-TTY, not per-user)","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-16T18:02:00.852407-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-17T11:21:45.283838-08:00","closed_at":"2026-02-17T11:21:45.283838-08:00","close_reason":"Implemented: /mesg n writes biff_enabled=false to unread JSON, statusline shows (n) instead of count","dependencies":[{"issue_id":"biff-bej","depends_on_id":"biff-yog","type":"blocks","created_at":"2026-02-16T22:03:47.331163-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-bf8","title":"/biff y|n — project-level biff workflow toggle","description":"## Problem\n\nBiff is installed globally as a plugin, but team workflow automation (auto-dotplan, auto-wall) should be opt-in per project. Projects need a way to tell agents: 'this team uses biff — here is how to integrate it into your workflow.'\n\nAGENTS.md is the standard mechanism for per-project agent instructions (see beads' approach), but biff has no way to inject its section.\n\n## Solution\n\n**Hybrid approach**: Programmatic hooks for reliable event detection + AGENTS.md instructions for fuzzier behaviors.\n\n### Commands\n\n`/biff y` — enable biff workflow in current project:\n1. Find or create AGENTS.md in project root\n2. Append biff section (delimited by `\u003c!-- biff:start --\u003e` / `\u003c!-- biff:end --\u003e` markers)\n3. Idempotent — no-op if section already present\n\n`/biff n` — disable biff workflow in current project:\n1. Remove biff section from AGENTS.md (between markers)\n2. Delete AGENTS.md if empty after removal\n3. Idempotent — no-op if section not present\n\n### Programmatic Hooks (PostToolUse)\n\nHooks fire on matching events and inject `additionalContext` reminders. The agent still decides whether to act (human-in-the-loop preserved).\n\n| Event | Tool Match | Injected Reminder |\n|-------|-----------|-------------------|\n| Bead claimed | Bash: `bd update.*in_progress` | 'Set your dotplan to reflect this work: /dotplan \u003cbead title\u003e' |\n| PR created | `create_pull_request` | 'Announce to the team: /wall Created PR #N: \u003ctitle\u003e' |\n| PR merged | `merge_pull_request` | 'Announce to the team: /wall Merged PR #N: \u003ctitle\u003e' |\n| Branch switched | Bash: `git checkout\\|git switch` | 'Update your dotplan if starting new work' |\n\nHooks should only fire when biff is enabled for the project (check for `\u003c!-- biff:start --\u003e` marker in AGENTS.md).\n\n### AGENTS.md Content\n\nThe injected section covers:\n- Brief explanation that the team uses biff for communication\n- Command quick-reference (/who, /finger, /dotplan, /write, /read, /wall)\n- Guidance for fuzzier behaviors: 'when starting focused work, set your dotplan', 'when completing a milestone, consider a /wall'\n- Note that hooks handle PR and bead events automatically\n\n### Beads Integration\n\nThe bead-claim hook extracts the bead title from the `bd update` command output or the subsequent `bd show` and suggests it as dotplan text. This gives teammates visibility into what each agent is working on via `/who` or `/finger`.\n\n## Status Line Suppression\n\nWhen `/biff n` is set for a project, the status line should suppress the biff segment entirely for sessions in that project. The MCP server should either:\n- Not write the PPID-keyed unread file at all, or\n- Write a sentinel value (e.g., `{\"enabled\": false}`) that the status line script interprets as \"show nothing\"\n\nThis ensures projects that opt out of biff workflow see no biff presence in their status bar.\n\n### Acceptance Criteria\n\n- [ ] `/biff y` creates/appends AGENTS.md with biff workflow section\n- [ ] `/biff n` removes biff section, deletes empty AGENTS.md\n- [ ] Both commands are idempotent\n- [ ] PostToolUse hook fires on PR create/merge with /wall reminder\n- [ ] PostToolUse hook fires on bead claim with /dotplan reminder\n- [ ] PostToolUse hook fires on branch switch with dotplan nudge\n- [ ] Hooks only fire when biff is enabled for the project\n- [ ] Status line suppressed entirely when `/biff n` is set for the project\n- [ ] Existing `/mesg` command unaffected\n- [ ] Works in any project directory (not just biff's own repo)\n\n## Design Notes\n\n- `/mesg on|off` remains separate (per-session message reception)\n- `/biff y|n` is about project-level workflow, not session-level presence\n- Hooks only fire when biff is enabled (marker check prevents noise in non-biff projects)\n- Detection is programmatic (reliable), action is agent-driven (flexible)\n- Bash command matching is inherently regex-based and somewhat fragile for bead/branch events; GitHub MCP tool matching is clean","status":"open","priority":2,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-16T11:47:34.289521-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-17T10:56:26.018935-08:00","dependencies":[{"issue_id":"biff-bf8","depends_on_id":"biff-roa","type":"blocks","created_at":"2026-02-16T12:13:34.748876-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-bf8","depends_on_id":"biff-80z","type":"blocks","created_at":"2026-02-17T11:39:27.149627-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-bf8","depends_on_id":"biff-ap0","type":"blocks","created_at":"2026-02-17T11:39:27.391781-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-bgh","title":"/finger command — check user status","description":"Slash command: /finger @user\nMaps to MCP tool: mcp__biff__finger\nArguments: user (required) — username to query\nBehavior: Shows detailed status for a specific user.\nUnix ancestor: finger","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:03:37.031204-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T15:07:37.929336-08:00","closed_at":"2026-02-15T15:07:37.929336-08:00","close_reason":"Implemented in plugins/biff-commands/","dependencies":[{"issue_id":"biff-bgh","depends_on_id":"biff-eap","type":"blocks","created_at":"2026-02-15T09:04:14.211769-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-bgh","depends_on_id":"biff-9g7","type":"blocks","created_at":"2026-02-15T09:04:19.121194-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-bm0","title":"/tty command: name the current session","description":"Add a /tty \u003cname\u003e command that lets users name the current session (like Claude Code's /rename). Unnamed sessions keep the auto-generated tty ID. Wire format: updates the session's tty field in the relay.","status":"closed","priority":2,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-16T20:48:26.458328-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-17T08:18:51.916889-08:00","closed_at":"2026-02-17T08:18:51.916889-08:00","close_reason":"PR #38 merged. /tty command implemented with auto-assign, tty_name resolution, length limit, duplicate detection, and NATS stream config drift fix."}
{"id":"biff-bv5","title":"Phase 4: Hosted relay service (biff teams)","description":"Launch the managed biff teams offering on top of the NATS relay (Phase 2).\n\nSince the relay IS a NATS instance, the 'hosted' story is largely solved by Phase 2. Phase 4 adds the operational and commercial layer:\n\n- Default hosted NATS instance managed by biff (the free/public relay)\n- Team isolation via NATS subject namespacing and per-repo JWTs (biff-3pn)\n- Audit logs via JetStream message metadata\n- Admin controls: team membership, permissions, onboarding/offboarding\n- End-to-end encryption (client-side, keys managed outside relay)\n- Compliance exports (message history, audit trails)\n- Billing integration if needed (usage-based on message volume)\n\nSelf-hosted teams skip this entirely — they run their own nats-server.\n\nExit criteria: a team can sign up for biff teams, get a managed relay with admin controls, audit logging, and encryption.\n\nLABELS: epic, phase","status":"open","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T15:25:39.154258-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-16T12:28:29.657651-08:00","labels":["epic","phase"],"dependencies":[{"issue_id":"biff-bv5","depends_on_id":"biff-8t3","type":"blocks","created_at":"2026-02-13T16:23:56.228225-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-czx","title":"Spike: validate tools/list_changed in Claude Code","notes":"Server-side validation complete (5/5 checks pass). Remaining: Claude Code e2e test — does Claude Code act on notifications/tools/list_changed and show updated tool descriptions? Requires session restart with biff-spike registered in .mcp.json.","status":"closed","priority":0,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:23:13.074042-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-13T18:57:29.643458-08:00","closed_at":"2026-02-13T18:57:29.643458-08:00","close_reason":"E2E validated: Claude Code acts on tools/list_changed. Dynamic tool descriptions update in real-time. Full chain confirmed: simulate_message → remove/re-register tool → list_changed notification on SSE → Claude Code refreshes → updated description visible to Claude."}
{"id":"biff-dre","title":"NATS namespace collision: repo name is not globally unique","description":"## Bug\n\nNATS KV bucket names and subject prefixes use the bare repo name (e.g. `biff-biff-sessions`), not a globally unique identifier. Two unrelated projects with the same repo name on the shared demo relay will collide — their sessions, messages, and presence data will intermix.\n\n**Additionally**, repo names are not sanitized for NATS-safe characters. GitHub allows dots in repo names (e.g. `socket.io`, `vue.js`), but NATS uses `.\" as a subject delimiter. A repo named `my.repo` would produce invalid bucket/subject names that break NATS subject hierarchy.\n\n## Root Cause\n\n`NatsRelay` constructs bucket/stream names from `repo_name` (the git directory basename), which is:\n1. **Not globally unique** — `punt-labs/biff` and `someone-else/biff` both resolve to `biff`\n2. **Not sanitized** — dots, spaces, and other NATS-illegal characters in repo names are passed through verbatim\n\n## Fix\n\n1. Use the full GitHub owner/repo slug (e.g. `punt-labs/biff`) or a hash of the remote URL as the namespace key\n2. Sanitize the namespace identifier for NATS: replace dots and illegal characters with dashes or use a hash\n\nChanges needed:\n- `BiffConfig.repo_name` — resolve to `owner/repo` from git remote\n- `NatsRelay` bucket/stream naming — sanitize for NATS\n- `.biff` file format (if repo identity is stored there)\n- Existing KV data migration (or accept a clean break)\n\n## Impact\n\n- Two teams using the demo relay with identically-named repos will see each other's sessions and messages (data leak)\n- Repos with dots in their name will fail to connect or produce corrupt NATS subjects","status":"closed","priority":1,"issue_type":"bug","owner":"jmf@pobox.com","created_at":"2026-02-17T07:43:11.070394-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-17T08:57:59.824389-08:00","closed_at":"2026-02-17T08:57:59.824389-08:00","close_reason":"Fixed in PR #39. NATS namespace now derived from owner/repo slug via git remote origin, with __ delimiter."}
{"id":"biff-eap","title":"Scaffold biff Claude Code plugin","description":"Create the plugin directory structure and plugin.json manifest.\n\nStructure:\n  plugins/biff-commands/\n    plugin.json         — manifest with name, version, description, commands list\n    commands/           — slash command definitions\n    skills/             — skill definitions (if needed)\n\nThe plugin must reference the biff MCP server tools. Each command will be a skill file that instructs Claude to call the corresponding biff MCP tool.\n\nAcceptance criteria:\n- plugin.json validates correctly\n- Plugin can be loaded by Claude Code (local install or symlink)\n- Directory structure follows Claude Code plugin conventions","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:03:05.968828-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T15:07:37.667897-08:00","closed_at":"2026-02-15T15:07:37.667897-08:00","close_reason":"Scaffold complete — plugin.json + 6 command files","dependencies":[{"issue_id":"biff-eap","depends_on_id":"biff-9g7","type":"blocks","created_at":"2026-02-15T09:04:18.783178-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-ep3","title":"/wall command — team broadcast","description":"Slash command: /wall \"text\"\nMaps to MCP tool: TBD (not yet implemented as MCP tool)\nBehavior: Broadcast a message to your team or hive.\nUnix ancestor: wall (BSD)\nPR/FAQ: Phase 2 Should Have\nNote: MCP tool backend needs to be built first — this task is plugin-side only, blocked until backend exists.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:04:09.149656-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T15:07:57.019954-08:00","closed_at":"2026-02-15T15:07:57.019954-08:00","close_reason":"Superseded by biff-o1j which covers both the MCP tool and plugin command","dependencies":[{"issue_id":"biff-ep3","depends_on_id":"biff-eap","type":"blocks","created_at":"2026-02-15T09:04:14.545303-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-ep3","depends_on_id":"biff-9g7","type":"blocks","created_at":"2026-02-15T09:04:19.464517-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-eqz","title":"/who output not sorted by idle time","description":"/who sorts by (user, tty) alphabetically (who.py:75). Should sort by idle time ascending so the most recently active sessions appear first. This is more useful — you want to see who's active, not alphabetical order.","status":"closed","priority":2,"issue_type":"bug","owner":"jmf@pobox.com","created_at":"2026-02-16T15:02:15.20616-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-16T15:08:45.33574-08:00","closed_at":"2026-02-16T15:08:45.33574-08:00","close_reason":"Closed"}
{"id":"biff-faz","title":"Align command vocabulary with Unix semantics","description":"Current biff commands mismap Unix ancestors. Fix the vocabulary:\n\n## Problem\n- `/mesg @user msg` sends messages — but Unix `mesg(1)` only controls reception\n- `biff on/off` tool controls reception — but Unix `biff(1)` is mail notification\n- `send_message` MCP tool name doesn't match any Unix command\n\n## Correct Mapping\n| Slash Command | MCP Tool | Unix Ancestor | Purpose |\n|---|---|---|---|\n| `/write @user msg` | `write` | `write(1)` | Send a message |\n| `/mesg y` / `/mesg n` | `mesg` | `mesg(1)` | Control message reception |\n| (product name) | — | `biff(1)` | New mail notification (status line) |\n| `/finger` | `finger` | `finger(1)` | Already correct |\n| `/who` | `who` | `who(1)` | Already correct |\n| `/plan` | `plan` | `.plan` | Already correct |\n| `/check` | `check_messages` | `from(1)`/`mail(1)` | Already correct |\n\n## Changes Required\n1. Rename MCP tool `send_message` → `write`\n2. Rename MCP tool `biff` (on/off) → `mesg`\n3. Update slash command `/mesg` → `/write` for sending\n4. Update slash command for reception control to `/mesg on` or `/mesg y`\n5. Update CLAUDE.md command vocabulary table\n6. Update plugin hooks, install.sh, tests\n7. Update PR/FAQ if it references command names","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T20:44:21.908617-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T21:00:50.238054-08:00","closed_at":"2026-02-15T21:00:50.238054-08:00","close_reason":"Tool names aligned: biff→mesg, send_message→write, check_messages→read_messages. All 293 tests pass."}
{"id":"biff-fci","title":"mesg on/off should be per-TTY, not per-user","description":"Currently /finger shows 'Messages: on' at the user level, but with multi-TTY sessions it should be per-session. A user might want messages off in one session (deep work) and on in another (coordination). The mesg flag lives on UserSession but /finger displays it once for the user header instead of per-TTY line.","status":"closed","priority":2,"issue_type":"bug","owner":"jmf@pobox.com","created_at":"2026-02-16T17:46:04.983566-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-17T11:35:45.591493-08:00","closed_at":"2026-02-17T11:35:45.591493-08:00","close_reason":"Resolved by PPID statusline PR #40: mesg is per-session (user:tty key), TTY name shown in status line"}
{"id":"biff-gjy","title":"Add plugin dev/prod namespace isolation","description":"Adopt the --plugin-dir dev/prod isolation pattern from punt-kit (PR #15).\n\n## What\n\n- Change plugin.json name from biff to biff-dev\n- Add -dev command variants for any existing commands\n- Add release/restore scripts (scripts/release-plugin.sh, scripts/restore-dev-plugin.sh)\n- Update hook matchers to handle both prod/dev MCP tool prefixes (biff_dev underscore form)\n- Update SessionStart hook to grant permissions for both mcp__plugin_biff_tty__* and mcp__plugin_biff_dev_tty__*\n\n## Reference\n\n- punt-kit PR #15: https://github.com/punt-labs/punt-kit/pull/15\n- Standard: punt-kit/standards/plugins.md Dev/Prod Namespace Isolation\n\n## MCP complication\n\nbiff has an MCP server (tty). Hyphens in plugin names become underscores in MCP tool prefixes. Hook matchers need regex: mcp__plugin_biff(_dev)?_tty__.*","status":"open","priority":3,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-22T11:32:46.900781-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-22T11:32:46.900781-08:00"}
{"id":"biff-gyj","title":"Install biff MCP server globally in ~/.claude/mcp.json","description":"The biff MCP server is currently configured per-project in .mcp.json. Since statusLine is global (~/.claude/settings.json), the MCP server must also be global so biff runs in every session and can update unread counts regardless of which project is open. The install-statusline command should also add the biff server entry to ~/.claude/mcp.json (and uninstall should remove it). Depends on biff-yl1 (per-project unread counts) to avoid cross-project collisions once the server runs globally.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T10:54:22.69127-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T14:38:08.724138-08:00","closed_at":"2026-02-15T14:38:08.724138-08:00","close_reason":"Completed in PRs #24-#26 (register MCP server on install/uninstall) and #27 (graceful degradation)","dependencies":[{"issue_id":"biff-gyj","depends_on_id":"biff-yl1","type":"blocks","created_at":"2026-02-15T10:54:26.355171-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-hjb","title":"Stale unread files: add cleanup on server startup","description":"## Problem\n\n`~/.biff/unread/` accumulates JSON files for every project that ever ran a biff server. No cleanup mechanism exists — servers write files but never delete them. After the slug-based naming change (DES-007a), old `biff.json` files coexist with new `punt-labs__biff.json` files, causing confusion.\n\n## Fix\n\nOn server startup (in the lifespan), scan `~/.biff/unread/` and remove files whose repo_name doesn't match any currently-running biff process. Conservative approach: each server writes its own `repo_name` to a lockfile/pidfile in `~/.biff/active/` on startup, removes on shutdown. The status line script (or a periodic task) removes unread files with no matching active file.\n\nAlternative simpler approach: each server removes its own unread file on shutdown (signal handler + lifespan finally block). Stale files from killed processes remain but are harmless (count=0).\n\n## Acceptance\n\n- Server startup cleans up its own stale unread file from prior runs\n- Server shutdown writes count=0 to its unread file (already happens via poller)\n- Bonus: periodic sweep removes files with count=0 older than 24h","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-17T09:38:50.291526-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-17T11:39:31.320332-08:00","closed_at":"2026-02-17T11:39:31.320332-08:00","close_reason":"PR #40 deletes PPID-keyed unread file in lifespan finally block on shutdown"}
{"id":"biff-hks","title":"Storage layer: inbox.py and sessions.py","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:22:55.326517-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T05:34:52.008196-08:00","closed_at":"2026-02-14T05:34:52.008196-08:00","close_reason":"MessageStore + SessionStore with 35 tests. JSONL/JSON backed, atomic writes, malformed data recovery.","dependencies":[{"issue_id":"biff-hks","depends_on_id":"biff-jge","type":"blocks","created_at":"2026-02-13T18:24:42.996974-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-iok","title":"Phase 2: Network relay and team commands","description":"Enable cross-machine messaging and team-level commands via a hosted NATS relay.\n\nSee prfaq.tex for authoritative product vision, phasing, and scope.\n\n## Architecture\n\npunt-labs runs the default hosted relay (NATS + JetStream). Teams connect by having a .biff file in their repo with the relay URL and member usernames. No accounts to create — pip install biff-mcp + clone = connected.\n\nTeams that want data sovereignty can self-host the same single-binary NATS server.\n\n## Data Source \u0026 Durability\n\n| Command | Durability | Source | Encryption |\n|---------|-----------|--------|------------|\n| /plan | Persistent | Relay | Team key (SecretBox) |\n| /who | Ephemeral | Relay | None (presence metadata) |\n| /finger | Both | Relay | Plan: team key. Online status: none |\n| /biff on/off | Ephemeral | Relay | None (session toggle) |\n| /mesg | Store-and-forward (POP) | Relay | Recipient's public key (Box) — true E2E |\n| /wall | Ephemeral | Relay | Team key (SecretBox) |\n| /hive | Ephemeral | Relay | Ephemeral hive key (SecretBox) |\n| /send | TBD | TBD | Design pending |\n| /cr | TBD | TBD | Design pending |\n| /talk | Ephemeral | Relay | Recipient's public key (Box) |\n| /pair | Ephemeral | Relay | Recipient's public key (Box) |\n\n## POP Mail Model\n\nThe relay follows POP semantics for /mesg: messages are stored on the relay only until the recipient reads them, then discarded. Biff is not a system of record. /wall is ephemeral broadcast — miss it if you're offline.\n\nNATS JetStream consumers with ack-and-delete implement this directly.\n\n## Encryption Design\n\n### Inspiration: ProtonMail\n\nEncryption is invisible to the user. The relay manages the public key directory. Clients encrypt/decrypt locally. The relay routes ciphertext. Like ProtonMail, the server is trusted for key distribution but untrusted for message content.\n\n### Primitives (PyNaCl / libsodium)\n\n- crypto_box (Box): 1:1 messages — Curve25519 + XSalsa20-Poly1305. True E2E.\n- crypto_secretbox (SecretBox): Group messages — XSalsa20-Poly1305 with symmetric key.\n- PyNaCl v1.6.2, Python 3.13+, actively maintained. Same crypto as Signal, WireGuard, age.\n\n### Identity \u0026 Root of Trust\n\nCommit access is the trust boundary:\n1. Your GitHub username is your identity\n2. You add your username to .biff in the repo (proves commit access)\n3. Relay reads .biff from GitHub to verify team membership\n4. Auth to relay via GitHub OAuth token\n\n### Keys\n\n- User keypair (Curve25519): per-user, per-repo. Private key in ~/.biff/keys/\u003crepo-hash\u003e.key. Public key in relay's key directory. Generated silently on first connection.\n- Team key (symmetric, 32 bytes): per-repo. Generated by relay, distributed to members encrypted with their public keys.\n- Hive key (symmetric, 32 bytes): per-hive, ephemeral. Same distribution model. Destroyed when hive dissolves.\n\n### User Experience (transparent)\n\npip install biff-mcp → clone repo with .biff → first biff serve generates keypair silently → public key registered with relay → team key received encrypted with your public key → user never sees any of this.\n\n### Encryption Per Command\n\n/mesg @kai \"text\" (true E2E, relay is blind):\n  Sender: Box(my_privkey, kai_pubkey).encrypt(message) → relay stores ciphertext\n  Kai: Box(kai_privkey, sender_pubkey).decrypt(ciphertext)\n\n/wall \"text\" (team key, ephemeral broadcast):\n  Sender: SecretBox(team_key).encrypt(message) → relay broadcasts ciphertext\n  Members: decrypt with cached team key\n\n/plan \"text\" (team key, persistent on relay):\n  Client: SecretBox(team_key).encrypt(plan) → relay stores ciphertext\n  /finger: relay returns encrypted plan → requester decrypts with team key\n\n/hive (ephemeral group key):\n  Relay generates hive key → distributes via each member's public key\n  All hive messages: SecretBox(hive_key).encrypt(message)\n\n### Key Lifecycle\n\nNew member: adds username to .biff, commits. First connection → keypair generated, public key registered. Relay encrypts team key with new member's public key → sends it.\n\nMember leaves: removed from .biff. Relay removes public key, rotates team key, re-distributes to remaining members.\n\nLost key: reconnect → new keypair, re-registered. Unread POP messages lost (acceptable). Team key re-sent with new public key.\n\n### Trust Boundaries\n\nTrue E2E (relay is blind): /mesg, /talk, /pair — encrypted with recipient's public key. Relay holds ciphertext it cannot decrypt.\n\nRelay-trusted (Proton model): /wall, /plan, /hive — relay generates the symmetric key, so it could theoretically read these. Same trust model as ProtonMail.\n\nFuture enhancement: client-side team key generation for zero-knowledge relay. More complex (requires someone online to welcome new members).\n\nPlaintext metadata: from, to, repo, timestamps — relay needs this for routing.\n\n## NATS Implementation\n\n### Why NATS + JetStream\n\n- Purpose-built for messaging. JetStream provides persistence and delivery guarantees.\n- KV store for presence (/who, /finger) with TTL, watch API. ~50 LOC.\n- JetStream consumers with ack-and-delete implement POP model directly.\n- nats-py v2.13.1 (Feb 2026), 145K weekly PyPI downloads, full asyncio.\n- Self-hosting: single Go binary (\u003c20MB). nats-server -js.\n- Managed hosting: Synadia Cloud (free personal, $49/mo starter).\n- Handles 100K msg/s on single node.\n\n### Hosting Model\n\npunt-labs runs the default NATS instance. Free tier with volume limits. Teams needing higher volume or data sovereignty self-host the same binary.\n\n## Open Design Questions\n\n1. Freemium model — volume limits, what's free vs. paid\n2. GitHub integration — how relay reads .biff (webhook vs. poll vs. on-connect fetch)\n3. /send and /cr — data source, persistence, and encryption model TBD\n4. Team key rotation schedule — on membership change only, or periodic?\n5. Key pinning / transparency — how to detect relay serving wrong public keys (TOFU vs. key transparency log)\n\n## Client Architecture\n\nNew module: biff.relay with:\n- RelayClient — wraps nats-py, handles connect/disconnect/send/subscribe\n- RelayMessageStore — POP model: pull unread, ack-and-delete\n- RelaySessionStore — presence via NATS KV store\n- RelayCrypto — wraps PyNaCl, manages keypairs and team key cache\n\nDual-mode: local (filesystem) or relay, selected by relay_url in .biff file.\n\n## Exit Criteria\n\nA distributed team can communicate end-to-end through biff across machines using the default hosted relay or their own self-hosted instance, with E2E encryption for 1:1 messages and Proton-model encryption for team messages.","status":"open","priority":2,"issue_type":"epic","owner":"jmf@pobox.com","created_at":"2026-02-13T15:25:26.267422-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T16:37:24.524171-08:00","labels":["epic","phase"],"dependencies":[{"issue_id":"biff-iok","depends_on_id":"biff-4rg","type":"blocks","created_at":"2026-02-13T16:23:56.052507-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-iok","depends_on_id":"biff-pdl","type":"blocks","created_at":"2026-02-14T16:38:54.364678-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-iok","depends_on_id":"biff-adp","type":"blocks","created_at":"2026-02-14T16:38:54.475323-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-iok","depends_on_id":"biff-lff","type":"blocks","created_at":"2026-02-14T16:38:54.58745-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-iok","depends_on_id":"biff-6re","type":"blocks","created_at":"2026-02-14T16:38:54.69716-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-jfu","title":"NATS namespace scoping: isolate relay resources per repo","description":"## Problem\n\nNATS KV bucket (biff-sessions) and JetStream stream (BIFF_INBOX) use hardcoded names. Any NATS server serving multiple repos has complete data collision: sessions, messages, and future features (wall, tty) all bleed across repo boundaries.\n\nThis is the normal deployment scenario — a company self-hosts one NATS server and has multiple repos with .biff files pointing at it. Every engineer's /who shows sessions from every repo, messages cross-deliver, plans leak. The demo relay makes it worse (strangers collide) but it's broken for any multi-repo setup.\n\nLocal relay is already repo-scoped by directory path (/tmp/biff/{repo_name}/). NATS is not.\n\n## Root cause\n\nNatsRelay receives (url, auth, client_name) but zero knowledge of which repo it serves. The repo identity is available in load_config() but never flows to the relay.\n\n```\nload_config()\n  -\u003e repo_root = find_git_root()              # knows the repo\n  -\u003e compute_data_dir(repo_root, prefix)       # /tmp/biff/{repo_name}/ \u003c- scoped\n\ncreate_state(config, data_dir)\n  -\u003e LocalRelay(data_dir=data_dir)             # inherits repo scope from path\n  -\u003e NatsRelay(url=..., name=f\"biff-{user}\")   # NO repo info passed\n```\n\n## Design\n\n### 1. Flow repo identity to the relay\n\nAdd repo_name: str = \"_default\" to BiffConfig. Populate from sanitize_repo_name(repo_root.name) in load_config(). \"_default\" is the fallback when not in a git repo (matches local relay convention).\n\n### 2. Sanitize repo names for NATS\n\nNATS constraints: bucket names allow alphanumeric/dash/underscore only. Subject dots are level separators. Wildcards (* \u003e) are reserved.\n\n```python\ndef sanitize_repo_name(name: str) -\u003e str:\n    clean = name.replace(\".\", \"-\").replace(\" \", \"-\")\n    return \"\".join(c for c in clean if c.isalnum() or c in \"-_\") or \"_default\"\n```\n\n### 3. Namespace all NATS resources\n\nNatsRelay.__init__ accepts repo_name, uses it everywhere:\n\n- KV bucket: biff-{repo}-sessions (was: biff-sessions)\n- Stream: BIFF_{repo}_INBOX (was: BIFF_INBOX)\n- Subject prefix: biff.{repo}.inbox (was: biff.inbox)\n- Client name: biff-{repo}-{user} (was: biff-{user})\n\nThe subject hierarchy biff.{repo}.inbox.{user} also opens the door for future subjects:\n\n- biff.{repo}.wall (wall broadcasts)\n- biff.{repo}.talk.{session} (talk streams)\n\n### 4. Migration\n\nNo migration. Sessions rebuild on next heartbeat. Unread messages in old stream are lost — acceptable pre-1.0. Old resources (biff-sessions bucket, BIFF_INBOX stream) are orphaned and will be purged by NATS TTL or can be manually deleted.\n\n### 5. Test isolation\n\nTests that hit a real NATS server (tiers 3b, 3c) must use a repo name that cannot collide with other test runs or real usage. Each test session generates a unique repo name:\n\n- Format: _test-{uuid4_short} (e.g., _test-a1b2c3d4)\n- Leading underscore ensures it cannot collide with real repo names\n- UUID suffix ensures parallel test runs don't collide with each other\n- Test fixtures create NatsRelay with this generated repo_name\n- Test teardown deletes the KV bucket and stream (already done, but now with the scoped names)\n\nNOTE: The existing CI failures (test_biff_off_visible_to_other, test_both_visible_in_who) show plan text leaking between tests — sessions from one test bleed into the next. This is the same class of isolation bug. Subprocess test fixtures must also ensure each test gets a clean relay with no leftover state.\n\nFor local relay tests: already isolated via tmp_path, no change needed.\n\n### 6. Edge cases\n\n| Case | Behavior |\n|------|----------|\n| Not in a git repo | repo_name = \"_default\" |\n| Two repos same name, different paths | Same collision local relay has. Not a regression. |\n| Repo renamed | New NATS resources, old orphaned. Sessions rebuild. |\n\n## Files changed\n\n| File | Change |\n|------|--------|\n| src/biff/models.py | Add repo_name: str = \"_default\" to BiffConfig |\n| src/biff/config.py | Populate repo_name from repo_root.name, add sanitize_repo_name() |\n| src/biff/nats_relay.py | Accept repo_name in __init__, use in bucket/stream/subject names |\n| src/biff/server/state.py | Pass config.repo_name to NatsRelay() |\n| tests/conftest.py or test fixtures | Generate unique _test-{uuid} repo name per test session |\n| tests/test_nats_e2e/ | Pass repo_name through fixtures |\n| tests/test_hosted_nats/ | Same |\n| tests/test_subprocess/ | Investigate and fix session leakage between tests |\n| tests/test_config.py | Test sanitize_repo_name(), test repo_name in BiffConfig |\n\n## Verification\n\n1. Quality gates: ruff, pyright, pytest (tiers 1-2)\n2. Subprocess tests (tier 3): CI failures resolved, no cross-test leakage\n3. NATS E2E (tier 3b): two test users in same repo see each other, different repos isolated\n4. Hosted NATS (tier 3c): same isolation test against real Synadia Cloud\n5. Manual: two repos on same NATS server, /who in one does not show sessions from the other","status":"closed","priority":1,"issue_type":"bug","owner":"jmf@pobox.com","created_at":"2026-02-16T00:16:10.253436-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-16T06:43:55.017548-08:00","closed_at":"2026-02-16T06:43:55.017548-08:00","close_reason":"Merged PR #33: all NATS resources scoped by repo_name"}
{"id":"biff-jge","title":"Data models: Message, UserSession, BiffConfig","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:22:52.961011-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-13T23:43:12.476975-08:00","closed_at":"2026-02-13T23:43:12.476975-08:00","close_reason":"Frozen pydantic models: Message, UserSession, BiffConfig, UnreadSummary. 25 tests, all quality gates green."}
{"id":"biff-k0j","title":"NatsRelay implementation","description":"Implement NatsRelay class satisfying the existing Relay Protocol. NATS KV for sessions/presence, JetStream consumer with ack-and-delete for POP message semantics. Add nats-py dependency. Unit tests against local NATS server.\n\nPart of Phase 2 milestone 1: local NATS on single machine.","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T16:37:29.804198-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T17:45:29.481466-08:00","closed_at":"2026-02-14T17:45:29.481466-08:00","close_reason":"NatsRelay implemented with 28 tests, PR #16 open"}
{"id":"biff-k6u","title":"Status bar notification: write unread state for Claude Code status line","description":"Dynamic tool descriptions are model-visible only — the human user has no visual notification in Claude Code UI. The spike confirmed this UX gap.\n\nClaude Code's status bar is a configurable shell command (runs locally, can read files). Pattern: biff writes unread state to a well-known file (~/.biff/data/unread.json), and a status bar script reads it to display a live unread count.\n\nDeliverables:\n1. Biff writes unread summary to a local file whenever unread count changes\n2. Provide a sample status bar script users can configure in Claude Code settings\n3. Document setup in README\n\nDepends on the message watcher (biff-9xj) which detects unread count changes.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T05:31:05.816427-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T13:53:22.756922-08:00","closed_at":"2026-02-14T13:53:22.756922-08:00","close_reason":"PR #14 merged — unread.json status file, background poller, status bar script","dependencies":[{"issue_id":"biff-k6u","depends_on_id":"biff-9xj","type":"blocks","created_at":"2026-02-14T05:31:18.073418-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-kds","title":"TTY sessions: make MCP server instances first-class","description":"## Problem\n\nBiff collapses identity to the GitHub login — one user = one session. But a single user can have multiple Claude Code windows, multiple agents, or multiple worktrees running simultaneously. Today these stomp each other's session state (plan, mesg, presence).\n\nUnix solved this with ttys: `who` showed each terminal separately, `write user pts/1` targeted a specific one, `mesg n` was per-tty.\n\n## Design\n\nMake sessions first-class with a (user, tty) identity instead of just user.\n\n### TTY identity\n\nEach MCP server instance auto-generates a unique tty ID at startup (short random ID or PID). The user or agent can then name it with `/tty \u003cname\u003e`:\n\n```\n\u003e /tty migration\nTTY: migration\n```\n\nLike Claude Code's `/rename` — no flags, no config, just name it when you want. Unnamed sessions keep the auto-generated ID.\n\n### Wire format\n\n`UserSession` gains a `tty: str` field. Session keys in the relay become `(user, tty)` instead of just `user`. Default tty is auto-generated for backwards compatibility (single-session users see no change).\n\n### Command changes\n\n- `/tty \u003cname\u003e` — name the current session (like `/rename` in Claude Code)\n- `/who` shows each session separately\n- `/write @jim:migration \"schema approved\"` targets a specific session\n- `/write @jim \"heads up\"` delivers to all of jim's sessions (or default)\n- `/finger @jim:migration` shows that specific session\n- `/plan` and `/mesg` are per-session (already are, just keyed by tty now)\n- `/wall` hits all sessions for all users\n\n### Status bar\n\nEach session's status bar reflects its own unread count, independent of other sessions for the same user.\n\n## Motivation\n\n- Human + multiple agents: each agent is a named session, human can target or broadcast\n- Multiple Claude Code windows: no longer stomp each other\n- Matches Unix semantics exactly — `who`, `write`, `mesg` all worked per-tty","status":"closed","priority":1,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-16T00:04:41.481708-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-16T20:48:36.905733-08:00","closed_at":"2026-02-16T20:48:36.905733-08:00","close_reason":"Core TTY session lifecycle landed in PR #35. Remaining items split to biff-bm0 (/tty command) and biff-ax7 (@user:tty addressing).","dependencies":[{"issue_id":"biff-kds","depends_on_id":"biff-jfu","type":"blocks","created_at":"2026-02-16T00:16:40.785455-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-kds","depends_on_id":"biff-2lc","type":"blocks","created_at":"2026-02-16T12:17:14.593563-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-klz","title":"/wall: team broadcast with duration-based expiry on status line","description":"## Problem\n\nTeams need a broadcast channel for time-sensitive announcements: release freezes, deploy windows, coordination directives. Regular messages go to inboxes and require recipients to `/read`. There's no way to push an announcement that's immediately visible to everyone without action on their part.\n\n## Design (updated 2026-02-16)\n\n### Command semantics: /wall = terminal banners with TTL\n\n`/wall` addresses **terminals** (not users). Immediate visibility on status bar + tool descriptions. TTL-based expiry. Complements `/write` which addresses **user mailboxes** (see biff-yog).\n\n### Addressing\n\n| Command | Target |\n|---------|--------|\n| `/wall \"msg\"` | All terminals (team broadcast) |\n| `/wall @tty1 \"msg\"` | Specific terminal (requires named TTY via biff-bm0) |\n| `/wall @tty1:tty2 \"msg\"` | Multiple terminals |\n| `/wall clear` | Clears active banner |\n\n`@` is the universal addressing sigil, consistent with `/write`.\n\n### Duration\n\n```\n/wall \"release freeze — do not push to main\"          → default duration (TBD)\n/wall \"deploy window open\" 2h                          → 2 hour expiry\n/wall \"sprint ends friday\" 5d                          → long-lived\n```\n\nDuration format: `30m`, `2h`, `1d`, `5d`.\n\n### Display\n\nStatus bar: `biff(3) WALL @kai: release freeze — do not push to main`\n\nVisible to Claude via tool description changes (same push notification mechanism as unread counts). No `/read` required.\n\n### Behavior\n\n- One active wall per team (broadcast) or per-terminal (targeted). New replaces old.\n- Expires automatically at `created_at + duration`.\n- `/wall clear` removes early.\n- Wall does NOT go into `/read` inboxes — it is a banner, not a message.\n\n### When to use /wall vs /write\n\n| Scenario | Command | Why |\n|----------|---------|-----|\n| Tell eric to review a PR | `/write @eric` | Durable, eric reads when available |\n| Tell agent2 to pause | `/write @eric:agent2` | Durable, agent2 reads on next `/read` |\n| Announce release freeze | `/wall \"freeze\" 4h` | Immediate visibility on all terminals |\n| Direct an agent urgently | `/wall @agent2 \"stop\" 5m` | Immediate banner (requires named TTY) |\n| Broadcast to all terminals | `/wall \"pull latest\"` | All terminals see it now |\n\n`/write` = \"read this when you can\" (inbox, POP).\n`/wall` = \"see this right now\" (banner, TTL).\n\n### Wire format\n\n```\nmessage: str, sender: str, created_at: datetime, expires_at: datetime\n```\n\nNATS: KV key `wall.{repo}` (broadcast) or `wall.{repo}.{tty}` (targeted).\nLocal: field in shared state file.\n\n### What needs to be built\n\n1. Wall relay storage — KV entry per team/terminal with TTL.\n2. Wall status bar integration — status line script checks for active wall.\n3. Wall tool description integration — same mechanism as unread count notifications.\n4. `/wall` tool registration and command prompt.\n5. `/wall clear` subcommand.\n\n### Dependencies\n\n- **biff-bm0** (`/tty \u003cname\u003e`) — required for targeted `/wall @tty` to be ergonomic. Without it, targeting is `/wall @a1b2c3d4`.\n\n### Unix lineage\n\nBSD `wall(1)` — write all — wrote to every logged-in terminal. Biff adds duration-based persistence (status lines persist unlike terminal scroll) and explicit clearing.","status":"open","priority":2,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-16T00:12:40.52862-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-16T22:01:33.693879-08:00","dependencies":[{"issue_id":"biff-klz","depends_on_id":"biff-jfu","type":"blocks","created_at":"2026-02-16T00:16:40.625277-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-klz","depends_on_id":"biff-kds","type":"blocks","created_at":"2026-02-16T12:28:16.399076-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-klz","depends_on_id":"biff-yog","type":"blocks","created_at":"2026-02-16T22:04:02.150157-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-klz","depends_on_id":"biff-bm0","type":"blocks","created_at":"2026-02-16T22:04:02.278762-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-l0v","title":"No session logout on Claude Code exit","description":"When a Claude Code session ends (MCP server shuts down), the session persists in storage indefinitely. app.py lifespan finally block closes the relay connection but does NOT remove the session. LocalRelay: persists forever in sessions.json. NatsRelay: persists for 30 days (KV TTL). Need to delete the session key on server shutdown. The lifespan context manager has access to ServerState (which has user, tty, relay) — the cleanup point is clear. Design question: should this also be a SessionEnd hook that calls a logout tool, or is server lifespan cleanup sufficient?","status":"closed","priority":1,"issue_type":"bug","owner":"jmf@pobox.com","created_at":"2026-02-16T15:02:15.962311-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-16T15:08:45.338824-08:00","closed_at":"2026-02-16T15:08:45.338824-08:00","close_reason":"Closed"}
{"id":"biff-lff","title":"E2E encryption","description":"PyNaCl keypairs (Curve25519), team key distribution. Box encryption for /mesg (true E2E — relay is blind). SecretBox for /plan and /wall (Proton model — relay-trusted). Key generation on first connect, storage in ~/.biff/keys/\u003crepo-hash\u003e.key. Public key registered with relay.\n\nFuture scope — relay works without encryption first.","status":"open","priority":3,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-14T16:37:39.61443-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T16:37:39.61443-08:00","dependencies":[{"issue_id":"biff-lff","depends_on_id":"biff-adp","type":"blocks","created_at":"2026-02-14T16:38:30.492067-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-m2f","title":"/plan command — set working status","description":"Slash command: /plan \u003cmessage\u003e\nMaps to MCP tool: mcp__biff__plan\nArguments: message (required) — what you're working on\nBehavior: Sets your .plan status visible to /who and /finger.\nUnix ancestor: .plan file","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:03:36.912011-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T15:07:37.971392-08:00","closed_at":"2026-02-15T15:07:37.971392-08:00","close_reason":"Implemented in plugins/biff-commands/","dependencies":[{"issue_id":"biff-m2f","depends_on_id":"biff-eap","type":"blocks","created_at":"2026-02-15T09:04:14.097757-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-m2f","depends_on_id":"biff-9g7","type":"blocks","created_at":"2026-02-15T09:04:19.010401-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-mxn","title":"Integration test fixtures (conftest)","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T07:10:34.007203-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T07:11:52.35059-08:00","closed_at":"2026-02-14T07:11:52.35059-08:00","close_reason":"Closed","dependencies":[{"issue_id":"biff-mxn","depends_on_id":"biff-udi","type":"blocks","created_at":"2026-02-14T07:10:40.270436-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-n68","title":"Add --json global flag to CLI","description":"Add --json global flag to CLI for machine-readable output.\n\nAdopts org standard punt-kit-64b. See punt-kit for the standard definition.","status":"open","priority":3,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-17T09:37:41.668488-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-20T09:04:07.94525-08:00"}
{"id":"biff-nmt","title":"CLI entry point with transport flag","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:23:15.479711-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T08:13:00.848753-08:00","closed_at":"2026-02-14T08:13:00.848753-08:00","close_reason":"CLI entry point shipped in PR #5 (biff-x73): typer app with serve command, --transport stdio|http, --user, --data-dir, --host, --port","dependencies":[{"issue_id":"biff-nmt","depends_on_id":"biff-x73","type":"blocks","created_at":"2026-02-13T18:25:09.263904-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-npp","title":"biff install and biff doctor commands","description":"## Problem\n\nThere is no end-user install process for biff. Users have to manually hack plugin symlinks and marketplace entries. The README says `pip install biff-mcp` + `biff install-statusline` but that only installs the MCP server — not the plugin (slash commands like /who, /write, /mesg).\n\n## Reference\n\nSee quarry-mcp (../ocr) for the pattern:\n- `quarry install` — creates data dirs, downloads model, configures MCP via `claude mcp add`\n- `quarry doctor` — read-only environment diagnostics\n- `install.sh` — curl one-liner bootstrap script\n- Implementation: `src/quarry/doctor.py` (CheckResult dataclass, run_install, check_environment)\n\n## Scope\n\n### biff install\n- Register MCP server in Claude Code (`claude mcp add` or direct JSON config)\n- Install the biff plugin into Claude Code's plugin directory\n- Set up status line (absorb current `biff install-statusline` functionality)\n- Idempotent — safe to run multiple times\n\n### biff doctor\n- Check gh auth is working (identity resolution)\n- Check MCP server is configured\n- Check plugin is installed and commands are registered\n- Check status line is configured\n- Check .biff file exists in current repo (optional/warning)\n- Report version info\n\n### biff uninstall\n- Reverse of install: remove MCP server, plugin, restore status line\n- Absorb current `biff uninstall-statusline`\n\n### Cleanup\n- Deprecate/remove `biff install-statusline` and `biff uninstall-statusline` (absorbed into install/uninstall)\n- Update README Quick Start to use `biff install`\n- Update CHANGELOG","status":"closed","priority":1,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-15T23:37:10.826865-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-16T00:21:32.101889-08:00","closed_at":"2026-02-16T00:21:32.101889-08:00","close_reason":"PR #32 created with biff install, doctor, uninstall commands"}
{"id":"biff-o1j","title":"/wall — broadcast command and MCP tool","description":"Implement the /wall command — team broadcast. This requires TWO pieces of work:\n\n1. **MCP tool**: Add a `wall` tool to the biff MCP server that broadcasts a message to all active team members. The tool should call `send_message` to each active user (discovered via `who`), or use a dedicated NATS subject for broadcast.\n\n2. **Plugin command**: Add `plugins/biff-commands/commands/wall.md` that maps `/wall \u003cmessage\u003e` to the new MCP tool.\n\nThe existing biff-ep3 bead covers only the command side; this bead covers both the server-side tool and the client-side command.\n\nAcceptance criteria:\n- `mcp__biff__wall(message)` broadcasts to all active sessions\n- `/wall shipping v0.2` sends the message to every online teammate\n- Shows confirmation with recipient count\n\nDepends on: the biff MCP server having a broadcast mechanism (NATS subject or fan-out via who+send_message).\n\nReferences: PR/FAQ Phase 2 — team commands.","status":"closed","priority":2,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-15T15:07:42.149281-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-16T00:17:11.330231-08:00","closed_at":"2026-02-16T00:17:11.330231-08:00","close_reason":"Superseded by biff-klz which includes duration-based expiry and status line design","dependencies":[{"issue_id":"biff-o1j","depends_on_id":"biff-jfu","type":"blocks","created_at":"2026-02-16T00:16:41.060127-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-ofy","title":"Presence tools: set_plan, who, finger, biff_toggle","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:23:04.126941-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T07:26:25.777671-08:00","closed_at":"2026-02-14T07:26:25.777671-08:00","close_reason":"All presence tools (finger, who, plan, biff toggle) implemented and tested via PR #5 and #6","dependencies":[{"issue_id":"biff-ofy","depends_on_id":"biff-hks","type":"blocks","created_at":"2026-02-13T18:24:50.809895-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-ofy","depends_on_id":"biff-x73","type":"blocks","created_at":"2026-02-13T18:24:53.336978-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-pdl","title":"Local NATS E2E tests","description":"Two MCP servers on same machine communicating through local NATS, proving identical behavior to LocalRelay subprocess tests. Cross-user presence, messaging, plan visibility, biff toggle — all through NATS KV and JetStream instead of filesystem.\n\nThis is the milestone 1 gate: single machine, two MCP servers, NATS relay.\n\nPart of Phase 2 milestone 1: local NATS on single machine.","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T16:37:34.193824-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T19:57:47.425306-08:00","closed_at":"2026-02-14T19:57:47.425306-08:00","close_reason":"PR #18 merged — 9 NATS E2E tests with two MCP servers","dependencies":[{"issue_id":"biff-pdl","depends_on_id":"biff-k0j","type":"blocks","created_at":"2026-02-14T16:38:25.833382-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-pdl","depends_on_id":"biff-59s","type":"blocks","created_at":"2026-02-14T16:38:25.944155-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-q26","title":"Workflow tests with transcript capture","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T07:10:34.241333-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T07:12:44.388839-08:00","closed_at":"2026-02-14T07:12:44.388839-08:00","close_reason":"Closed","dependencies":[{"issue_id":"biff-q26","depends_on_id":"biff-mxn","type":"blocks","created_at":"2026-02-14T07:10:40.490159-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-q26","depends_on_id":"biff-rlv","type":"blocks","created_at":"2026-02-14T07:10:40.597154-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-qj0","title":"Hosted NATS E2E tests hang: session-scoped async fixtures deadlock","description":"The hosted NATS E2E tests (tier 3c, tests/test_hosted_nats/) hang on every run. Zero tests complete. The test suite connects to NATS successfully (JetStream infrastructure appears on the Synadia dashboard) but the first test body never finishes.\n\nRoot cause (narrowed, not yet proven): The hosted conftest uses session-scoped async fixtures (kai_relay, eric_relay) to conserve NATS connections (Synadia starter = 5 max). pytest-asyncio with asyncio_default_test_loop_scope=function creates a per-test event loop, but session-scoped async fixtures need a session-scoped loop. The test module sets loop_scope='session' via pytestmark, but this conflicts with the pyproject.toml default.\n\nThe local NATS E2E tests (tier 3b) work fine because they use function-scoped fixtures — a fresh NatsRelay per test.\n\nEvidence:\n- Raw nats.connect() works (proved with standalone script)\n- JetStream resources appear on Synadia dashboard during test run\n- Tests collect (9 selected) but hang on first test_plan_visible_via_who\n- Local NATS tests: 42/42 pass with function-scoped fixtures\n- Changing asyncio_default_test_loop_scope to session did not fix the hang\n\nImpact: We have zero functional integration tests against the hosted relay. All relay testing is against localhost nats-server. This means hosted-specific issues (TLS, auth, latency, connection limits) are untested.\n\nOptions to investigate:\n1. Convert hosted fixtures to function-scoped (accept more connections per run)\n2. Debug the exact await that hangs (add timeout/logging to _ensure_connected)\n3. Move to pytest-asyncio 1.x session loop handling\n4. Replace session-scoped NatsRelay with a session-scoped raw nats.Client that gets shared","status":"open","priority":1,"issue_type":"bug","owner":"jmf@pobox.com","created_at":"2026-02-17T09:27:48.204188-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-17T09:27:48.204188-08:00"}
{"id":"biff-qo9","title":"/mesg command — send message and toggle availability","description":"Slash command: /mesg @user \u003cmessage\u003e  OR  /mesg on|off\nMaps to MCP tools: mcp__biff__send_message (messaging) and mcp__biff__biff (toggle)\nArguments: \n  - Messaging mode: to (required), message (required)\n  - Toggle mode: enabled (bool)\nBehavior: Send a purposeful async message, or toggle message reception.\nUnix ancestor: mesg / write\n\nDesign decision: Should this be one command with subcommands, or two separate commands (/mesg for sending, /biff for toggle)? The UNIX vocabulary uses mesg for both availability and as the conceptual ancestor of messaging.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:03:37.147679-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T09:04:00.272121-08:00","closed_at":"2026-02-15T09:04:00.272121-08:00","close_reason":"Splitting into /mesg and /biff per PR/FAQ vocabulary"}
{"id":"biff-qow","title":"/who command — list active sessions","description":"Slash command: /who\nMaps to MCP tool: mcp__biff__who\nArguments: none\nBehavior: Shows all active biff sessions with usernames and plan messages.\nUnix ancestor: who / w","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:03:36.79299-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T15:07:38.003437-08:00","closed_at":"2026-02-15T15:07:38.003437-08:00","close_reason":"Implemented in plugins/biff-commands/","dependencies":[{"issue_id":"biff-qow","depends_on_id":"biff-eap","type":"blocks","created_at":"2026-02-15T09:04:13.983987-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-qow","depends_on_id":"biff-9g7","type":"blocks","created_at":"2026-02-15T09:04:18.894043-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-qra","title":"/last command","description":"## Design: /last — session history (wtmp)\n\nFaithful to Unix `last(1)`, which reads the wtmp file to show login/logout history. This is about **sessions**, not messages.\n\n### Unix Model Mapping\n\n| Unix File | What It Stores | Biff Equivalent | Command |\n|-----------|---------------|-----------------|---------|\n| utmp (`/var/run/utmp`) | Who is logged in NOW | NATS KV `biff-{repo}-sessions` | `/who` |\n| wtmp (`/var/log/wtmp`) | Historical login/logout log | **New**: JetStream stream `biff-{repo}-wtmp` | **`/last`** |\n| lastlog (`/var/log/lastlog`) | Last login per user | Derivable from wtmp stream | `/finger` |\n\n### NATS Primitives\n\nTwo primitives, one per file:\n\n- **KV bucket** (existing) — `biff-{repo}-sessions` — stores `UserSession` records with 3-day TTL (liveness grace period for laptop-closed scenarios). This is utmp. Powers `/who`.\n- **JetStream stream** (new) — `biff-{repo}-wtmp` — append-only event log with `LIMITS` retention and **30-day `max_age`**. This is wtmp. Powers `/last`.\n\n### Event Model\n\n```python\nclass SessionEvent(BaseModel):\n    model_config = ConfigDict(frozen=True)\n\n    user: str               # \"kai\"\n    tty: str                # hex session ID\n    tty_name: str           # \"tty1\"\n    host: str               # \"kais-mbp\"\n    directory: str          # working directory at time of event\n    plan: str               # plan at time of event\n    event: Literal[\"login\", \"logout\"]\n    timestamp: datetime     # login: session start time; logout: last_active time\n```\n\n### Event Sources\n\n- **login**: Appended when session registers in KV (server startup)\n- **logout (graceful)**: Appended on server shutdown. Timestamp = last_active.\n- **logout (TTL expiry)**: Appended by a **KV watcher** that observes key deletions. When a KV key expires or is deleted, the watcher appends a logout event using the session's `last_active` as the timestamp — NOT the TTL expiry moment. The 3-day TTL is a liveness grace period, not session duration. Actual session duration = `last_active - login_time`.\n\nExample: engineer logs in at 9am, works until 11am (last_active=11am), closes laptop. KV key TTLs 3 days later. /last shows:\n```\nkai      tty1   kais-mbp       Feb 22 09:00 - 11:00  (02:00)\n```\n\n### KV Watcher\n\nA background task (similar to `poll_inbox`) that watches the sessions KV bucket for delete events. On each delete:\n1. Deserialize the deleted value to get the `UserSession` (NATS KV delete events include the last value)\n2. Extract `last_active` as the logout timestamp\n3. Append a logout `SessionEvent` to the wtmp stream\n\nThis ensures every login gets a matching logout, whether graceful or TTL-based — mirroring how Unix init writes the logout record to wtmp when a process exits.\n\n### Retention Policy\n\n| Resource | Retention | Value | Purpose |\n|----------|-----------|-------|---------|\n| KV sessions | TTL per key | 3 days | Liveness grace (laptop closed) |\n| wtmp stream | `max_age` | 30 days | Historical session log |\n| wtmp stream | `max_bytes` | TBD (10-50 MiB) | Size cap |\n\n### /last Output\n\nReverse chronological. Cross-references wtmp (events) with utmp (KV, for \"still logged in\"):\n\n```\n/last\n\nkai      tty1   kais-mbp       Feb 22 09:14   still logged in\neric     tty1   erics-mbp      Feb 22 08:45 - 09:30  (00:45)\nkai:w1   tty2   kais-mbp       Feb 22 08:20 - 09:14  (00:54)\nmaya     tty1   mayas-mbp      Feb 22 08:15 - 08:22  (00:07)\nkai      tty2   kais-mbp       Feb 22 08:00 - 08:20  (00:20)\n```\n\n### Filtering (matches Unix last flags)\n\n- `/last` — default 10 entries\n- `/last kai` — sessions for user kai\n- `/last tty1` — sessions on tty1\n- `/last kai tty2` — kai on tty2\n- `/last -20` — last 20 entries\n\n### Future: Teleport + Agent Teams visibility\n\nWith the Teleport bridge and Agent Teams bridge (see research/agentic-engineering-landscape-2026.md), `/last` shows the full picture:\n\n```\nkai         tty1     kais-mbp       Feb 22 09:14   still logged in\nkai:remote  —        claude.ai      Feb 22 09:10   still logged in\neric        tty1     erics-mbp      Feb 22 08:45 - 09:30  (00:45)\nkai:w1      tty2     kais-mbp       Feb 22 08:20 - 09:14  (00:54)\n@ox         —        sageox.ai      Feb 22 08:00   still logged in\n```\n\n### What /last Is NOT\n\n- Not message history (POP semantics unchanged, DES-006 stands)\n- Not a task log (beads handles work tracking)\n- Not a chat archive\n\nIt is the session ledger: who was here, when, for how long.\n\n### Implementation Notes\n\n- KV watcher needs access to the deleted value to extract `last_active`. NATS KV watch events for deletes include the last revision — verify this in nats.py client.\n- The watcher should run on every connected biff server (idempotent — duplicate logout events for same session can be deduplicated by session key + event type).\n- LocalRelay equivalent: append to a local wtmp JSONL file. Lower priority — LocalRelay is a testing harness.\n\n### Priority\n\nP3 — completes the BSD vocabulary triad (utmp/wtmp/lastlog → /who, /last, /finger) and is the natural foundation for the Teleport and Agent Teams bridge designs.","status":"closed","priority":3,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-16T17:44:03.032632-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-22T14:02:03.08778-08:00","closed_at":"2026-02-22T14:02:03.08778-08:00","close_reason":"Shipped in PR #49 (v0.5.0)","dependencies":[{"issue_id":"biff-qra","depends_on_id":"biff-yog","type":"blocks","created_at":"2026-02-16T22:04:02.408969-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-rlv","title":"MCP protocol integration tests","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T07:10:34.124524-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T07:12:19.881406-08:00","closed_at":"2026-02-14T07:12:19.881406-08:00","close_reason":"Closed","dependencies":[{"issue_id":"biff-rlv","depends_on_id":"biff-mxn","type":"blocks","created_at":"2026-02-14T07:10:40.380993-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-roa","title":"Enriched presence: host, directory, bead in /who","description":"## Problem\n\nWhen multiple agents work in the same repository, they need to distinguish between two kinds of overlap:\n\n1. **Logical overlap** (same bead) — bad regardless of machine. Prevented by seeing each other's /plan.\n2. **Physical overlap** (same host + directory) — causes git working tree conflicts. Only matters when agents share the same filesystem.\n\nCurrently /who shows name, idle, status, and plan. It lacks the physical context needed to detect filesystem conflicts.\n\n## Solution\n\n### Enhanced Presence Data\n\nAdd to the NATS presence payload:\n- `hostname` — machine identifier\n- `pwd` — current working directory\n- `git_root` — git repository root (if in a git repo)\n- `branch` — current git branch\n\n### Enhanced /who Output\n\n```\n▶  NAME    HOST       DIR                  PLAN\n   @kai    macbook    ~/Coding/biff        biff-bf8: workflow toggle\n   @eric   macbook    ~/Coding/biff        biff-bf9: enriched presence\n                      ⚠ same host+dir\n   @dana   server-2   ~/Coding/biff        biff-bf3: relay refactor\n```\n\n- Flag `⚠ same host+dir` when two sessions share hostname AND directory/git_root\n- Same repo on different hosts = no flag (separate filesystems)\n\n### /plan Shows Bead Context\n\nWhen an agent sets /dotplan after claiming a bead, the plan text includes the bead ID and title. This is the cross-machine coordination layer — everyone sees what logical work each agent owns.\n\n### Coordination via /write\n\nWhen an agent detects a same-host+dir conflict via /who, it uses /write to directly coordinate with the other agent. The /write notification arrives as a push (tool name change notification mechanism), not passive inbox. AGENTS.md instructs agents to:\n- Check /who when claiming work\n- /write colliding agents to coordinate\n- Create git worktrees when sharing a filesystem\n- Act on /write notifications about workspace conflicts before next file operation\n\n### Two Coordination Planes\n\n| Plane | Scope | Tool | Detects | Action |\n|-------|-------|------|---------|--------|\n| Logical | Cross-machine | /plan + /who | Same bead claimed twice | Don't duplicate work |\n| Physical | Same machine | /who (host+dir) + /write | Same working tree | Create worktree |\n\n/wall stays clean for team announcements (PR created, merged, released). Physical coordination uses /who + /write between the specific agents involved.\n\n## Implementation Notes\n\n- Presence data published to NATS on session start and on branch switch\n- hostname from `os.uname().nodename` or equivalent\n- pwd from session environment\n- git_root/branch from `git rev-parse` at publish time\n- Collision detection is server-side: /who response includes flags\n- Agents cannot read the status bar but DO receive tool name change notifications — this is how /write functions as push\n\n## Acceptance Criteria\n\n- [ ] Presence payload includes hostname, pwd, git_root, branch\n- [ ] /who displays host and directory columns\n- [ ] /who flags same-host+dir overlaps\n- [ ] /plan integrates with bead context (shows bead ID + title)\n- [ ] /write notification serves as push coordination mechanism\n- [ ] AGENTS.md (from biff-bf8) includes worktree guidance for physical conflicts","status":"closed","priority":2,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-16T12:13:27.976824-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-16T23:18:34.612973-08:00","closed_at":"2026-02-16T23:18:34.612973-08:00","close_reason":"Superseded. Core presence work (hostname/pwd in payload, HOST/DIR columns in /who) already built. Remaining items decomposed into focused beads: biff-5zq (plan bead expansion), biff-bf8 (AGENTS.md + workflow toggle), biff-9pl (collision detection, git_root/branch, /write coordination).","dependencies":[{"issue_id":"biff-roa","depends_on_id":"biff-2lc","type":"blocks","created_at":"2026-02-16T12:17:14.830794-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-roa","depends_on_id":"biff-kds","type":"blocks","created_at":"2026-02-16T12:28:14.792613-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-sfh","title":"/mesg command missing from top-level plugin commands","description":"Only /biff:mesg is available, not /mesg. The top-level command alias is missing from the plugin configuration, so users must use the fully-qualified name.","status":"closed","priority":2,"issue_type":"bug","owner":"jmf@pobox.com","created_at":"2026-02-16T17:51:03.456289-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-16T22:48:40.484529-08:00","closed_at":"2026-02-16T22:48:40.484529-08:00","close_reason":"Renamed ~/.claude/commands/biff.md to mesg.md — /mesg now available as top-level command"}
{"id":"biff-sm7","title":"Claude Code SDK acceptance tests: verify UI-level experience","description":"Use @anthropic-ai/claude-code-sdk to programmatically drive two Claude Code sessions with biff configured as MCP server. Verify: (1) cross-user visibility works through Claude's tool calls (plan, who, finger), (2) presence lifecycle end-to-end (biff on/off visible across sessions). Spike on SDK capabilities first.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T08:17:38.410102-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T10:15:47.439272-08:00","closed_at":"2026-02-14T10:15:47.439272-08:00","close_reason":"Closed","dependencies":[{"issue_id":"biff-sm7","depends_on_id":"biff-al5","type":"blocks","created_at":"2026-02-14T08:17:44.868349-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-udi","title":"Transcript data model and renderer","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T07:10:33.892921-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T07:11:32.169306-08:00","closed_at":"2026-02-14T07:11:32.169306-08:00","close_reason":"Closed"}
{"id":"biff-w5y","title":"Transcript file output and pytest marker","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T07:10:34.355482-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T07:15:12.557435-08:00","closed_at":"2026-02-14T07:15:12.557435-08:00","close_reason":"Closed","dependencies":[{"issue_id":"biff-w5y","depends_on_id":"biff-q26","type":"blocks","created_at":"2026-02-14T07:10:40.703628-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-x73","title":"MCP server scaffold with HTTP/stdio transport","status":"closed","priority":0,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:23:01.66618-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T06:36:30.52152-08:00","closed_at":"2026-02-14T06:36:30.52152-08:00","close_reason":"PR #5 merged — server scaffold complete","dependencies":[{"issue_id":"biff-x73","depends_on_id":"biff-jge","type":"blocks","created_at":"2026-02-13T18:24:48.320616-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-yk1","title":"Update prfaq and README competitive positioning: name Agent Teams, SageOx, and the four-layer model","description":"The competitive landscape has clarified into four distinct layers: Context/Memory (SageOx), Communication/Presence (biff), Work Tracking (beads), Session Coordination (Agent Teams). Update the prfaq competitors FAQ and README to explicitly name Claude Code Agent Teams, SageOx, and Entire.io, draw the layer boundaries, and sharpen biff's unique position as the only tool where you can ask 'who is working on this repo right now?' and get humans + agents, then message them.\n\nEntire.io (Dohmke, $60M seed): code governance/transparency layer — Checkpoints show what agents built, not who is working or how to reach them. Already cited in prfaq but needs explicit layer placement.\n\nSources: https://code.claude.com/docs/en/agent-teams, https://sageox.ai/blog/introducing-sageox, https://entire.io/blog/hello-entire-world, research/research-2026-02-17-agent-coordination-landscape.md","status":"open","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-21T08:57:05.414251-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-21T08:57:12.689288-08:00"}
{"id":"biff-yl1","title":"Per-project unread counts in statusline","description":"Currently ~/.biff/unread.json is a single global file. When running biff across multiple projects, whichever server wrote last wins. Unread counts should be per-project (matching the per-repo data dir architecture). The statusline should aggregate all projects, showing counts per project when multiple have unreads: e.g. 'biff(2) myapp(1)'. Requires: (1) server writes to ~/.biff/unread/{repo-name}.json instead of global file, (2) statusline scans all files in ~/.biff/unread/ and renders per-project segments.","status":"closed","priority":2,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-15T10:31:33.121616-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T11:30:39.45077-08:00","closed_at":"2026-02-15T11:30:39.45077-08:00","close_reason":"Closed"}
{"id":"biff-yog","title":"Fix messaging for multi-TTY: per-user inbox, not per-session","description":"## Problem\n\nPR #35 moved inboxes from per-user to per-session (user:tty). This broke messaging:\n\n1. **Offline delivery lost.** Broadcast write looks up active sessions and drops if none exist.\n2. **Message duplication.** Broadcast to N sessions creates N copies.\n3. **Orphaned messages.** When a session exits, its unread messages are lost.\n\n## Design (decided 2026-02-16)\n\n### Command semantics: /write = mailbox, /wall = banner\n\n- `/write` delivers to **mailboxes**. Durable. Consumed via `/read`. POP semantics (first reader consumes).\n- `/wall` delivers to **terminals**. Immediate visibility on status bar + tool descriptions. TTL-based expiry. See biff-klz.\n\n### /write addressing\n\n| Address | Target | Behavior |\n|---------|--------|----------|\n| `/write @eric \"msg\"` | User mailbox | POP — first session to `/read` consumes it. Persists offline. |\n| `/write @eric:agent1 \"msg\"` | TTY mailbox | POP — only that session sees it via `/read`. Persists if agent busy. |\n\n`@` is the universal addressing sigil. No colon = user mailbox. Colon = TTY mailbox.\n\n**POP means read-once.** If eric has 3 sessions and one calls `/read`, the message is consumed. Other sessions do not see it. To reach all terminals simultaneously, use `/wall`.\n\n### Per-user mailbox (restore from pre-TTY)\n\nSingle inbox per user. `deliver()` writes to `inbox-{user}.jsonl` when `to_user` has no colon. No session lookup, no fan-out, no drop-if-offline. Messages wait until read.\n\n### Per-TTY mailbox (already implemented)\n\n`deliver()` already writes to `inbox-{user}-{tty}.jsonl` when `to_user` contains colon. No change needed.\n\n### /read merges both sources\n\n`/read` in any session fetches from:\n1. The user mailbox (broadcasts sent to `@user`)\n2. The current session's TTY mailbox (targeted messages sent to `@user:tty`)\n\nReturns both sorted by timestamp. Marks all returned messages as read.\n\nUnread count (status bar + tool description) = user mailbox unread + TTY mailbox unread.\n\n### What needs to be built\n\n1. **Relay: `deliver()`** — write to per-user inbox when `to_user` has no colon. No session lookup.\n2. **Relay: `fetch_broadcasts(user)`** — new method returning unread broadcast messages for a user.\n3. **`/read` tool** — merge `fetch(session_key)` + `fetch_broadcasts(user)`.\n4. **`get_unread_summary()`** — sum both sources.\n5. **Tests** — agent receives targeted message, agent receives broadcast, both appear in `/read`, unread count sums both.\n\n### Dependencies\n\n- **biff-bm0** (`/tty \u003cname\u003e`) — required for ergonomic TTY addressing. Without it, targeting is `/write @eric:a1b2c3d4`. With it: `/write @eric:agent1`.\n\n### Example\n\n```\n# Human tells specific agent to pause\n/write @eric:agent2 \"pause work, reviewing API design\"    → agent2's TTY mailbox\n\n# Agent notifies human\n/write @eric:human-tty \"auth module ready for review\"     → human's TTY mailbox\n\n# Agent coordinates with another agent\n/write @eric:agent1 \"tests depend on auth, ETA?\"          → agent1's TTY mailbox\n\n# Human sends to user mailbox (first session to /read gets it)\n/write @eric \"PR #35 approved\"                            → eric's user mailbox (POP)\n```","status":"closed","priority":1,"issue_type":"bug","owner":"jmf@pobox.com","created_at":"2026-02-16T20:51:08.155666-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-16T22:42:29.134358-08:00","closed_at":"2026-02-16T22:42:29.134358-08:00","close_reason":"PR #36 merged: per-user mailbox + dual-inbox /read"}
{"id":"biff-zi8","title":"Reassess LocalRelay after NATS-focused development","description":"Recent development has focused on NatsRelay (namespace scoping DES-007/007a, per-user mailboxes DES-013, long-lived sessions DES-008). LocalRelay may have drifted out of sync with these changes or accumulated dead code paths.\n\nReview checklist:\n- Does LocalRelay implement the same mailbox semantics as NatsRelay (user + TTY inboxes, DES-013)?\n- Does the slug-based namespace (DES-007a) affect local data directory layout?\n- Are session TTLs and idle-time semantics (DES-008) consistent between relays?\n- Is there dead code from early development that never applied to LocalRelay?\n- Do integration tests cover LocalRelay at parity with NatsRelay?\n- Does sanitize_repo_name matter for LocalRelay paths (filesystem vs NATS subject constraints)?\n\nThis is a review/audit task, not a rewrite. Goal is to identify gaps and file follow-up issues for anything that needs fixing.","status":"open","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-17T08:37:48.587201-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-17T08:37:59.335226-08:00"}
