{"id":"biff-0wx","title":"/mesg command — send async message","description":"Slash command: /mesg @user \"text\"\nMaps to MCP tool: mcp__biff__send_message\nArguments: to (user), message (text)\nBehavior: Send a one-way async message. Recipient reads when they choose (POP semantics).\nAlso surfaces check_messages on the receiving end.\nUnix ancestor: mesg (BSD)\nPR/FAQ: Phase 1 Must Have","status":"open","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:04:08.909904-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T09:04:08.909904-08:00","dependencies":[{"issue_id":"biff-0wx","depends_on_id":"biff-eap","type":"blocks","created_at":"2026-02-15T09:04:14.323771-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-0wx","depends_on_id":"biff-9g7","type":"blocks","created_at":"2026-02-15T09:04:19.233369-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-10u","title":"Fix: fire notifications/tools/list_changed on description mutation","description":"The check_messages tool description is mutated when unread messages arrive, but notifications/tools/list_changed is never sent to Claude Code. This means Claude never re-reads the tool list and never sees the updated description.\n\nTwo paths need fixing:\n1. Belt (after tool calls): refresh_check_messages runs inside a tool handler where Context is available. Queue the notification via context._queue_tool_list_changed().\n2. Suspenders (background poll): poll_inbox runs in a background asyncio.Task outside any request context. Needs direct session access to call session.send_tool_list_changed().\n\nThe PR/FAQ (line 480) says this was validated by spike, but the current implementation silently mutates without notifying.\n\nFiles: src/biff/server/tools/_descriptions.py, possibly src/biff/server/app.py","status":"closed","priority":1,"issue_type":"bug","owner":"jmf@pobox.com","created_at":"2026-02-15T09:09:24.762251-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T09:22:41.891134-08:00","closed_at":"2026-02-15T09:22:41.891134-08:00","close_reason":"Fixed in PR #21 — notifications/tools/list_changed now fires on description mutation"}
{"id":"biff-37y","title":"Messaging tools: send_message, check_messages","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:23:07.148638-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T11:24:05.210324-08:00","closed_at":"2026-02-14T11:24:05.210324-08:00","close_reason":"Closed","dependencies":[{"issue_id":"biff-37y","depends_on_id":"biff-hks","type":"blocks","created_at":"2026-02-13T18:24:55.910212-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-37y","depends_on_id":"biff-x73","type":"blocks","created_at":"2026-02-13T18:24:58.543761-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-4rg","title":"Phase 1: Core MCP server","description":"Implement the foundational biff commands as an MCP server.\n\nCommands: /mesg, /who, /plan, /finger, /biff on|off\nLocal relay for same-machine communication.\nSingle-user value from /plan and session awareness.\n.biff file configuration (relay URL, whitelisted IDs).\n\nExit criteria: an engineer can install biff, set their plan, see active sessions, and send a message to a teammate on the same machine.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T15:25:20.011554-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T16:28:12.962472-08:00","closed_at":"2026-02-14T16:28:12.962472-08:00","close_reason":"All exit criteria met: presence tools, messaging, .biff config, local relay, subprocess tests. Shipped in PRs #10-15.","labels":["epic","phase"],"dependencies":[{"issue_id":"biff-4rg","depends_on_id":"biff-6k7","type":"blocks","created_at":"2026-02-13T16:39:51.110286-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-541","title":"/biff command — toggle message reception","description":"Slash command: /biff on | /biff off\nMaps to MCP tool: mcp__biff__biff\nArguments: enabled (bool)\nBehavior: Control whether you receive messages. When off, incoming messages are queued.\nUnix ancestor: biff (BSD)\nPR/FAQ: Phase 1 Must Have","status":"open","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:04:09.031484-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T09:04:09.031484-08:00","dependencies":[{"issue_id":"biff-541","depends_on_id":"biff-eap","type":"blocks","created_at":"2026-02-15T09:04:14.434561-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-541","depends_on_id":"biff-9g7","type":"blocks","created_at":"2026-02-15T09:04:19.347141-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-59s","title":"Relay selection + config plumbing","description":"Add relay_url field to .biff config. Update biff serve startup to select LocalRelay vs NatsRelay based on config. When relay_url is present, connect to NATS; otherwise use filesystem relay.\n\nMay fold into NatsRelay implementation if scope is small enough.\n\nPart of Phase 2 milestone 1: local NATS on single machine.","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T16:37:31.696777-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T18:22:09.996955-08:00","closed_at":"2026-02-14T18:22:09.996955-08:00","close_reason":"Closed","dependencies":[{"issue_id":"biff-59s","depends_on_id":"biff-k0j","type":"blocks","created_at":"2026-02-14T16:38:23.692244-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-5zq","title":"/plan auto-expands beads IDs to include issue title","description":"When a user passes a beads ID to /plan (e.g. /plan biff-x73), detect the ID pattern and auto-expand it to include the issue title: 'biff-x73: MCP server scaffold with HTTP/stdio transport'. Requires the plan tool to shell out to bd show or read .beads/issues.jsonl to resolve the title. Falls back gracefully to the raw string if the ID doesn't match a known issue.","status":"open","priority":3,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-14T08:03:27.188798-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T08:03:34.029865-08:00"}
{"id":"biff-6k7","title":"Spike: MCP notification rendering and subprocess handoff","description":"Validate two critical feasibility questions before committing to the full Phase 1 implementation.\n\n**Question 1: MCP notifications for receiving messages**\nCan an MCP server push a notification to Claude Code that renders visibly in the terminal? Test:\n- Create a minimal MCP server that fires a notification after a delay\n- Verify it appears in the Claude Code session without a tool call\n- Assess rendering quality (plain text? formatted? inline with conversation?)\n\n**Question 2: Subprocess handoff for /talk**\nCan an MCP server spawn an interactive subprocess that takes over terminal I/O, then return control to Claude Code cleanly? Test:\n- MCP tool call spawns a simple interactive process (e.g., a chat loop)\n- User types directly to the subprocess (no LLM intermediation)\n- Process exits, Claude Code resumes normally\n- Assess the UX transition (seamless or jarring?)\n\n**Exit criteria:**\n- Clear yes/no on both questions with evidence\n- If notifications work: document the API and rendering constraints\n- If subprocess handoff works: document the mechanism and UX quality\n- If either fails: document alternatives and revised approach for /mesg and /talk\n\n**Timeframe:** 1-2 days","notes":"Spike results (2026-02-13):\n\nQ1 (MCP notifications render?): NO - notifications/message silently dropped by Claude Code (issue #3174, closed not planned).\nQ2 (Subprocess handoff?): NO - stdio transport reserves stdout for JSON-RPC, no PTY allocation.\n\nALTERNATIVE DISCOVERED: HTTP transport + tools/list_changed\n- FastMCP HTTP transport works (Streamable HTTP + SSE)\n- Dynamic tool descriptions update via remove_tool/re-register\n- notifications/tools/list_changed automatically sent on SSE channel\n- Server-side validated via curl (all 5 checks pass)\n- Same pattern used by Slack MCP server in production\n- Claude Code end-to-end test pending (needs new session)\n\nRECOMMENDATION: Proceed with HTTP transport architecture for Phase 1.\nArchitecture documented in docs/prd/biff-phase1-communication.md and docs/sparc/phase1-implementation.md","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T16:39:47.189963-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-13T18:44:55.620389-08:00","closed_at":"2026-02-13T18:44:55.620389-08:00","close_reason":"Server-side validation complete. All 5 checks pass. HTTP transport + tools/list_changed is viable. Architecture recommendation: proceed with HTTP transport. Claude Code e2e test deferred to new session.","labels":["phase-1","spike"]}
{"id":"biff-6re","title":"GitHub identity + auth","description":"GitHub OAuth token auth to relay. Relay verifies team membership by reading .biff from repo. Public key directory managed by relay. Commit access is the trust boundary — GitHub username is identity.\n\nFuture scope — depends on encryption layer being in place.","status":"open","priority":3,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-14T16:37:41.595963-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T16:37:41.595963-08:00","dependencies":[{"issue_id":"biff-6re","depends_on_id":"biff-lff","type":"blocks","created_at":"2026-02-14T16:38:31.98322-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-7lc","title":"/check command — check inbox for messages","description":"Slash command: /check\nMaps to MCP tool: mcp__biff__check_messages\nArguments: none\nBehavior: Check and consume pending messages (POP semantics).\nNaming: /check is shorter and more natural than /check_messages as a slash command.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:03:37.263469-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T09:04:00.382548-08:00","closed_at":"2026-02-15T09:04:00.382548-08:00","close_reason":"check_messages is not a PR/FAQ command — message consumption is part of /mesg flow"}
{"id":"biff-860","title":"Remote NATS connection","description":"TLS connection support for remote NATS servers. Authentication via token, nkey, or creds file. Reconnect/retry handling for network interruptions. Configuration in .biff for remote NATS endpoint (Synadia Cloud or self-hosted).\n\nPart of Phase 2 milestone 2: hosted nats.io across machines.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T16:37:35.846801-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T07:05:32.529042-08:00","closed_at":"2026-02-15T07:05:32.529042-08:00","close_reason":"PR #19 merged — remote NATS connection with auth and reconnect","dependencies":[{"issue_id":"biff-860","depends_on_id":"biff-pdl","type":"blocks","created_at":"2026-02-14T16:38:27.707961-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-8t3","title":"Phase 3: Real-time conversation, pairing, and security","description":"Add synchronous communication and the session-sharing feature.\n\nCommands: /talk, /pair\n/talk: real-time bidirectional text conversation between two terminals (model-mediated message exchange, not subprocess handoff).\n/pair: invite a teammate to send input to your Claude Code session with explicit consent model.\nSecurity audit of the encryption model (introduced in Phase 2) and the /pair permission model.\n\nExit criteria: two engineers can hold a real-time conversation and pair on a Claude session with proper consent. Security audit confirms encryption and permission models are sound.","status":"open","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T15:25:32.868851-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T13:24:24.308784-08:00","labels":["epic","phase"],"dependencies":[{"issue_id":"biff-8t3","depends_on_id":"biff-iok","type":"blocks","created_at":"2026-02-13T16:23:56.138756-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-8xu","title":".biff config file parser","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:22:57.816895-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T14:43:31.832376-08:00","closed_at":"2026-02-14T14:43:31.832376-08:00","close_reason":"PR #15: .biff TOML config with team roster, relay URL, git identity, data dir","dependencies":[{"issue_id":"biff-8xu","depends_on_id":"biff-jge","type":"blocks","created_at":"2026-02-13T18:24:45.991178-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-9g7","title":"Epic: Claude Code plugin for biff slash commands","description":"Create a Claude Code plugin that exposes all biff MCP tools as slash commands matching the UNIX communication vocabulary. Users should be able to type /who, /plan, /finger, /mesg, /wall etc. instead of asking Claude to call tools.\n\nThe plugin wraps the existing biff MCP server tools — no new backend logic needed. Each slash command maps 1:1 to an MCP tool call.\n\nAcceptance criteria:\n- Plugin scaffold (plugin.json, directory structure)\n- All implemented tools exposed as slash commands\n- Commands work in any Claude Code instance with biff MCP server configured\n- Commands match the UNIX vocabulary from CLAUDE.md","status":"open","priority":1,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-15T09:02:58.209327-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T09:02:58.209327-08:00"}
{"id":"biff-9xj","title":"Message watcher + dynamic tool descriptions","status":"closed","priority":0,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:23:10.132345-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T12:29:53.576834-08:00","closed_at":"2026-02-14T12:29:53.576834-08:00","close_reason":"PR #13 merged. Dynamic check_messages descriptions implemented with refresh on every tool call.","dependencies":[{"issue_id":"biff-9xj","depends_on_id":"biff-x73","type":"blocks","created_at":"2026-02-13T18:25:01.266105-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-9xj","depends_on_id":"biff-37y","type":"blocks","created_at":"2026-02-13T18:25:03.821906-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-adp","title":"Hosted NATS E2E tests","description":"Tests against a real Synadia Cloud / nats.io hosted account. Verifies cross-machine messaging, presence, and session management work identically to local NATS tests.\n\nThis is the milestone 2 gate: hosted account, across machines.\n\nPart of Phase 2 milestone 2: hosted nats.io across machines.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T16:37:37.444-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T08:42:47.586303-08:00","closed_at":"2026-02-15T08:42:47.586303-08:00","close_reason":"Hosted NATS E2E tests merged in PR #20","dependencies":[{"issue_id":"biff-adp","depends_on_id":"biff-860","type":"blocks","created_at":"2026-02-14T16:38:29.015085-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-al5","title":"Multi-process transport tests: two biff serve subprocesses over stdio","description":"Spawn two real biff serve processes (--user kai, --user eric, same --data-dir) connected over stdio. Exercise MCP wire protocol through actual pipes, not FastMCPTransport. Catches serialization bugs, process lifecycle issues, stdio framing. Use subprocess + MCP client library to connect. Generates transcripts like E2E tests but with real transport.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T08:17:35.89207-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T09:00:53.43409-08:00","closed_at":"2026-02-14T09:00:53.43409-08:00","close_reason":"Subprocess tests shipped in PR #9: 15 tests over StdioTransport, cross-process state verified"}
{"id":"biff-b01","title":"Integration tests + quality gates","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:23:18.145377-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T16:28:57.177779-08:00","closed_at":"2026-02-14T16:28:57.177779-08:00","close_reason":"199 tests pass across 4 tiers (unit, integration, subprocess, SDK). Quality gates (ruff, mypy, pyright) all green. All dependent feature beads shipped with tests.","dependencies":[{"issue_id":"biff-b01","depends_on_id":"biff-ofy","type":"blocks","created_at":"2026-02-13T18:25:11.749375-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-b01","depends_on_id":"biff-37y","type":"blocks","created_at":"2026-02-13T18:25:14.358111-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-b01","depends_on_id":"biff-9xj","type":"blocks","created_at":"2026-02-13T18:25:17.058179-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-bgh","title":"/finger command — check user status","description":"Slash command: /finger @user\nMaps to MCP tool: mcp__biff__finger\nArguments: user (required) — username to query\nBehavior: Shows detailed status for a specific user.\nUnix ancestor: finger","status":"open","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:03:37.031204-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T09:03:37.031204-08:00","dependencies":[{"issue_id":"biff-bgh","depends_on_id":"biff-eap","type":"blocks","created_at":"2026-02-15T09:04:14.211769-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-bgh","depends_on_id":"biff-9g7","type":"blocks","created_at":"2026-02-15T09:04:19.121194-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-bv5","title":"Phase 4: Hosted relay service (biff teams)","description":"Launch the managed biff teams offering on top of the Supabase relay (Phase 2).\n\nSince the relay IS a Supabase project, the \"hosted\" story is largely solved by Phase 2. Phase 4 adds the operational and commercial layer:\n\n- Default hosted Supabase project managed by biff (the free/public relay)\n- Team isolation via Supabase RLS policies and per-team channels\n- Audit logs via Postgres queries on the messages table\n- Admin controls: team membership, permissions, onboarding/offboarding\n- End-to-end encryption (client-side, keys managed outside Supabase)\n- Compliance exports (message history, audit trails)\n- Billing integration if needed (usage-based on message volume)\n- 99.9% uptime — inherited from Supabase Pro plan\n\nSelf-hosted teams skip this entirely — they manage their own Supabase project.\n\nExit criteria: a team can sign up for biff teams, get a managed relay with admin controls, audit logging, and encryption.","status":"open","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T15:25:39.154258-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T12:23:13.194254-08:00","labels":["epic","phase"],"dependencies":[{"issue_id":"biff-bv5","depends_on_id":"biff-8t3","type":"blocks","created_at":"2026-02-13T16:23:56.228225-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-czx","title":"Spike: validate tools/list_changed in Claude Code","notes":"Server-side validation complete (5/5 checks pass). Remaining: Claude Code e2e test — does Claude Code act on notifications/tools/list_changed and show updated tool descriptions? Requires session restart with biff-spike registered in .mcp.json.","status":"closed","priority":0,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:23:13.074042-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-13T18:57:29.643458-08:00","closed_at":"2026-02-13T18:57:29.643458-08:00","close_reason":"E2E validated: Claude Code acts on tools/list_changed. Dynamic tool descriptions update in real-time. Full chain confirmed: simulate_message → remove/re-register tool → list_changed notification on SSE → Claude Code refreshes → updated description visible to Claude."}
{"id":"biff-eap","title":"Scaffold biff Claude Code plugin","description":"Create the plugin directory structure and plugin.json manifest.\n\nStructure:\n  plugins/biff-commands/\n    plugin.json         — manifest with name, version, description, commands list\n    commands/           — slash command definitions\n    skills/             — skill definitions (if needed)\n\nThe plugin must reference the biff MCP server tools. Each command will be a skill file that instructs Claude to call the corresponding biff MCP tool.\n\nAcceptance criteria:\n- plugin.json validates correctly\n- Plugin can be loaded by Claude Code (local install or symlink)\n- Directory structure follows Claude Code plugin conventions","status":"open","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:03:05.968828-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T09:03:05.968828-08:00","dependencies":[{"issue_id":"biff-eap","depends_on_id":"biff-9g7","type":"blocks","created_at":"2026-02-15T09:04:18.783178-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-ep3","title":"/wall command — team broadcast","description":"Slash command: /wall \"text\"\nMaps to MCP tool: TBD (not yet implemented as MCP tool)\nBehavior: Broadcast a message to your team or hive.\nUnix ancestor: wall (BSD)\nPR/FAQ: Phase 2 Should Have\nNote: MCP tool backend needs to be built first — this task is plugin-side only, blocked until backend exists.","status":"open","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:04:09.149656-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T09:04:09.149656-08:00","dependencies":[{"issue_id":"biff-ep3","depends_on_id":"biff-eap","type":"blocks","created_at":"2026-02-15T09:04:14.545303-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-ep3","depends_on_id":"biff-9g7","type":"blocks","created_at":"2026-02-15T09:04:19.464517-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-hks","title":"Storage layer: inbox.py and sessions.py","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:22:55.326517-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T05:34:52.008196-08:00","closed_at":"2026-02-14T05:34:52.008196-08:00","close_reason":"MessageStore + SessionStore with 35 tests. JSONL/JSON backed, atomic writes, malformed data recovery.","dependencies":[{"issue_id":"biff-hks","depends_on_id":"biff-jge","type":"blocks","created_at":"2026-02-13T18:24:42.996974-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-iok","title":"Phase 2: Network relay and team commands","description":"Enable cross-machine messaging and team-level commands via a hosted NATS relay.\n\nSee prfaq.tex for authoritative product vision, phasing, and scope.\n\n## Architecture\n\npunt-labs runs the default hosted relay (NATS + JetStream). Teams connect by having a .biff file in their repo with the relay URL and member usernames. No accounts to create — pip install biff-mcp + clone = connected.\n\nTeams that want data sovereignty can self-host the same single-binary NATS server.\n\n## Data Source \u0026 Durability\n\n| Command | Durability | Source | Encryption |\n|---------|-----------|--------|------------|\n| /plan | Persistent | Relay | Team key (SecretBox) |\n| /who | Ephemeral | Relay | None (presence metadata) |\n| /finger | Both | Relay | Plan: team key. Online status: none |\n| /biff on/off | Ephemeral | Relay | None (session toggle) |\n| /mesg | Store-and-forward (POP) | Relay | Recipient's public key (Box) — true E2E |\n| /wall | Ephemeral | Relay | Team key (SecretBox) |\n| /hive | Ephemeral | Relay | Ephemeral hive key (SecretBox) |\n| /send | TBD | TBD | Design pending |\n| /cr | TBD | TBD | Design pending |\n| /talk | Ephemeral | Relay | Recipient's public key (Box) |\n| /pair | Ephemeral | Relay | Recipient's public key (Box) |\n\n## POP Mail Model\n\nThe relay follows POP semantics for /mesg: messages are stored on the relay only until the recipient reads them, then discarded. Biff is not a system of record. /wall is ephemeral broadcast — miss it if you're offline.\n\nNATS JetStream consumers with ack-and-delete implement this directly.\n\n## Encryption Design\n\n### Inspiration: ProtonMail\n\nEncryption is invisible to the user. The relay manages the public key directory. Clients encrypt/decrypt locally. The relay routes ciphertext. Like ProtonMail, the server is trusted for key distribution but untrusted for message content.\n\n### Primitives (PyNaCl / libsodium)\n\n- crypto_box (Box): 1:1 messages — Curve25519 + XSalsa20-Poly1305. True E2E.\n- crypto_secretbox (SecretBox): Group messages — XSalsa20-Poly1305 with symmetric key.\n- PyNaCl v1.6.2, Python 3.13+, actively maintained. Same crypto as Signal, WireGuard, age.\n\n### Identity \u0026 Root of Trust\n\nCommit access is the trust boundary:\n1. Your GitHub username is your identity\n2. You add your username to .biff in the repo (proves commit access)\n3. Relay reads .biff from GitHub to verify team membership\n4. Auth to relay via GitHub OAuth token\n\n### Keys\n\n- User keypair (Curve25519): per-user, per-repo. Private key in ~/.biff/keys/\u003crepo-hash\u003e.key. Public key in relay's key directory. Generated silently on first connection.\n- Team key (symmetric, 32 bytes): per-repo. Generated by relay, distributed to members encrypted with their public keys.\n- Hive key (symmetric, 32 bytes): per-hive, ephemeral. Same distribution model. Destroyed when hive dissolves.\n\n### User Experience (transparent)\n\npip install biff-mcp → clone repo with .biff → first biff serve generates keypair silently → public key registered with relay → team key received encrypted with your public key → user never sees any of this.\n\n### Encryption Per Command\n\n/mesg @kai \"text\" (true E2E, relay is blind):\n  Sender: Box(my_privkey, kai_pubkey).encrypt(message) → relay stores ciphertext\n  Kai: Box(kai_privkey, sender_pubkey).decrypt(ciphertext)\n\n/wall \"text\" (team key, ephemeral broadcast):\n  Sender: SecretBox(team_key).encrypt(message) → relay broadcasts ciphertext\n  Members: decrypt with cached team key\n\n/plan \"text\" (team key, persistent on relay):\n  Client: SecretBox(team_key).encrypt(plan) → relay stores ciphertext\n  /finger: relay returns encrypted plan → requester decrypts with team key\n\n/hive (ephemeral group key):\n  Relay generates hive key → distributes via each member's public key\n  All hive messages: SecretBox(hive_key).encrypt(message)\n\n### Key Lifecycle\n\nNew member: adds username to .biff, commits. First connection → keypair generated, public key registered. Relay encrypts team key with new member's public key → sends it.\n\nMember leaves: removed from .biff. Relay removes public key, rotates team key, re-distributes to remaining members.\n\nLost key: reconnect → new keypair, re-registered. Unread POP messages lost (acceptable). Team key re-sent with new public key.\n\n### Trust Boundaries\n\nTrue E2E (relay is blind): /mesg, /talk, /pair — encrypted with recipient's public key. Relay holds ciphertext it cannot decrypt.\n\nRelay-trusted (Proton model): /wall, /plan, /hive — relay generates the symmetric key, so it could theoretically read these. Same trust model as ProtonMail.\n\nFuture enhancement: client-side team key generation for zero-knowledge relay. More complex (requires someone online to welcome new members).\n\nPlaintext metadata: from, to, repo, timestamps — relay needs this for routing.\n\n## NATS Implementation\n\n### Why NATS + JetStream\n\n- Purpose-built for messaging. JetStream provides persistence and delivery guarantees.\n- KV store for presence (/who, /finger) with TTL, watch API. ~50 LOC.\n- JetStream consumers with ack-and-delete implement POP model directly.\n- nats-py v2.13.1 (Feb 2026), 145K weekly PyPI downloads, full asyncio.\n- Self-hosting: single Go binary (\u003c20MB). nats-server -js.\n- Managed hosting: Synadia Cloud (free personal, $49/mo starter).\n- Handles 100K msg/s on single node.\n\n### Hosting Model\n\npunt-labs runs the default NATS instance. Free tier with volume limits. Teams needing higher volume or data sovereignty self-host the same binary.\n\n## Open Design Questions\n\n1. Freemium model — volume limits, what's free vs. paid\n2. GitHub integration — how relay reads .biff (webhook vs. poll vs. on-connect fetch)\n3. /send and /cr — data source, persistence, and encryption model TBD\n4. Team key rotation schedule — on membership change only, or periodic?\n5. Key pinning / transparency — how to detect relay serving wrong public keys (TOFU vs. key transparency log)\n\n## Client Architecture\n\nNew module: biff.relay with:\n- RelayClient — wraps nats-py, handles connect/disconnect/send/subscribe\n- RelayMessageStore — POP model: pull unread, ack-and-delete\n- RelaySessionStore — presence via NATS KV store\n- RelayCrypto — wraps PyNaCl, manages keypairs and team key cache\n\nDual-mode: local (filesystem) or relay, selected by relay_url in .biff file.\n\n## Exit Criteria\n\nA distributed team can communicate end-to-end through biff across machines using the default hosted relay or their own self-hosted instance, with E2E encryption for 1:1 messages and Proton-model encryption for team messages.","status":"open","priority":2,"issue_type":"epic","owner":"jmf@pobox.com","created_at":"2026-02-13T15:25:26.267422-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T16:37:24.524171-08:00","labels":["epic","phase"],"dependencies":[{"issue_id":"biff-iok","depends_on_id":"biff-4rg","type":"blocks","created_at":"2026-02-13T16:23:56.052507-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-iok","depends_on_id":"biff-pdl","type":"blocks","created_at":"2026-02-14T16:38:54.364678-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-iok","depends_on_id":"biff-adp","type":"blocks","created_at":"2026-02-14T16:38:54.475323-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-iok","depends_on_id":"biff-lff","type":"blocks","created_at":"2026-02-14T16:38:54.58745-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-iok","depends_on_id":"biff-6re","type":"blocks","created_at":"2026-02-14T16:38:54.69716-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-jge","title":"Data models: Message, UserSession, BiffConfig","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:22:52.961011-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-13T23:43:12.476975-08:00","closed_at":"2026-02-13T23:43:12.476975-08:00","close_reason":"Frozen pydantic models: Message, UserSession, BiffConfig, UnreadSummary. 25 tests, all quality gates green."}
{"id":"biff-k0j","title":"NatsRelay implementation","description":"Implement NatsRelay class satisfying the existing Relay Protocol. NATS KV for sessions/presence, JetStream consumer with ack-and-delete for POP message semantics. Add nats-py dependency. Unit tests against local NATS server.\n\nPart of Phase 2 milestone 1: local NATS on single machine.","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T16:37:29.804198-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T17:45:29.481466-08:00","closed_at":"2026-02-14T17:45:29.481466-08:00","close_reason":"NatsRelay implemented with 28 tests, PR #16 open"}
{"id":"biff-k6u","title":"Status bar notification: write unread state for Claude Code status line","description":"Dynamic tool descriptions are model-visible only — the human user has no visual notification in Claude Code UI. The spike confirmed this UX gap.\n\nClaude Code's status bar is a configurable shell command (runs locally, can read files). Pattern: biff writes unread state to a well-known file (~/.biff/data/unread.json), and a status bar script reads it to display a live unread count.\n\nDeliverables:\n1. Biff writes unread summary to a local file whenever unread count changes\n2. Provide a sample status bar script users can configure in Claude Code settings\n3. Document setup in README\n\nDepends on the message watcher (biff-9xj) which detects unread count changes.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T05:31:05.816427-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T13:53:22.756922-08:00","closed_at":"2026-02-14T13:53:22.756922-08:00","close_reason":"PR #14 merged — unread.json status file, background poller, status bar script","dependencies":[{"issue_id":"biff-k6u","depends_on_id":"biff-9xj","type":"blocks","created_at":"2026-02-14T05:31:18.073418-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-lff","title":"E2E encryption","description":"PyNaCl keypairs (Curve25519), team key distribution. Box encryption for /mesg (true E2E — relay is blind). SecretBox for /plan and /wall (Proton model — relay-trusted). Key generation on first connect, storage in ~/.biff/keys/\u003crepo-hash\u003e.key. Public key registered with relay.\n\nFuture scope — relay works without encryption first.","status":"open","priority":3,"issue_type":"feature","owner":"jmf@pobox.com","created_at":"2026-02-14T16:37:39.61443-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T16:37:39.61443-08:00","dependencies":[{"issue_id":"biff-lff","depends_on_id":"biff-adp","type":"blocks","created_at":"2026-02-14T16:38:30.492067-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-m2f","title":"/plan command — set working status","description":"Slash command: /plan \u003cmessage\u003e\nMaps to MCP tool: mcp__biff__plan\nArguments: message (required) — what you're working on\nBehavior: Sets your .plan status visible to /who and /finger.\nUnix ancestor: .plan file","status":"open","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:03:36.912011-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T09:03:36.912011-08:00","dependencies":[{"issue_id":"biff-m2f","depends_on_id":"biff-eap","type":"blocks","created_at":"2026-02-15T09:04:14.097757-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-m2f","depends_on_id":"biff-9g7","type":"blocks","created_at":"2026-02-15T09:04:19.010401-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-mxn","title":"Integration test fixtures (conftest)","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T07:10:34.007203-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T07:11:52.35059-08:00","closed_at":"2026-02-14T07:11:52.35059-08:00","close_reason":"Closed","dependencies":[{"issue_id":"biff-mxn","depends_on_id":"biff-udi","type":"blocks","created_at":"2026-02-14T07:10:40.270436-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-nmt","title":"CLI entry point with transport flag","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:23:15.479711-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T08:13:00.848753-08:00","closed_at":"2026-02-14T08:13:00.848753-08:00","close_reason":"CLI entry point shipped in PR #5 (biff-x73): typer app with serve command, --transport stdio|http, --user, --data-dir, --host, --port","dependencies":[{"issue_id":"biff-nmt","depends_on_id":"biff-x73","type":"blocks","created_at":"2026-02-13T18:25:09.263904-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-ofy","title":"Presence tools: set_plan, who, finger, biff_toggle","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:23:04.126941-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T07:26:25.777671-08:00","closed_at":"2026-02-14T07:26:25.777671-08:00","close_reason":"All presence tools (finger, who, plan, biff toggle) implemented and tested via PR #5 and #6","dependencies":[{"issue_id":"biff-ofy","depends_on_id":"biff-hks","type":"blocks","created_at":"2026-02-13T18:24:50.809895-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-ofy","depends_on_id":"biff-x73","type":"blocks","created_at":"2026-02-13T18:24:53.336978-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-pdl","title":"Local NATS E2E tests","description":"Two MCP servers on same machine communicating through local NATS, proving identical behavior to LocalRelay subprocess tests. Cross-user presence, messaging, plan visibility, biff toggle — all through NATS KV and JetStream instead of filesystem.\n\nThis is the milestone 1 gate: single machine, two MCP servers, NATS relay.\n\nPart of Phase 2 milestone 1: local NATS on single machine.","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T16:37:34.193824-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T19:57:47.425306-08:00","closed_at":"2026-02-14T19:57:47.425306-08:00","close_reason":"PR #18 merged — 9 NATS E2E tests with two MCP servers","dependencies":[{"issue_id":"biff-pdl","depends_on_id":"biff-k0j","type":"blocks","created_at":"2026-02-14T16:38:25.833382-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-pdl","depends_on_id":"biff-59s","type":"blocks","created_at":"2026-02-14T16:38:25.944155-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-q26","title":"Workflow tests with transcript capture","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T07:10:34.241333-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T07:12:44.388839-08:00","closed_at":"2026-02-14T07:12:44.388839-08:00","close_reason":"Closed","dependencies":[{"issue_id":"biff-q26","depends_on_id":"biff-mxn","type":"blocks","created_at":"2026-02-14T07:10:40.490159-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-q26","depends_on_id":"biff-rlv","type":"blocks","created_at":"2026-02-14T07:10:40.597154-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-qo9","title":"/mesg command — send message and toggle availability","description":"Slash command: /mesg @user \u003cmessage\u003e  OR  /mesg on|off\nMaps to MCP tools: mcp__biff__send_message (messaging) and mcp__biff__biff (toggle)\nArguments: \n  - Messaging mode: to (required), message (required)\n  - Toggle mode: enabled (bool)\nBehavior: Send a purposeful async message, or toggle message reception.\nUnix ancestor: mesg / write\n\nDesign decision: Should this be one command with subcommands, or two separate commands (/mesg for sending, /biff for toggle)? The UNIX vocabulary uses mesg for both availability and as the conceptual ancestor of messaging.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:03:37.147679-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T09:04:00.272121-08:00","closed_at":"2026-02-15T09:04:00.272121-08:00","close_reason":"Splitting into /mesg and /biff per PR/FAQ vocabulary"}
{"id":"biff-qow","title":"/who command — list active sessions","description":"Slash command: /who\nMaps to MCP tool: mcp__biff__who\nArguments: none\nBehavior: Shows all active biff sessions with usernames and plan messages.\nUnix ancestor: who / w","status":"open","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-15T09:03:36.79299-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-15T09:03:36.79299-08:00","dependencies":[{"issue_id":"biff-qow","depends_on_id":"biff-eap","type":"blocks","created_at":"2026-02-15T09:04:13.983987-08:00","created_by":"\"jmf-pobox\""},{"issue_id":"biff-qow","depends_on_id":"biff-9g7","type":"blocks","created_at":"2026-02-15T09:04:18.894043-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-rlv","title":"MCP protocol integration tests","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T07:10:34.124524-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T07:12:19.881406-08:00","closed_at":"2026-02-14T07:12:19.881406-08:00","close_reason":"Closed","dependencies":[{"issue_id":"biff-rlv","depends_on_id":"biff-mxn","type":"blocks","created_at":"2026-02-14T07:10:40.380993-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-sm7","title":"Claude Code SDK acceptance tests: verify UI-level experience","description":"Use @anthropic-ai/claude-code-sdk to programmatically drive two Claude Code sessions with biff configured as MCP server. Verify: (1) cross-user visibility works through Claude's tool calls (plan, who, finger), (2) presence lifecycle end-to-end (biff on/off visible across sessions). Spike on SDK capabilities first.","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T08:17:38.410102-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T10:15:47.439272-08:00","closed_at":"2026-02-14T10:15:47.439272-08:00","close_reason":"Closed","dependencies":[{"issue_id":"biff-sm7","depends_on_id":"biff-al5","type":"blocks","created_at":"2026-02-14T08:17:44.868349-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-udi","title":"Transcript data model and renderer","status":"closed","priority":1,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T07:10:33.892921-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T07:11:32.169306-08:00","closed_at":"2026-02-14T07:11:32.169306-08:00","close_reason":"Closed"}
{"id":"biff-w5y","title":"Transcript file output and pytest marker","status":"closed","priority":2,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-14T07:10:34.355482-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T07:15:12.557435-08:00","closed_at":"2026-02-14T07:15:12.557435-08:00","close_reason":"Closed","dependencies":[{"issue_id":"biff-w5y","depends_on_id":"biff-q26","type":"blocks","created_at":"2026-02-14T07:10:40.703628-08:00","created_by":"\"jmf-pobox\""}]}
{"id":"biff-x73","title":"MCP server scaffold with HTTP/stdio transport","status":"closed","priority":0,"issue_type":"task","owner":"jmf@pobox.com","created_at":"2026-02-13T18:23:01.66618-08:00","created_by":"\"jmf-pobox\"","updated_at":"2026-02-14T06:36:30.52152-08:00","closed_at":"2026-02-14T06:36:30.52152-08:00","close_reason":"PR #5 merged — server scaffold complete","dependencies":[{"issue_id":"biff-x73","depends_on_id":"biff-jge","type":"blocks","created_at":"2026-02-13T18:24:48.320616-08:00","created_by":"\"jmf-pobox\""}]}
